"use strict";var g=require("obsidian"),{EditorView:bt,Decoration:V,ViewPlugin:it,WidgetType:lt}=require("@codemirror/view"),{RangeSetBuilder:gt}=require("@codemirror/state"),ft={targetFolders:["00 - Daily/"],enableTaskIds:!0,idPrefix:"t-",idLength:8,enableParentChildLinking:!0,preserveExistingParentLinks:!0,enableAutoSort:!1,sortDebounceMs:500,tasksWithoutTimePosition:"end",showInfoButton:!0,hideMetadataFields:!0,enableTaskNotes:!0,autoCreateTaskNotes:!0,taskNotesFolder:"Task Notes",enableEventNotes:!0,eventNotesFolder:"Event Notes",enableIcsSync:!0,enableAutoArchive:!0,enableScheduleTrigger:!0,enableTimeblockTrigger:!0,enableSlashCommandTrigger:!0,enableTaskStatusSync:!0,statusMappings:{" ":"incomplete",x:"complete",X:"complete","/":"in-progress","-":"cancelled",">":"scheduled"}},f={TASK_PATTERN:/^[\t]*- \[.\]/,PARENT_TASK_PATTERN:/^- \[.\]/,SUBTASK_PATTERN:/^\t+- \[.\]/,ID_PATTERN:/\[id::([^\]]+)\]/,PARENT_ID_PATTERN:/\[parent::([^\]]+)\]/,METADATA_PATTERN:/\s*\[(?:id|parent|uid)::[^\]]+\]/g,COMPLETED_PATTERN:/^[\t]*- \[[xX\->]\]/,TIMEBLOCK_PATTERN:/^- \[.\]\s*(\d{2}):(\d{2}) - (\d{2}):(\d{2})/,CALENDAR_EVENT_PATTERN:/^[\t]*- \[c\]/,extractId(s){let t=s.match(this.ID_PATTERN);return t?t[1].trim():null},extractParentId(s){let t=s.match(this.PARENT_ID_PATTERN);return t?t[1].trim():null},generateId(s){let t="abcdefghijklmnopqrstuvwxyz0123456789",e=s.idPrefix;for(let n=0;n<s.idLength;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e},addId(s,t){return this.extractId(s)?s:s.trimEnd()+` [id::${t}]`},addParentId(s,t){let e=this.extractParentId(s);return e?e!==t?s.replace(this.PARENT_ID_PATTERN,`[parent::${t}]`):s:s.trimEnd()+` [parent::${t}]`},removeParentId(s){return s.replace(/\s*\[parent::[^\]]+\]/,"")},isTask(s){return this.TASK_PATTERN.test(s)},isCalendarEvent(s){return this.CALENDAR_EVENT_PATTERN.test(s)},isParentTask(s){return this.PARENT_TASK_PATTERN.test(s)},isSubtask(s){return this.SUBTASK_PATTERN.test(s)},isCompleted(s){return this.COMPLETED_PATTERN.test(s)},getTaskSortKey(s){let t=s.match(this.TIMEBLOCK_PATTERN);if(t){let e=parseInt(t[1])*60+parseInt(t[2]),n=parseInt(t[3])*60+parseInt(t[4]);return{hasTime:!0,start:e,end:n}}return{hasTime:!1,start:1/0,end:1/0}},shouldProcessFile(s,t){return s.extension!=="md"?!1:t.targetFolders.some(e=>s.path.includes(e))},hasWikiLink(s){return/^[\t]*- \[.\].*\[\[/.test(s)},wrapTaskTextWithLink(s){if(!this.isTask(s)||this.hasWikiLink(s))return null;let t=s.match(/^([\t]*- \[.\]\s*(?:\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s+)?)(.*?)(\s*(?:#\w+|\[(?:id|parent|uid|calendar)::[^\]]+\]|\[[<>]\s*\d{4}-\d{2}-\d{2}\]).*)$/);if(t){let[,n,i,o]=t,l=i.trim();return l?`${n}[[${l}]]${o}`:null}let e=s.match(/^([\t]*- \[.\]\s*(?:\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s+)?)(.+)$/);if(e){let[,n,i]=e,o=i.trim();return o?`${n}[[${o}]]`:null}return null}},K={UID_PATTERN:/\[uid::([^\]]+)\]/,CALENDAR_PATTERN:/\[calendar::([^\]]+)\]/,extractUid(s){let t=s.match(this.UID_PATTERN);return t?t[1].trim():null},extractCalendar(s){let t=s.match(this.CALENDAR_PATTERN);return t?t[1].trim():null},parseEventLine(s){let t=s.match(/^- \[c\]\s*(\d{2}):(\d{2})\s*-\s*(\d{2}):(\d{2})\s+(.+?)(?:\s*\[uid::[^\]]+\])?\s*$/);return t?{startHour:parseInt(t[1]),startMinute:parseInt(t[2]),endHour:parseInt(t[3]),endMinute:parseInt(t[4]),text:t[5].trim(),uid:this.extractUid(s)}:null},formatTime(s,t){return`${s.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},buildEventLine(s,t){let e=s.time||"00:00",n=s.endTime||e,i=s.summary||"Untitled Event";s.location&&(i+=` ${s.location}`),s.callUrl&&(i+=` ${s.callUrl}`);let o=s.uid||`fallback-${s.utime}`,l=s.icsName||"",a=`- [c] ${e} - ${n} ${i} [uid::${o}]`;return l&&(a+=` [calendar::${l}]`),a},getDailyNoteDate(s,t){if(!f.shouldProcessFile(s,t))return null;let e=s.basename.match(/^(\d{4})-(\d{2})-(\d{2})$/);return e?new Date(parseInt(e[1]),parseInt(e[2])-1,parseInt(e[3])):null},async getIcsEvents(s,t){try{let e=s.plugins.getPlugin("ics");if(!e||!e.getEvents)return null;let n=window.moment;return n?await e.getEvents(n(t)):null}catch(e){return console.error("Task Manager: Error fetching ICS events",e),null}},async syncEventsToNote(s,t,e){let n=this.getDailyNoteDate(t,e);if(!n)return!1;let i=await this.getIcsEvents(s,n);if(!i||i.length===0)return!1;let o=await s.vault.read(t),l=o.split(`
`),a=[],r=[];for(let m of l)f.isCalendarEvent(m)?a.push(m):r.push(m);let c=new Map;for(let m of a){let T=this.extractUid(m);T&&c.set(T,m)}let u=[];for(let m of i){let T=this.buildEventLine(m,e);u.push({line:T,utime:m.utime||0})}u.sort((m,T)=>m.utime-T.utime);let h=[...u.map(m=>m.line),...r].join(`
`);return h!==o?(await s.vault.modify(t,h),!0):!1}},H={processContent(s,t){let e=s.split(`
`),n=[];for(let i=0;i<e.length;i++){let o=e[i];if(f.isCalendarEvent(o)){n.push(o);continue}f.isTask(o)&&(f.extractId(o)||(o=f.addId(o,f.generateId(t)))),n.push(o)}return n.join(`
`)}},at={linkContent(s,t){let e=s.split(`
`),n=[],i=null;for(let o=0;o<e.length;o++){let l=e[o],a=f.isParentTask(l),r=f.isSubtask(l);a?(i=f.extractId(l),f.extractParentId(l)&&(l=f.removeParentId(l)),n.push(l)):r?(!f.extractParentId(l)&&i&&(l=f.addParentId(l,i)),n.push(l)):(/^#/.test(l)&&(i=null),n.push(l))}return n.join(`
`)}},U={sortContent(s,t){let e=s.split(`
`),n=[],i=[],o=!1,l=[],a=[],r=[],c=!1;for(let p=0;p<e.length;p++){let k=e[p];if(/^##\s*Completed\s*$/i.test(k)){o=!0;continue}let S=f.isParentTask(k),b=f.isSubtask(k);if(o){if(S)i.push({id:f.extractId(k),parent:k,subtasks:[]});else if(b&&i.length>0){let v=f.extractParentId(k);if(v){let x=i.find(y=>y.id===v);x?x.subtasks.push(k):i[i.length-1].subtasks.push(k)}else i[i.length-1].subtasks.push(k)}else/^#/.test(k)&&(o=!1,r.push({line:k,index:p,isTaskArea:!1}));continue}S?(c||(c=!0),l.push({id:f.extractId(k),line:k,index:p})):b?a.push({parentId:f.extractParentId(k),line:k,index:p}):(c&&/^#/.test(k)&&(c=!1),r.push({line:k,index:p,isTaskArea:c}))}let u=[];for(let p of l){let k={parent:p.line,subtasks:[],sortKey:f.getTaskSortKey(p.line)};if(p.id)for(let b of a)b.parentId===p.id&&k.subtasks.push(b.line);let S=p.index;for(let b of a)if(!b.parentId){let v=!0;for(let y of l)if(y.index>S&&y.index<b.index){v=!1;break}let x=l.filter(y=>y.index<b.index).sort((y,C)=>C.index-y.index)[0];x&&x.index===S&&v&&(k.subtasks.includes(b.line)||k.subtasks.push(b.line))}u.push(k)}let d=u.filter(p=>!f.isCompleted(p.parent)),h=u.filter(p=>f.isCompleted(p.parent));d.sort((p,k)=>p.sortKey.hasTime&&!k.sortKey.hasTime?-1:!p.sortKey.hasTime&&k.sortKey.hasTime?1:p.sortKey.start!==k.sortKey.start?p.sortKey.start-k.sortKey.start:p.sortKey.end-k.sortKey.end),h.sort((p,k)=>p.sortKey.hasTime&&!k.sortKey.hasTime?-1:!p.sortKey.hasTime&&k.sortKey.hasTime?1:p.sortKey.start!==k.sortKey.start?p.sortKey.start-k.sortKey.start:p.sortKey.end-k.sortKey.end);let m=l.length>0?l[0].index:0,T=l.length>0?Math.max(...l.map(p=>p.index),...a.map(p=>p.index)):0;for(let p of r)p.index<m&&n.push(p.line);for(let p of d){n.push(p.parent);for(let k of p.subtasks)n.push(k)}for(let p of r)p.index>T&&n.push(p.line);let w=[...h,...i];if(w.length>0){for(;n.length>0&&n[n.length-1].trim()==="";)n.pop();n.push(""),n.push("## Completed"),w.sort((p,k)=>{let S=f.getTaskSortKey(p.parent),b=f.getTaskSortKey(k.parent);return S.hasTime&&!b.hasTime?-1:!S.hasTime&&b.hasTime?1:S.start!==b.start?S.start-b.start:S.end-b.end});for(let p of w){n.push(p.parent);for(let k of p.subtasks)n.push(k)}}return n.join(`
`)},sortByTimeBlock(s,t){let e=s.split(`
`),n=/^[\t]*- \[.\]\s*(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/,i=/^> \[!archived\]-?\s*Archived\s*$/,o=/^> /,l=[],a=[],r=[],c=0,u=!1;for(;c<e.length;){let h=e[c];if(i.test(h)){u=!0,r.push(h),c++;continue}if(u)if(o.test(h)||h.trim()===""){r.push(h),c++;continue}else u=!1;let m=f.isParentTask(h),T=f.isCalendarEvent(h);if(m||T){let w=h.match(n),p=[];if(m){let S=f.extractId(h),b=c+1;for(;b<e.length&&f.isSubtask(e[b]);){let v=f.extractParentId(e[b]);(!v||v===S)&&p.push(e[b]),b++}c=b}else c++;let k={line:h,subtasks:p,isEvent:T};w?(k.startMinutes=parseInt(w[1])*60+parseInt(w[2]),k.endMinutes=parseInt(w[3])*60+parseInt(w[4]),l.push(k)):a.push(k)}else f.isSubtask(h),c++}l.sort((h,m)=>h.startMinutes!==m.startMinutes?h.startMinutes-m.startMinutes:h.endMinutes-m.endMinutes);let d=[];for(let h of l){d.push(h.line);for(let m of h.subtasks)d.push(m)}a.length>0&&l.length>0&&d.push("");for(let h of a){d.push(h.line);for(let m of h.subtasks)d.push(m)}if(r.length>0){d.push("");for(let h of r)d.push(h)}return d.join(`
`)}},ot={ARCHIVE_STATES:/^[\t]*- \[[xX>\-]\]/,ACTIVE_STATES:/^[\t]*- \[[ \/c]\]/,ARCHIVE_CALLOUT_START:/^> \[!archived\]-?\s*Archived\s*$/,ARCHIVE_LINE:/^> /,archiveContent(s,t){let e=s.split(`
`),n=[],i=[],o=[],l=[],a=!1,r=0;for(;r<e.length;){let d=e[r];if(this.ARCHIVE_CALLOUT_START.test(d)){a=!0,r++;continue}if(a)if(this.ARCHIVE_LINE.test(d)){l.push(d.substring(2)),r++;continue}else a=!1;if(f.CALENDAR_EVENT_PATTERN.test(d)){n.push(d),r++;continue}if(this.ARCHIVE_STATES.test(d)){let h=[d];for(r++;r<e.length&&f.SUBTASK_PATTERN.test(e[r]);)h.push(e[r]),r++;o.push(...h);continue}if(this.ACTIVE_STATES.test(d)){let h=[d];for(r++;r<e.length&&f.SUBTASK_PATTERN.test(e[r]);)h.push(e[r]),r++;i.push(...h);continue}(d.trim()!==""||i.length>0)&&i.push(d),r++}let c=[...o,...l],u=[];for(let d of n)u.push(d);for(let d of i)u.push(d);if(c.length>0){if(u.length>0){for(;u.length>0&&u[u.length-1]==="";)u.pop();for(let d=0;d<7;d++)u.push("")}u.push("> [!archived]- Archived");for(let d of c)u.push("> "+d)}return u.join(`
`)}},N={cleanTaskText(s){return s=s.replace(/\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/g,""),s=s.replace(/üìÖ\s*\[\[[^\]]+\]\]/g,""),s=s.replace(/üìÖ\s*\d{4}-\d{2}-\d{2}/g,""),s=s.replace(/#\w+/g,""),s=s.replace(/üîó\[\[[^\]]+\]\]/g,""),s=s.replace(/\s*[><]\[\[\d{4}-\d{2}-\d{2}\]\]/g,""),s=s.replace(/\[\[([^\]|]+)\|?([^\]]*)\]\]/g,(t,e,n)=>n||e),s=s.replace(/[üìÖüóìÔ∏è‚è≥üõ´‚úÖ‚ùå‚ûïüî∫‚è´üîºüîΩ‚è¨üÜî‚õîüîÅ][^\s]*/g,""),s=s.replace(/üìù/g,""),s=s.replace(/üîó/g,""),s=s.replace(/\s*\[scheduled_(?:to|from)::\s*\[\[[^\]]*\]\]\]/g,""),s=s.replace(/\s*\[[^\]]+::[^\]]*\]/g,""),s=s.replace(/\s*\[[<>]\s*\d{4}-\d{2}-\d{2}\]/g,""),s=s.replace(/\s+/g," ").trim(),s},sanitizeFilename(s){return s.replace(/[\\/:*?"<>|#\[\]]/g,"-").replace(/-+/g,"-").replace(/\s+/g," ").trim().substring(0,100)},extractTaskTextFromLine(s){let t=s.match(/^(?:>\s*)?- \[.\]\s*(.+)$/);return t?this.cleanTaskText(t[1]):null},extractCheckboxMarker(s){let t=s.match(/^[\t]*- \[(.)\]/);return t?t[1]:null},checkboxToStatus(s,t){return t.statusMappings[s]||"incomplete"},statusToCheckbox(s,t){for(let[e,n]of Object.entries(t.statusMappings))if(n===s)return e;return" "},extractFrontmatterField(s,t){let e=s.match(/^---\n([\s\S]*?)\n---/);if(!e)return null;let i=e[1].match(new RegExp(`^${t}:\\s*"?([^"\\n]*)"?`,"m"));return i?i[1]:null},updateFrontmatterField(s,t,e){let n=s.match(/^(---\n)([\s\S]*?)(\n---)/);if(!n)return s;let[i,o,l,a]=n,r=new RegExp(`^(${t}:\\s*)"?[^"\\n]*"?`,"m"),c;return r.test(l)?c=l.replace(r,`$1"${e}"`):c=l+`
${t}: "${e}"`,s.replace(i,o+c+a)},updateTaskCheckbox(s,t,e){let n=s.split(`
`),i=new RegExp(`\\[id::\\s*${t}\\]`);for(let o=0;o<n.length;o++)if(i.test(n[o])){n[o]=n[o].replace(/^([\t]*- \[).(])/,`$1${e}$2`);break}return n.join(`
`)},async findTaskNoteByTaskId(s,t,e){let n=e.taskNotesFolder,i=s.vault.getFiles().filter(o=>o.path.startsWith(n+"/"));for(let o of i){let l=await s.vault.read(o);if(this.extractFrontmatterField(l,"taskId")===t)return o}return null},async syncStatusToSource(s,t,e){if(!e.enableTaskStatusSync)return;let n=await s.vault.read(t),i=this.extractFrontmatterField(n,"taskId"),o=this.extractFrontmatterField(n,"status"),l=this.extractFrontmatterField(n,"sourceFile");if(!i||!o||!l)return;let a=s.vault.getAbstractFileByPath(l);if(!a||!(a instanceof g.TFile))return;let r=this.statusToCheckbox(o,e),c=await s.vault.read(a),u=new RegExp(`\\[id::\\s*${i}\\]`),d=c.split(`
`);for(let m of d)if(u.test(m)){if(this.extractCheckboxMarker(m)===r)return;break}let h=this.updateTaskCheckbox(c,i,r);h!==c&&await s.vault.modify(a,h)},async syncStatusToTaskNote(s,t,e,n){if(!n.enableTaskStatusSync)return;let i=await this.findTaskNoteByTaskId(s,t,n);if(!i)return;let o=this.checkboxToStatus(e,n),l=await s.vault.read(i);if(this.extractFrontmatterField(l,"status")===o)return;let r=this.updateFrontmatterField(l,"status",o);r!==l&&await s.vault.modify(i,r)},async syncAllStatusesToTaskNotes(s,t,e){if(!e.enableTaskStatusSync)return;let i=(await s.vault.read(t)).split(`
`);for(let o of i){let l=f.extractId(o);if(!l||f.CALENDAR_EVENT_PATTERN.test(o))continue;let a=this.extractCheckboxMarker(o);a&&await this.syncStatusToTaskNote(s,l,a,e)}},async getSubtasksFromSource(s,t,e){if(!t)return[];let n=s.vault.getAbstractFileByPath(t);if(!n||!(n instanceof g.TFile))return[];let o=(await s.vault.read(n)).split(`
`),l=[],a=-1;for(let c=0;c<o.length;c++){let d=o[c].match(/^(\s*)- \[[ x]\]\s*(.+)$/);if(d&&this.cleanTaskText(d[2])===e){a=c;break}}if(a===-1)return[];let r=o[a].match(/^(\s*)/)[1].length;for(let c=a+1;c<o.length;c++){let u=o[c],d=u.match(/^(\s*)- \[([ x])\]\s*(.+)$/);if(!d){let m=u.match(/^(\s*)/);if(m&&m[1].length<=r&&u.trim()!=="")break;continue}if(d[1].length>r){let m=d[2]==="x",T=this.cleanTaskText(d[3]);T&&l.push({text:T,completed:m,originalLine:u})}else break}return l},async syncSubtasksToTaskNote(s,t,e,n){let i=await s.vault.read(t),o=i.match(/sourceFile:\s*"([^"]+)"/),l=o?o[1]:null,a=n&&l&&l!==n,r=i.match(/## Subtasks\n\n([\s\S]*?)(?=\n## |$)/);if(!r)return;let c=r[1],u=[],d=c.split(`
`);for(let w of d){let p=w.match(/^- \[([ x])\]\s*(.*)$/);p&&p[2].trim()&&u.push({text:p[2].trim(),completed:p[1]==="x"})}let h=[...u];for(let w of e)u.some(k=>k.text.toLowerCase()===w.text.toLowerCase())||h.push(w);let m=h.length>u.length,T=n&&(!l||a);if(m||T){let w=i;if(m){let p=h.map(k=>`- [${k.completed?"x":" "}] ${k.text}`).join(`
`);w=w.replace(/## Subtasks\n\n[\s\S]*?(?=\n## |$)/,`## Subtasks

${p}
`)}T&&(l?w=w.replace(/sourceFile:\s*"[^"]*"/,`sourceFile: "${n}"`):w=w.replace(/^---\n([\s\S]*?)---/,`---
$1sourceFile: "${n}"
---`)),await s.vault.modify(t,w),m&&new g.Notice(`Synced ${e.length} subtask(s) from source`)}},async syncSubtasksBackToSource(s,t,e){if(e)return!1;let n=await s.vault.read(t),i=n.match(/sourceFile:\s*"([^"]+)"/);if(!i||!i[1])return!1;let o=i[1],l=s.vault.getAbstractFileByPath(o);if(!l||!(l instanceof g.TFile))return!1;let a=n.match(/task:\s*"?([^"\n]+)"?/);if(!a)return!1;let r=a[1].replace(/\\"/g,'"'),c=n.match(/## Subtasks\n\n([\s\S]*?)(?=\n## |$)/);if(!c)return!1;let u=[],d=c[1].split(`
`);for(let y of d){let C=y.match(/^- \[([ x])\]\s*(.+)$/);C&&C[2].trim()&&u.push({text:C[2].trim(),completed:C[1]==="x"})}if(u.length===0)return!1;let h=await s.vault.read(l),m=h.split(`
`),T=-1,w=0;for(let y=0;y<m.length;y++){let E=m[y].match(/^(\s*)- \[[ x]\]\s*(.+)$/);if(E&&this.cleanTaskText(E[2])===r){T=y,w=E[1].length;break}}if(T===-1)return!1;let p=T;for(let y=T+1;y<m.length;y++){let C=m[y],E=C.match(/^(\s*)/),I=E?E[1].length:0;if(C.trim()!=="")if(I>w)p=y;else break}let k="	",S=u.map(y=>`${k}- [${y.completed?"x":" "}] ${y.text}`),b=m.slice(0,T+1),v=m.slice(p+1),x=[...b,...S,...v].join(`
`);return x!==h?(await s.vault.modify(l,x),!0):!1},extractFieldsFromLine(s){let t={},e=s.match(/\[parent::([^\]]+)\]/);e&&(t.parent=e[1].trim());let n=s.match(/\[<\s*(\d{4}-\d{2}-\d{2})\]/);n&&(t.scheduledFrom=n[1]);let i=s.match(/\[>\s*(\d{4}-\d{2}-\d{2})\]/);i&&(t.scheduledTo=i[1]);let o=[],l=/#(\w+)/g,a;for(;(a=l.exec(s))!==null;)o.push(a[1]);return o.length>0&&(t.tags=o),t},buildFrontmatter(s,t,e,n,i={}){let o=`---
task: "${s.replace(/"/g,'\\"')}"
taskId: "${t||""}"`;return o+=`
status: "${e}"`,o+=`
created: ${new Date().toISOString().split("T")[0]}`,o+=`
sourceFile: "${n||""}"`,i.parent&&(o+=`
parent: "${i.parent}"`),i.scheduledFrom&&(o+=`
scheduledFrom: ${i.scheduledFrom}`),i.scheduledTo&&(o+=`
scheduledTo: ${i.scheduledTo}`),i.tags&&i.tags.length>0&&(o+=`
tags:
${i.tags.map(l=>`  - ${l}`).join(`
`)}`),o+=`
---`,o},async ensureTaskNoteExists(s,t,e,n,i=null,o=null){let l=this.sanitizeFilename(e);if(!l)return null;let a=t.taskNotesFolder,r=`${a}/${l}.md`,c=null;if(i&&(c=await this.findTaskNoteByTaskId(s,i,t)),!c){let u=s.vault.getAbstractFileByPath(r);if(u instanceof g.TFile){let d=await s.vault.read(u),h=this.extractFrontmatterField(d,"taskId");if(!h||h===i||!i)c=u;else{let m=`${a}/${l} (${i}).md`,T=s.vault.getAbstractFileByPath(m);if(T instanceof g.TFile&&(c=T),!c)return await this._createTaskNote(s,t,e,i,n,m,o)}}}if(c instanceof g.TFile){let u=await this.getSubtasksFromSource(s,n,e);return await this.syncSubtasksToTaskNote(s,c,u,n),c}return await this._createTaskNote(s,t,e,i,n,r,o)},async _createTaskNote(s,t,e,n,i,o,l){let a=t.taskNotesFolder;s.vault.getAbstractFileByPath(a)||await s.vault.createFolder(a);let c=await this.getSubtasksFromSource(s,i,e),u=" ";if(i&&n){let b=s.vault.getAbstractFileByPath(i);if(b instanceof g.TFile){let v=await s.vault.read(b),x=new RegExp(`\\[id::\\s*${n}\\]`),y=v.split(`
`);for(let C of y)if(x.test(C)){let E=this.extractCheckboxMarker(C);E&&(u=E);break}}}let d=this.checkboxToStatus(u,t),h=c.length>0?c.map(b=>`- [${b.completed?"x":" "}] ${b.text}`).join(`
`):"- [ ] ",m=i?`[[${i.replace(/\.md$/,"")}]]`:"",T=l?this.extractFieldsFromLine(l):{},p=`${this.buildFrontmatter(e,n,d,i,T)}

# ${e}

**Source:** ${m}

---

## Status
\`BUTTON[btn-incomplete, btn-progress, btn-cancelled, btn-complete]\`

## Notes


## Subtasks

${h}

## References


---
> [!meta]- Button Definitions
> \`\`\`meta-bind-button
> label: "\u25CB Incomplete"
> style: primary
> id: btn-incomplete
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-incomplete
> \`\`\`
>
> \`\`\`meta-bind-button
> label: "\u25D0 In Progress"
> style: default
> id: btn-progress
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-in-progress
> \`\`\`
>
> \`\`\`meta-bind-button
> label: "\u2715 Cancelled"
> style: default
> id: btn-cancelled
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-cancelled
> \`\`\`
>
> \`\`\`meta-bind-button
> label: "\u2713 Complete"
> style: default
> id: btn-complete
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-complete
> \`\`\`
`,k=await s.vault.create(o,p),S=o.split("/").pop().replace(/\.md$/,"");return new g.Notice(`Created: ${S}`),k},async openOrCreateTaskNote(s,t,e,n,i=null){let o=await this.ensureTaskNoteExists(s,t,e,n,i);return o?(o instanceof g.TFile&&await s.workspace.getLeaf().openFile(o),o):(new g.Notice("Could not extract task name"),null)},async updateTaskNoteSourceFile(s,t,e,n,i){let o=this.sanitizeFilename(e);if(!o)return!1;let l=`${t.taskNotesFolder}/${o}.md`,a=s.vault.getAbstractFileByPath(l);if(!a||!(a instanceof g.TFile))return!1;let r=await s.vault.read(a),c=!1,u=/^(sourceFile:\s*")([^"]*)(")$/m,d=r.replace(u,`$1${n}$3`);d!==r&&(r=d,c=!0);let h=/^(scheduled:\s*)(\S+)$/m;if(h.test(r)){let p=r.replace(h,`$1${i}`);p!==r&&(r=p,c=!0)}else{let p=r.replace(/^(sourceFile:\s*"[^"]*")$/m,`$1
scheduled: ${i}`);p!==r?(r=p,c=!0):(r=r.replace(/^(---)$/m,`scheduled: ${i}
$1`),c=!0)}let m=`[[${n.replace(/\.md$/,"")}]]`,T=/^(\*\*Source:\*\*\s*)\[\[[^\]]+\]\]/m,w=r.replace(T,`$1${m}`);return w!==r&&(r=w,c=!0),c?(await s.vault.modify(a,r),!0):!1}},rt={sanitizeFilename(s){if(!s)return null;let t=s.replace(/^\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s*/,"");return t=t.replace(/https?:\/\/[^\s]+/g,""),t=t.replace(/[<>:"/\\|?*]/g,""),t=t.trim().substring(0,100),t||null},extractEventTitle(s){let t=s.replace(/^[\t]*- \[c\]\s*/,"");return t=t.replace(/^\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s*/,""),t=t.replace(/\s*\[uid::[^\]]+\]/g,""),t=t.replace(/\s*\[calendar::[^\]]+\]/g,""),t=t.replace(/\s*https?:\/\/[^\s]+/g,""),t.trim()},extractTimeRange(s){let t=s.match(/(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})/);return t?{start:t[1],end:t[2]}:null},async openOrCreateEventNote(s,t,e,n,i,o=null,l=null){var h;let a=this.sanitizeFilename(e);if(!a)return new g.Notice("Could not extract event name"),null;let r=t.eventNotesFolder,c=`${r}/${a}.md`;s.vault.getAbstractFileByPath(r)||await s.vault.createFolder(r);let d=s.vault.getAbstractFileByPath(c);if(!d){let m=i?`[[${i.replace(/\.md$/,"")}]]`:"",T=o?`${o.start} - ${o.end}`:"",w=i?(h=i.match(/(\d{4}-\d{2}-\d{2})/))==null?void 0:h[1]:new Date().toISOString().split("T")[0],p=`---
event: "${e.replace(/"/g,'\\"')}"
eventUID: "${n||""}"
calendar: "${l||""}"
date: ${w}
time: "${T}"
created: ${new Date().toISOString().split("T")[0]}
sourceFile: "${i||""}"
---

# ${e}

**Date:** ${w}${T?`  |  **Time:** ${T}`:""}
**Source:** ${m}

---

## Agenda


## Notes


## Action Items

- [ ]

## Follow-ups


`;d=await s.vault.create(c,p),new g.Notice(`Created: ${a}`)}return d instanceof g.TFile&&await s.workspace.getLeaf().openFile(d),d}},D={removeSchedulingTags(s){return s.replace(/\s*>\[\[\d{4}-\d{2}-\d{2}\]\]/g,"").replace(/\s*<\[\[\d{4}-\d{2}-\d{2}\]\]/g,"").replace(/\s*\[scheduled_from::\s*\[\[[^\]]*\]\]\]/g,"").replace(/\s*\[scheduled_to::\s*\[\[[^\]]*\]\]\]/g,"").replace(/\s*\[<\s*\d{4}-\d{2}-\d{2}\]/g,"").replace(/\s*\[>\s*\d{4}-\d{2}-\d{2}\]/g,"").replace(/\s*\[sch_from::[^\]]+\]/g,"").replace(/\s*\[sch_to::[^\]]+\]/g,"").replace(/\s*üìÖ\s*\[\[[^\]]+\]\]/g,"").replace(/\s*üìÖ\s*\d{4}-\d{2}-\d{2}/g,"")},getCurrentDate(){return new Date().toISOString().split("T")[0]},getDailyNotePath(s,t){return`${(t.targetFolders[0]||"00 - Daily/").replace(/\/$/,"")}/${s}.md`},createScheduledTaskCopy(s,t){let e=s.replace(/^([\t]*- \[)[^\]](\])/,"$1 $2");return e=this.removeSchedulingTags(e),e=e.replace(/\s*\[parent::\s*[^\]]+\]/g,""),e=e.trimEnd()+` <[[${t}]]`,e},markTaskAsScheduled(s,t){let e=s.replace(/^([\t]*- \[)[^\]](\])/,"$1>$2");return e=e.replace(/^([\t]*- \[.\]\s*)\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/,"$1"),e=this.removeSchedulingTags(e),e=e.trimEnd()+` >[[${t}]]`,e},extractScheduledToDate(s){let t=s.match(/>\[\[(\d{4}-\d{2}-\d{2})\]\]/);return t||(t=s.match(/\[scheduled_to::\s*\[\[(\d{4}-\d{2}-\d{2})\]\]\]/),t)?t[1]:(t=s.match(/\[>\s*(\d{4}-\d{2}-\d{2})\]/),t?t[1]:null)},isScheduledAway(s){return/^[\t]*- \[>\]/.test(s)},resetScheduledTask(s){let t=s.replace(/^([\t]*- \[)>(\])/,"$1 $2");return t=this.removeSchedulingTags(t),t},async scheduleTask(s,t,e,n,i){let o=e.getLine(n);if(!f.isTask(o))return new g.Notice("Not a task line"),!1;if(o.includes(`>[[${i}]]`)||o.includes(`[scheduled_to:: [[${i}]]]`)||o.includes(`[> ${i}]`))return new g.Notice("Task already scheduled to this date"),!1;let l=s.workspace.getActiveFile(),a=l?l.basename:this.getCurrentDate(),r=this.getDailyNotePath(i,t),c=s.vault.getAbstractFileByPath(r);if(!c){let p=r.substring(0,r.lastIndexOf("/"));s.vault.getAbstractFileByPath(p)||await s.vault.createFolder(p),c=await s.vault.create(r,""),new g.Notice(`Created daily note: ${i}`)}if(!(c instanceof g.TFile))return new g.Notice("Target is not a file"),!1;let u=f.extractId(o),d=await s.vault.read(c),h=!1;if(u&&(h=new RegExp(`\\[id::\\s*${u}\\]`).test(d)),h){let p=d.split(`
`),k=new RegExp(`\\[id::\\s*${u}\\]`);for(let S=0;S<p.length;S++)if(k.test(p[S])){let b=p[S];b=b.replace(/^([\t]*- \[)[^\]](\])/,"$1 $2"),b=this.removeSchedulingTags(b),b=b.trimEnd()+` <[[${a}]]`,p[S]=b;break}d=p.join(`
`)}else{let p=this.createScheduledTaskCopy(o,a);d=d.trimEnd()+`
`+p}await s.vault.modify(c,d);let m=this.markTaskAsScheduled(o,i);e.setLine(n,m);let T=e.lineCount();for(let p=n+1;p<T;p++){let k=e.getLine(p);if(f.isSubtask(k)){let S=k.replace(/^([\t]*- \[)[^\]](\])/,"$1>$2");S!==k&&e.setLine(p,S)}else break}let w=N.extractTaskTextFromLine(o);return w&&await N.updateTaskNoteSourceFile(s,t,w,r,i),new g.Notice(`Task scheduled to ${i}`),!0},async unscheduleTask(s,t,e,n){let i=e.getLine(n);if(!f.isTask(i))return new g.Notice("Not a task line"),!1;let o=this.extractScheduledToDate(i),l=this.isScheduledAway(i);if(!o&&!l)return new g.Notice("Task is not scheduled"),!1;let a=f.extractId(i),r=s.workspace.getActiveFile(),c=r?r.path:null,u=r?r.basename:this.getCurrentDate(),d=this.resetScheduledTask(i);e.setLine(n,d);let h=e.lineCount();for(let T=n+1;T<h;T++){let w=e.getLine(T);if(f.isSubtask(w)){let p=w.replace(/^([\t]*- \[)>(\])/,"$1 $2");p!==w&&e.setLine(T,p)}else break}if(o&&a){let T=this.getDailyNotePath(o,t),w=s.vault.getAbstractFileByPath(T);if(w&&w instanceof g.TFile){let p=await s.vault.read(w),k=p.split(`
`),S=new RegExp(`\\[id::\\s*${a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\]`),b=-1;for(let v=0;v<k.length;v++)if(S.test(k[v])){b=v;break}if(b!==-1){let v=1;for(let x=b+1;x<k.length&&f.isSubtask(k[x]);x++)v++;k.splice(b,v),p=k.join(`
`).replace(/\n{3,}/g,`

`).trimEnd(),await s.vault.modify(w,p)}}}let m=N.extractTaskTextFromLine(i);return m&&c&&await this.updateTaskNoteForUnschedule(s,t,m,c,u),new g.Notice("Task unscheduled"),!0},async updateTaskNoteForUnschedule(s,t,e,n,i){let o=N.sanitizeFilename(e);if(!o)return!1;let l=`${t.taskNotesFolder}/${o}.md`,a=s.vault.getAbstractFileByPath(l);if(!a||!(a instanceof g.TFile))return!1;let r=await s.vault.read(a),c=!1,u=/^(sourceFile:\s*")([^"]*)(")$/m,d=r.replace(u,`$1${n}$3`);d!==r&&(r=d,c=!0);let h=/^(scheduled:\s*)(\S+)$/m;if(h.test(r)){let p=r.replace(h,`$1${i}`);p!==r&&(r=p,c=!0)}let m=`[[${n.replace(/\.md$/,"")}]]`,T=/^(\*\*Source:\*\*\s*)\[\[[^\]]+\]\]/m,w=r.replace(T,`$1${m}`);return w!==r&&(r=w,c=!0),c?(await s.vault.modify(a,r),!0):!1}},z={INCOMPLETE_TASK_PATTERN:/^[\t]*- \[ \]/,isIncompleteTask(s){return this.INCOMPLETE_TASK_PATTERN.test(s)},parseDateFromFilename(s){let t=s.match(/^(\d{4})-(\d{2})-(\d{2})$/);return t?new Date(parseInt(t[1]),parseInt(t[2])-1,parseInt(t[3])):null},async getDailyNoteFiles(s,t){let e=[],n=t.targetFolders||["00 - Daily/"];for(let i of n){let o=i.replace(/\/$/,"");if(!s.vault.getAbstractFileByPath(o))continue;let a=s.vault.getMarkdownFiles();for(let r of a)if(r.path.startsWith(o+"/")&&r.path.endsWith(".md")){let c=this.parseDateFromFilename(r.basename);c&&e.push({file:r,date:c,basename:r.basename})}}return e},async findOverdueTasks(s,t,e){let n=await this.getDailyNoteFiles(s,t),i=[],o=e.getTime();for(let{file:l,date:a,basename:r}of n){if(a.getTime()>=o)continue;let u=(await s.vault.read(l)).split(`
`);for(let d=0;d<u.length;d++){let h=u[d];this.isIncompleteTask(h)&&!f.isCalendarEvent(h)&&i.push({file:l,fileDate:r,line:h,lineNum:d,taskId:f.extractId(h)})}}return i},async scheduleAllOverdueTo(s,t,e){let n=e.toISOString().split("T")[0],i=await this.findOverdueTasks(s,t,e);if(i.length===0)return new g.Notice("No overdue tasks found"),0;let o=0,l=new Map;for(let u of i)l.has(u.file.path)||l.set(u.file.path,[]),l.get(u.file.path).push(u);let a=D.getDailyNotePath(n,t),r=s.vault.getAbstractFileByPath(a);if(!r){let u=a.substring(0,a.lastIndexOf("/"));s.vault.getAbstractFileByPath(u)||await s.vault.createFolder(u),r=await s.vault.create(a,"")}if(!(r instanceof g.TFile))return new g.Notice("Could not access target daily note"),0;let c=await s.vault.read(r);for(let[u,d]of l){let h=s.vault.getAbstractFileByPath(u);if(!h||!(h instanceof g.TFile))continue;let m=await s.vault.read(h),T=m.split(`
`),w=h.basename,p=d.sort((k,S)=>S.lineNum-k.lineNum);for(let k of p){let S=T[k.lineNum];if(!S||!this.isIncompleteTask(S))continue;let b=f.extractId(S),v=!1;if(b&&(v=new RegExp(`\\[id::\\s*${b}\\]`).test(c)),v){let y=new RegExp(`\\[id::\\s*${b}\\]`),C=c.split(`
`);for(let E=0;E<C.length;E++)if(y.test(C[E])){let I=C[E];I=I.replace(/^([\t]*- \[)[^\]](\])/,"$1 $2"),I=D.removeSchedulingTags(I),I=I.trimEnd()+` <[[${w}]]`,C[E]=I;break}c=C.join(`
`)}else{let y=D.createScheduledTaskCopy(S,w);c=c.trimEnd()+`
`+y}T[k.lineNum]=D.markTaskAsScheduled(S,n),o++;let x=N.extractTaskTextFromLine(S);x&&await N.updateTaskNoteSourceFile(s,t,x,a,n)}m=T.join(`
`),await s.vault.modify(h,m)}return await s.vault.modify(r,c),new g.Notice(`Scheduled ${o} overdue task(s) to ${n}`),o}},R={formatDate(s){return s.toISOString().split("T")[0]},getTomorrow(){let s=new Date;return s.setDate(s.getDate()+1),this.formatDate(s)},getDayAfterTomorrow(){let s=new Date;return s.setDate(s.getDate()+2),this.formatDate(s)},getNextMonday(){let s=new Date,t=s.getDay(),e=t===0?1:t===1?7:8-t;return s.setDate(s.getDate()+e),this.formatDate(s)},getOneWeekFromNow(){let s=new Date;return s.setDate(s.getDate()+7),this.formatDate(s)},parseCustomDate(s,t){if(!s)return null;let e=s.trim();if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;if(/^\d{8}$/.test(e))return`${e.slice(0,4)}-${e.slice(4,6)}-${e.slice(6,8)}`;if(t){let n=this.parseNaturalDate(e,t);if(n)return n}return null},parseNaturalDate(s,t){if(!s||!t)return null;try{let e=t.plugins.getPlugin("nldates-obsidian");if(!e)return null;let n=e.parse(s,"YYYY-MM-DD");if(n&&n.formattedString&&n.formattedString!=="Invalid date"&&/^\d{4}-\d{2}-\d{2}$/.test(n.formattedString))return n.formattedString}catch(e){console.debug("Task Manager: nldates parsing failed for:",s,e)}return null}},W=[{id:"tomorrow",label:"Tomorrow",getDate:()=>R.getTomorrow()},{id:"day-after",label:"Day After Tomorrow",getDate:()=>R.getDayAfterTomorrow()},{id:"next-monday",label:"Next Monday",getDate:()=>R.getNextMonday()},{id:"one-week",label:"In One Week",getDate:()=>R.getOneWeekFromNow()},{id:"custom",label:"Enter a date...",isCustom:!0}],$={check:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>',halfCircle:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M448 256c0-106-86-192-192-192V448c106 0 192-86 192-192zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z"/></svg>',ban:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M367.2 412.5L99.5 144.8C77.1 176.1 64 214.5 64 256c0 106 86 192 192 192c41.5 0 79.9-13.1 111.2-35.5zm45.3-45.3C434.9 335.9 448 297.5 448 256c0-106-86-192-192-192c-41.5 0-79.9 13.1-111.2 35.5L412.5 367.2zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z"/></svg>',anglesRight:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M470.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 256 265.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160zm-352 160l160-160c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L210.7 256 73.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0z"/></svg>',fileLines:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM112 256H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16z"/></svg>',clock:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M464 256A208 208 0 1 1 48 256a208 208 0 1 1 416 0zM0 256a256 256 0 1 0 512 0A256 256 0 1 0 0 256zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/></svg>',circleRight:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M0 256a256 256 0 1 0 512 0A256 256 0 1 0 0 256zM294.6 135.1l99.9 107.1c3.5 3.8 5.5 8.7 5.5 13.8s-2 10.1-5.5 13.8L294.6 376.9c-4.2 4.5-10.1 7.1-16.3 7.1C266 384 256 374 256 361.7l0-57.7-96 0c-17.7 0-32-14.3-32-32l0-32c0-17.7 14.3-32 32-32l96 0 0-57.7c0-12.3 10-22.3 22.3-22.3c6.2 0 12.1 2.6 16.3 7.1z"/></svg>'},M={extractTimeblock(s){let t=s.match(/^([\t]*- \[.\]\s*)(\d{2}):(\d{2})\s*-\s*(\d{2}):(\d{2})\s*/);return t?{prefix:t[1],startHour:parseInt(t[2]),startMinute:parseInt(t[3]),endHour:parseInt(t[4]),endMinute:parseInt(t[5]),fullMatch:t[0]}:null},formatTime(s,t){return`${s.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},formatDisplayTime(s){let t=e=>e.toString().padStart(2,"0");return s===0?"12 AM":s===12?"12 PM":s<12?`${t(s)} AM`:`${t(s-12)} PM`},addTimeblock(s,t,e,n,i){let o=this.extractTimeblock(s),l=`${this.formatTime(t,e)} - ${this.formatTime(n,i)} `;return o?s.replace(o.fullMatch,o.prefix+l):s.replace(/^([\t]*- \[.\]\s*)/,`$1${l}`)},removeTimeblock(s){return s.replace(/^([\t]*- \[.\]\s*)\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s*/,"$1")},getDefaultEndTime(s,t){let e=t+30,n=s;return e>=60&&(e-=60,n=(n+1)%24),{hour:n,minute:e}}},L=class s{constructor(t,e,n,i,o=null,l=null){this.plugin=t,this.editor=e,this.lineNum=n,this.mode=i,this.existingStart=o,this.onComplete=l,this.selectedHour=null,this.expandedHour=null,this.container=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleClickOutside=this.handleClickOutside.bind(this)}open(){this.container=document.createElement("div"),this.container.className="timeblock-picker-popup",this.render(),this.positionPopup(),document.body.appendChild(this.container),document.addEventListener("keydown",this.handleKeyDown,!0),setTimeout(()=>{document.addEventListener("click",this.handleClickOutside)},10)}close(){this.container&&(this.container.remove(),this.container=null),document.removeEventListener("keydown",this.handleKeyDown,!0),document.removeEventListener("click",this.handleClickOutside)}render(){this.container.empty();let t=document.createElement("div");if(t.className="timeblock-picker-header",t.textContent=this.mode==="start"?"Start":"End",this.container.appendChild(t),this.mode==="end"&&this.existingStart){let o=document.createElement("div");o.className="timeblock-picker-start-info",o.textContent=`Start: ${M.formatTime(this.existingStart.hour,this.existingStart.minute)}`,this.container.appendChild(o)}let e=document.createElement("div");e.className="timeblock-picker-columns";let n=this.createColumn("DAY",6,17);e.appendChild(n);let i=this.createColumn("NIGHT",18,29);e.appendChild(i),this.container.appendChild(e)}createColumn(t,e,n){let i=document.createElement("div");i.className="timeblock-picker-column";let o=document.createElement("div");o.className="timeblock-picker-column-header",o.textContent=t,i.appendChild(o);for(let l=e;l<=n;l++){let a=l%24,r=this.createHourRow(a);i.appendChild(r)}return i}createHourRow(t){let e=document.createElement("div");e.className="timeblock-picker-row",this.expandedHour===t&&e.addClass("is-expanded");let i=null;if(this.mode==="end"&&this.existingStart){let a=M.getDefaultEndTime(this.existingStart.hour,this.existingStart.minute);t===a.hour&&(e.addClass("is-suggested"),i=a.minute)}let o=document.createElement("div");o.className="timeblock-picker-hour",o.textContent=M.formatDisplayTime(t),o.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.handleHourClick(t)}),e.appendChild(o);let l=document.createElement("div");l.className="timeblock-picker-row-minutes";for(let a of[0,15,30,45]){let r=document.createElement("button");r.className="timeblock-picker-minute-btn",i===a&&r.addClass("is-suggested"),r.textContent=a.toString().padStart(2,"0"),r.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),this.selectTime(t,a)}),l.appendChild(r)}return e.appendChild(l),e}handleHourClick(t){if(this.expandedHour===t){this.selectTime(t,0);return}this.expandedHour=t,this.render()}selectTime(t,e){this.selectedHour=t,this.close(),this.mode==="start"?new s(this.plugin,this.editor,this.lineNum,"end",{hour:t,minute:e},(i,o)=>{this.applyTimeblock(t,e,i,o)}).open():this.mode==="end"&&this.onComplete&&this.onComplete(t,e)}applyTimeblock(t,e,n,i){let o=this.editor.getLine(this.lineNum),l=M.addTimeblock(o,t,e,n,i);this.editor.setLine(this.lineNum,l),new g.Notice(`Timeblock set: ${M.formatTime(t,e)} - ${M.formatTime(n,i)}`)}positionPopup(){let t=this.plugin.app.workspace.getActiveViewOfType(g.MarkdownView);if(!t)return;let e=t.editor.cm;if(!e)return;let n=this.editor.getCursor(),i=e.coordsAtPos(e.state.doc.line(n.line+1).from);i&&(this.container.style.position="absolute",this.container.style.left=`${i.left}px`,this.container.style.top=`${i.bottom+5}px`,this.container.style.zIndex="1000")}handleKeyDown(t){t.key==="Escape"&&(t.preventDefault(),t.stopPropagation(),this.close())}handleClickOutside(t){this.container&&!this.container.contains(t.target)&&this.close()}},mt=[{id:"set-time",label:"Set Time Block...",icon:$.clock}],Y=class extends g.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,n){if(!this.plugin.settings.enableTimeblockTrigger)return null;let i=e.getLine(t.line);if(!f.isTask(i))return null;let o=i.substring(0,t.ch),l=o.lastIndexOf("^");if(l===-1||l===0||o.substring(0,l).endsWith("^"))return null;let r=o.substring(l+1);return r.includes(" ")?null:{start:{line:t.line,ch:l},end:t,query:r}}getSuggestions(t){let e=t.query;return mt.filter(n=>n.label.toLowerCase().includes(e.toLowerCase()))}renderSuggestion(t,e){e.addClass("slash-command-item");let n=e.createSpan({cls:"slash-command-icon"});n.innerHTML=t.icon,e.createSpan({text:t.label,cls:"slash-command-label"})}selectSuggestion(t,e){let{editor:n}=this.context,i=this.context.start.line;n.replaceRange("",this.context.start,this.context.end),t.id==="set-time"&&new L(this.plugin,n,i,"start").open()}},kt=[{id:"complete",label:"Mark Complete",icon:$.check,marker:"x"},{id:"in-progress",label:"Mark In Progress",icon:$.halfCircle,marker:"/"},{id:"cancelled",label:"Mark Cancelled",icon:$.ban,marker:"-"},{id:"schedule",label:"Schedule Task",icon:$.anglesRight,action:"schedule"},{id:"timeblock",label:"Set Time Block",icon:$.clock,action:"timeblock"}],j=class extends g.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,n){if(!this.plugin.settings.enableSlashCommandTrigger)return null;let i=e.getLine(t.line);if(!f.isTask(i))return null;let o=i.substring(0,t.ch),l=o.lastIndexOf("/");if(l===-1)return null;let a=o.substring(0,l);if(/\d$/.test(a))return null;let r=o.substring(l+1);return r.includes(" ")?null:{start:{line:t.line,ch:l},end:t,query:r.toLowerCase()}}getSuggestions(t){let e=t.query.toLowerCase();return kt.filter(n=>n.label.toLowerCase().includes(e)||n.id.includes(e))}renderSuggestion(t,e){e.addClass("slash-command-item");let n=e.createSpan({cls:"slash-command-icon"});n.innerHTML=t.icon,e.createSpan({text:t.label,cls:"slash-command-label"})}selectSuggestion(t,e){let{editor:n}=this.context,i=this.context.start.line,o=n.getLine(i);n.replaceRange("",this.context.start,this.context.end);let l=n.getLine(i);if(t.marker){let a=l.replace(/^([\t]*- \[)[^\]](\])/,`$1${t.marker}$2`);n.setLine(i,a)}else t.action==="schedule"?this.openSchedulePopup(n,i):t.action==="timeblock"&&this.openTimeBlockPopup(n,i)}openSchedulePopup(t,e){new _(this.plugin,t,e).open()}openTimeBlockPopup(t,e){new L(this.plugin,t,e,"start").open()}},ct=[{id:"tomorrow",label:"Schedule to Tomorrow",icon:$.anglesRight},{id:"pick-date",label:"Pick a Date...",icon:$.anglesRight}],q=class extends g.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,n){if(!this.plugin.settings.enableScheduleTrigger)return null;let i=e.getLine(t.line);if(!f.isTask(i))return null;let o=i.substring(0,t.ch),l=o.lastIndexOf(">");if(l===-1||l===0)return null;let a=o.substring(0,l);if(a.endsWith(">")||a.endsWith("["))return null;let r=o.substring(l+1);return{start:{line:t.line,ch:l},end:t,query:r}}getSuggestions(t){let e=t.query;if(!e)return ct;let n=R.parseCustomDate(e,this.plugin.app);if(n)return[{id:"direct-date",label:`Schedule to ${n}`,icon:$.anglesRight,date:n}];if(/^\d+[-]?\d*[-]?\d*$/.test(e)&&e.length<10)return[{id:"typing-date",label:"Type date: YYYY-MM-DD or YYYYMMDD",icon:$.anglesRight,disabled:!0}];let i=ct.filter(o=>o.label.toLowerCase().includes(e.toLowerCase()));return i.length===0&&e.length>0?[{id:"no-match",label:`No date match for "${e}"`,icon:$.anglesRight,disabled:!0}]:i}renderSuggestion(t,e){e.addClass("slash-command-item");let n=e.createSpan({cls:"slash-command-icon"});n.innerHTML=t.icon,e.createSpan({text:t.label,cls:"slash-command-label"}),t.disabled&&e.addClass("is-disabled")}selectSuggestion(t,e){if(t.disabled)return;let{editor:n}=this.context,i=this.context.start.line;if(n.replaceRange("",this.context.start,this.context.end),t.id==="direct-date")D.scheduleTask(this.plugin.app,this.plugin.settings,n,i,t.date);else if(t.id==="tomorrow"){let o=new Date;o.setDate(o.getDate()+1);let l=o.toISOString().split("T")[0];D.scheduleTask(this.plugin.app,this.plugin.settings,n,i,l)}else t.id==="pick-date"&&new _(this.plugin,n,i).open()}},_=class{constructor(t,e,n){this.plugin=t,this.editor=e,this.lineNum=n,this.selectedIndex=0,this.isCustomMode=!1,this.container=null,this.customInput=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleClickOutside=this.handleClickOutside.bind(this)}open(){this.container=document.createElement("div"),this.container.className="schedule-date-popup",this.renderOptions(),this.positionPopup(),document.body.appendChild(this.container),document.addEventListener("keydown",this.handleKeyDown,!0),setTimeout(()=>{document.addEventListener("click",this.handleClickOutside)},10)}close(){this.container&&(this.container.remove(),this.container=null),document.removeEventListener("keydown",this.handleKeyDown,!0),document.removeEventListener("click",this.handleClickOutside)}renderOptions(){this.container.empty(),W.forEach((t,e)=>{let n=document.createElement("div");n.className="schedule-date-option",e===this.selectedIndex&&n.addClass("is-selected"),t.isCustom&&this.isCustomMode?(this.customInput=document.createElement("input"),this.customInput.type="text",this.customInput.className="schedule-date-custom-input",this.customInput.placeholder="YYYY-MM-DD",this.customInput.addEventListener("keydown",i=>{i.key==="Enter"?(i.preventDefault(),i.stopPropagation(),this.submitCustomDate()):i.key==="Escape"&&(i.preventDefault(),i.stopPropagation(),this.close())}),n.appendChild(this.customInput),setTimeout(()=>this.customInput.focus(),0)):(n.createSpan({text:t.label,cls:"schedule-date-label"}),t.getDate&&n.createSpan({text:t.getDate(),cls:"schedule-date-value"})),n.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.selectedIndex=e,this.selectOption(t)}),this.container.appendChild(n)})}positionPopup(){let t=this.plugin.app.workspace.getActiveViewOfType(g.MarkdownView);if(!t)return;let e=t.editor.cm;if(!e)return;let n=this.editor.getCursor(),i=e.coordsAtPos(e.state.doc.line(n.line+1).from);i&&(this.container.style.position="absolute",this.container.style.left=`${i.left}px`,this.container.style.top=`${i.bottom+5}px`,this.container.style.zIndex="1000")}handleKeyDown(t){if(this.isCustomMode&&this.customInput&&document.activeElement===this.customInput){t.key==="Escape"&&(t.preventDefault(),t.stopPropagation(),this.close());return}switch(t.key){case"ArrowDown":t.preventDefault(),t.stopPropagation(),this.selectedIndex=Math.min(this.selectedIndex+1,W.length-1),this.renderOptions();break;case"ArrowUp":t.preventDefault(),t.stopPropagation(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.renderOptions();break;case"Enter":t.preventDefault(),t.stopPropagation(),this.selectOption(W[this.selectedIndex]);break;case"Escape":t.preventDefault(),t.stopPropagation(),this.close();break}}handleClickOutside(t){this.container&&!this.container.contains(t.target)&&this.close()}selectOption(t){t.isCustom?this.isCustomMode||(this.isCustomMode=!0,this.renderOptions()):t.getDate&&this.scheduleToDate(t.getDate())}submitCustomDate(){if(!this.customInput)return;let t=R.parseCustomDate(this.customInput.value,this.plugin.app);t?this.scheduleToDate(t):new g.Notice('Invalid date. Try YYYY-MM-DD, YYYYMMDD, or natural language (e.g. "tomorrow", "next monday")')}async scheduleToDate(t){this.close(),await D.scheduleTask(this.plugin.app,this.plugin.settings,this.editor,this.lineNum,t)}},G=class extends _{constructor(t,e,n,i){super(t,e,n),this.anchorEl=i}positionPopup(){if(!this.anchorEl)return;let t=this.anchorEl.getBoundingClientRect();this.container.style.position="absolute",this.container.style.left=`${t.left}px`,this.container.style.top=`${t.bottom+5}px`,this.container.style.zIndex="1000",requestAnimationFrame(()=>{let e=this.container.getBoundingClientRect();e.right>window.innerWidth&&(this.container.style.left=`${window.innerWidth-e.width-10}px`),e.bottom>window.innerHeight&&(this.container.style.top=`${t.top-e.height-5}px`)})}},J=class s extends L{constructor(t,e,n,i,o,l,a){super(t,e,n,i,o,l),this.anchorEl=a}positionPopup(){if(!this.anchorEl)return;let t=this.anchorEl.getBoundingClientRect();this.container.style.position="absolute",this.container.style.left=`${t.left}px`,this.container.style.top=`${t.bottom+5}px`,this.container.style.zIndex="1000",requestAnimationFrame(()=>{let e=this.container.getBoundingClientRect();e.right>window.innerWidth&&(this.container.style.left=`${window.innerWidth-e.width-10}px`),e.bottom>window.innerHeight&&(this.container.style.top=`${t.top-e.height-5}px`)})}selectTime(t,e){this.selectedHour=t,this.close(),this.mode==="start"?new s(this.plugin,this.editor,this.lineNum,"end",{hour:t,minute:e},(i,o)=>{this.applyTimeblock(t,e,i,o)},this.anchorEl).open():this.mode==="end"&&this.onComplete&&this.onComplete(t,e)}},X=class extends lt{constructor(t,e){super(),this.options=t,this.plugin=e}toDOM(){let t=document.createElement("span");return t.className="task-gutter-more",t.textContent="more",t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.plugin.showTaskInfo(this.options.taskId,this.options.parentId,this.options.taskText,null,null,this.options.uid,this.options.isCalendarEvent,this.options.calendarSource)}),t}eq(t){return t.options.taskId===this.options.taskId&&t.options.parentId===this.options.parentId&&t.options.uid===this.options.uid&&t.options.taskText===this.options.taskText}ignoreEvent(){return!1}},Q=class extends lt{constructor(t,e){super(),this.options=t,this.plugin=e}toDOM(){let t=document.createElement("span");return t.className="task-decorations-container",t}async navigateToDate(t){let e=D.getDailyNotePath(t,this.plugin.settings),n=this.plugin.app.vault.getAbstractFileByPath(e);n||(n=await this.plugin.app.vault.create(e,"")),n instanceof g.TFile&&await this.plugin.app.workspace.getLeaf().openFile(n)}eq(t){return t.options.taskText===this.options.taskText&&t.options.taskId===this.options.taskId&&t.options.parentId===this.options.parentId&&t.options.uid===this.options.uid&&t.options.calendarSource===this.options.calendarSource&&t.options.isCalendarEvent===this.options.isCalendarEvent&&JSON.stringify(t.options.eventTimeRange)===JSON.stringify(this.options.eventTimeRange)&&t.options.showInfoButton===this.options.showInfoButton&&t.options.lineNum===this.options.lineNum}ignoreEvent(){return!1}};var Z=class extends g.Modal{constructor(t,e,n,i,o,l,a,r,c){super(t),this.taskId=e,this.parentId=n,this.taskText=i,this.parentText=o,this.onUnlink=l,this.uid=a,this.isCalendarEvent=r,this.calendarSource=c}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("task-info-modal"),t.createEl("h3",{text:this.isCalendarEvent?"Event Information":"Task Information"});let e=t.createDiv({cls:"task-info-content"});if(this.isCalendarEvent&&this.uid){if(this.taskText){let o=e.createDiv({cls:"task-info-row"});o.createSpan({text:"Event: ",cls:"task-info-label"}),o.createSpan({text:this.taskText,cls:"task-info-value task-info-name"})}if(this.calendarSource){let o=e.createDiv({cls:"task-info-row"});o.createSpan({text:"Calendar: ",cls:"task-info-label"}),o.createSpan({text:this.calendarSource,cls:"task-info-value task-info-name"})}let n=e.createDiv({cls:"task-info-row"});n.createSpan({text:"Event UID: ",cls:"task-info-label"}),n.createSpan({text:this.uid,cls:"task-info-value"}),e.createDiv({cls:"task-info-row"}).createSpan({text:"Calendar events sync from ICS and are read-only",cls:"task-info-note"})}else if(this.taskId){if(this.taskText){let i=e.createDiv({cls:"task-info-row"});i.createSpan({text:"Task: ",cls:"task-info-label"}),i.createSpan({text:this.taskText,cls:"task-info-value task-info-name"})}let n=e.createDiv({cls:"task-info-row"});n.createSpan({text:"Task ID: ",cls:"task-info-label"}),n.createSpan({text:this.taskId,cls:"task-info-value"})}if(this.parentId){if(this.parentText){let o=e.createDiv({cls:"task-info-row"});o.createSpan({text:"Parent: ",cls:"task-info-label"}),o.createSpan({text:this.parentText,cls:"task-info-value task-info-name"})}let n=e.createDiv({cls:"task-info-row"});n.createSpan({text:"Parent ID: ",cls:"task-info-label"}),n.createSpan({text:this.parentId,cls:"task-info-value"}),t.createEl("button",{text:"Unlink from Parent",cls:"task-unlink-btn"}).addEventListener("click",()=>{this.onUnlink(),this.close()})}else this.taskId&&e.createDiv({cls:"task-info-row"}).createSpan({text:"This is a parent task (no parent link)",cls:"task-info-note"})}onClose(){let{contentEl:t}=this;t.empty()}};var tt=class extends g.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Task Manager Settings"}),t.createEl("h3",{text:"Scope"}),new g.Setting(t).setName("Target folders").setDesc('Comma-separated list of folder paths to process (e.g., "00 - Daily/, 01 - Projects/")').addText(e=>e.setPlaceholder("00 - Daily/").setValue(this.plugin.settings.targetFolders.join(", ")).onChange(async n=>{this.plugin.settings.targetFolders=n.split(",").map(i=>i.trim()).filter(i=>i),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Task IDs"}),new g.Setting(t).setName("Enable task IDs").setDesc("Automatically assign unique IDs to all tasks").addToggle(e=>e.setValue(this.plugin.settings.enableTaskIds).onChange(async n=>{this.plugin.settings.enableTaskIds=n,await this.plugin.saveSettings()})),new g.Setting(t).setName("ID prefix").setDesc("Prefix for generated task IDs").addText(e=>e.setPlaceholder("t-").setValue(this.plugin.settings.idPrefix).onChange(async n=>{this.plugin.settings.idPrefix=n,await this.plugin.saveSettings()})),new g.Setting(t).setName("ID length").setDesc("Number of random characters in task IDs").addText(e=>e.setPlaceholder("8").setValue(String(this.plugin.settings.idLength)).onChange(async n=>{let i=parseInt(n);!isNaN(i)&&i>0&&(this.plugin.settings.idLength=i,await this.plugin.saveSettings())})),t.createEl("h3",{text:"Parent-Child Linking"}),new g.Setting(t).setName("Enable parent-child linking").setDesc("Automatically link subtasks to their parent tasks").addToggle(e=>e.setValue(this.plugin.settings.enableParentChildLinking).onChange(async n=>{this.plugin.settings.enableParentChildLinking=n,await this.plugin.saveSettings()})),new g.Setting(t).setName("Preserve existing parent links").setDesc("Do not overwrite existing parent links when subtasks are moved").addToggle(e=>e.setValue(this.plugin.settings.preserveExistingParentLinks).onChange(async n=>{this.plugin.settings.preserveExistingParentLinks=n,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Sorting"}),new g.Setting(t).setName("Enable auto-sort").setDesc("Automatically sort tasks by time when file is modified").addToggle(e=>e.setValue(this.plugin.settings.enableAutoSort).onChange(async n=>{this.plugin.settings.enableAutoSort=n,await this.plugin.saveSettings()})),new g.Setting(t).setName("Sort debounce delay").setDesc("Milliseconds to wait after last edit before sorting").addText(e=>e.setPlaceholder("500").setValue(String(this.plugin.settings.sortDebounceMs)).onChange(async n=>{let i=parseInt(n);!isNaN(i)&&i>=0&&(this.plugin.settings.sortDebounceMs=i,await this.plugin.saveSettings())})),new g.Setting(t).setName("Tasks without time position").setDesc("Where to place tasks that do not have a timeblock").addDropdown(e=>e.addOption("end","End of list").addOption("start","Start of list").setValue(this.plugin.settings.tasksWithoutTimePosition).onChange(async n=>{this.plugin.settings.tasksWithoutTimePosition=n,await this.plugin.saveSettings()})),new g.Setting(t).setName("Auto-archive completed tasks").setDesc("Move completed, scheduled, and cancelled tasks to a collapsed section").addToggle(e=>e.setValue(this.plugin.settings.enableAutoArchive).onChange(async n=>{this.plugin.settings.enableAutoArchive=n,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Task Status Sync"}),new g.Setting(t).setName("Enable status sync").setDesc("Sync task status between task notes and daily notes bidirectionally").addToggle(e=>e.setValue(this.plugin.settings.enableTaskStatusSync).onChange(async n=>{this.plugin.settings.enableTaskStatusSync=n,await this.plugin.saveSettings()})),new g.Setting(t).setName("Status mappings").setDesc("Checkbox marker \u2192 status name mappings (JSON format)").addTextArea(e=>{e.inputEl.rows=8,e.inputEl.cols=40,e.setValue(JSON.stringify(this.plugin.settings.statusMappings,null,2)).onChange(async n=>{try{let i=JSON.parse(n);this.plugin.settings.statusMappings=i,await this.plugin.saveSettings()}catch(i){}})}),t.createEl("h3",{text:"Display"}),new g.Setting(t).setName("Show info button").setDesc("Display info button (i) on tasks to view metadata").addToggle(e=>e.setValue(this.plugin.settings.showInfoButton).onChange(async n=>{this.plugin.settings.showInfoButton=n,await this.plugin.saveSettings()})),new g.Setting(t).setName("Hide metadata fields").setDesc("Hide [id::...] and [parent::...] fields in the editor").addToggle(e=>e.setValue(this.plugin.settings.hideMetadataFields).onChange(async n=>{this.plugin.settings.hideMetadataFields=n,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Shortcut Triggers"}),new g.Setting(t).setName("Enable > schedule trigger").setDesc("Typing > on a task line shows schedule suggestions").addToggle(e=>e.setValue(this.plugin.settings.enableScheduleTrigger).onChange(async n=>{this.plugin.settings.enableScheduleTrigger=n,await this.plugin.saveSettings()})),new g.Setting(t).setName("Enable ^ timeblock trigger").setDesc("Typing ^ on a task line shows timeblock suggestions").addToggle(e=>e.setValue(this.plugin.settings.enableTimeblockTrigger).onChange(async n=>{this.plugin.settings.enableTimeblockTrigger=n,await this.plugin.saveSettings()})),new g.Setting(t).setName("Enable / slash command trigger").setDesc("Typing / on a task line shows command suggestions").addToggle(e=>e.setValue(this.plugin.settings.enableSlashCommandTrigger).onChange(async n=>{this.plugin.settings.enableSlashCommandTrigger=n,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Task Notes"}),new g.Setting(t).setName("Enable task notes").setDesc('Show "notes" button on parent tasks to open dedicated task notes').addToggle(e=>e.setValue(this.plugin.settings.enableTaskNotes).onChange(async n=>{this.plugin.settings.enableTaskNotes=n,await this.plugin.saveSettings()})),new g.Setting(t).setName("Auto-create task notes").setDesc("Automatically create a task note and link when cursor leaves a task line").addToggle(e=>e.setValue(this.plugin.settings.autoCreateTaskNotes).onChange(async n=>{this.plugin.settings.autoCreateTaskNotes=n,await this.plugin.saveSettings()})),new g.Setting(t).setName("Task notes folder").setDesc("Folder where task notes will be created").addText(e=>e.setPlaceholder("Task Notes").setValue(this.plugin.settings.taskNotesFolder).onChange(async n=>{this.plugin.settings.taskNotesFolder=n.trim()||"Task Notes",await this.plugin.saveSettings()})),t.createEl("h3",{text:"Event Notes"}),new g.Setting(t).setName("Enable event notes").setDesc('Show "notes" button on calendar events to create/open dedicated event notes with eventUID in frontmatter').addToggle(e=>e.setValue(this.plugin.settings.enableEventNotes).onChange(async n=>{this.plugin.settings.enableEventNotes=n,await this.plugin.saveSettings()})),new g.Setting(t).setName("Event notes folder").setDesc("Folder where event notes will be created").addText(e=>e.setPlaceholder("Event Notes").setValue(this.plugin.settings.eventNotesFolder).onChange(async n=>{this.plugin.settings.eventNotesFolder=n.trim()||"Event Notes",await this.plugin.saveSettings()})),t.createEl("h3",{text:"Calendar Sync"}),new g.Setting(t).setName("Enable ICS calendar sync").setDesc("Automatically sync calendar events from ICS plugin when opening daily notes. Events use [c] checkbox and are read-only.").addToggle(e=>e.setValue(this.plugin.settings.enableIcsSync).onChange(async n=>{this.plugin.settings.enableIcsSync=n,await this.plugin.saveSettings()}))}},et=class extends g.Plugin{async onload(){console.log("Task Manager: loaded"),await this.loadSettings();let t=this;this.isProcessing=!1;let e=it.fromClass(class{constructor(a){this.decorations=this.buildDecorations(a,t)}update(a){(a.docChanged||a.viewportChanged)&&(this.decorations=this.buildDecorations(a.view,t))}buildDecorations(a,r){let c=[],u=f.TASK_PATTERN,d=f.PARENT_TASK_PATTERN,h=/\s*\[(?:id|parent|uid|calendar)::\s*[^\]]+\]/g,m=/^([\t]*- \[.\]\s*)(\d{2}:\d{2}\s*-\s*\d{2}:\d{2})/,T=r.app.workspace.getActiveFile(),w=T&&T.path.startsWith(r.settings.taskNotesFolder+"/");for(let{from:k,to:S}of a.visibleRanges)for(let b=k;b<S;){let v=a.state.doc.lineAt(b),x=v.text;if(u.test(x)){let y=f.extractId(x),C=f.extractParentId(x),E=d.test(x),I=x.match(m);if(I){let F=v.from+I[1].length,B=F+I[2].length;c.push({from:F,to:B,value:V.mark({class:"timeblock-pill",attributes:{"data-line":String(v.number-1)}})})}if(r.settings.hideMetadataFields){let F;for(h.lastIndex=0;(F=h.exec(x))!==null;){let B=v.from+F.index,pt=B+F[0].length;c.push({from:B,to:pt,value:V.replace({})})}}let A=f.isCalendarEvent(x),O=A?K.extractUid(x):null,st=A?K.extractCalendar(x):null,P=A?rt.extractEventTitle(x):N.extractTaskTextFromLine(x),dt=A?rt.extractTimeRange(x):null,ut=r.settings.enableTaskNotes&&!r.settings.autoCreateTaskNotes&&E&&!w&&P&&P.trim()!=="",ht=r.settings.enableEventNotes&&A&&O&&P&&P.trim()!=="",nt=ut||ht;if(r.settings.showInfoButton&&(y||C||O)&&c.push({from:v.from,to:v.from,value:V.widget({widget:new X({taskText:P,taskId:y,parentId:C,uid:O,isCalendarEvent:A,calendarSource:st},r),side:-1})}),(!P||!P.trim())&&!nt){b=v.to+1;continue}nt&&c.push({from:v.to,to:v.to,value:V.widget({widget:new Q({taskText:P,taskId:y,parentId:C,uid:O,calendarSource:st,isCalendarEvent:A,eventTimeRange:dt,showInfoButton:!1,lineNum:v.number},r),side:1})})}b=v.to+1}c.sort((k,S)=>k.from-S.from||k.to-S.to);let p=new gt;for(let k of c)p.add(k.from,k.to,k.value);return p.finish()}},{decorations:a=>a.decorations});this.registerEditorExtension([e]),this.registerEditorSuggest(new j(this.app,this)),this.registerEditorSuggest(new q(this.app,this)),this.registerEditorSuggest(new Y(this.app,this)),this.taskNoteSyncing=!1,this.taskNoteSyncTimers=new Map,this.lastCursorLine=-1;let n=it.fromClass(class{constructor(a){this.plugin=t,this.lastLine=-1}update(a){if(!a.selectionSet)return;let r=a.state.doc.lineAt(a.state.selection.main.head).number-1;if(this.lastLine!==-1&&this.lastLine!==r){let c=this.lastLine;setTimeout(()=>this.plugin.processLineOnLeave(c),0)}this.lastLine=r}});this.registerEditorExtension([n]),this.registerDomEvent(document,"click",a=>{let r=a.target;if(r.matches('input[data-task="c"], .task-list-item-checkbox[data-task="c"]')||r.closest('li[data-task="c"]')&&r.matches('input[type="checkbox"]'))return a.preventDefault(),a.stopPropagation(),!1},!0),this.registerDomEvent(document,"click",a=>{var m;if(a.metaKey||a.ctrlKey)return;let c=a.target.closest("a.internal-link, a.external-link, a.cm-underline");if(!c||!c.closest("li.task-list-item, li[data-task]"))return;a.preventDefault(),a.stopPropagation();let d=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(!d||!d.editor)return;let h=d.leaf.getViewState();((m=h.state)==null?void 0:m.mode)==="preview"&&(h.state.mode="source",d.leaf.setViewState(h))},!0),this.registerDomEvent(document,"click",a=>{let c=a.target.closest(".timeblock-pill");if(!c)return;a.preventDefault(),a.stopPropagation();let u=parseInt(c.dataset.line,10);if(isNaN(u))return;let d=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(!d||!d.editor)return;let h=d.editor;new L(this,h,u,"start").open()}),this.registerEvent(this.app.vault.on("modify",a=>{if(!this.isProcessing&&this.settings.enableTaskNotes&&a.path.startsWith(this.settings.taskNotesFolder+"/")){this.taskNoteSyncing||(this.taskNoteSyncTimers.has(a.path)&&clearTimeout(this.taskNoteSyncTimers.get(a.path)),this.taskNoteSyncTimers.set(a.path,setTimeout(async()=>{this.taskNoteSyncTimers.delete(a.path),this.taskNoteSyncing=!0;try{await N.syncSubtasksBackToSource(this.app,a,!1),await N.syncStatusToSource(this.app,a,this.settings)}finally{setTimeout(()=>{this.taskNoteSyncing=!1},100)}},500)));return}})),this.registerEvent(this.app.workspace.on("file-open",async a=>{if(!(!a||!this.settings.enableIcsSync||this.isProcessing||!K.getDailyNoteDate(a,this.settings))){this.isProcessing=!0;try{await K.syncEventsToNote(this.app,a,this.settings)&&console.log("Task Manager: Synced ICS events to",a.path)}catch(c){console.error("Task Manager: Error syncing ICS events",c)}finally{setTimeout(()=>{this.isProcessing=!1},100)}}})),this.addCommand({id:"assign-task-ids",name:"Assign IDs to all tasks in current file",editorCallback:(a,r)=>{let c=a.getValue(),u=H.processContent(c,this.settings);c!==u&&a.setValue(u)}}),this.addCommand({id:"link-parent-child",name:"Link subtasks to parent tasks in current file",editorCallback:(a,r)=>{let c=a.getValue();c=H.processContent(c,this.settings);let u=at.linkContent(c,this.settings);a.getValue()!==u&&a.setValue(u)}}),this.addCommand({id:"unlink-from-parent",name:"Unlink task from parent",editorCallback:(a,r)=>{let c=a.getCursor(),u=a.getLine(c.line);if(f.extractParentId(u)){let d=f.removeParentId(u);a.setLine(c.line,d),new g.Notice("Task unlinked from parent")}else new g.Notice("This task has no parent link")}}),this.addCommand({id:"sort-tasks",name:"Sort tasks chronologically in current file",editorCallback:(a,r)=>{let c=a.getValue(),u=U.sortContent(c,this.settings);c!==u&&a.setValue(u)}}),this.addCommand({id:"sort-by-time-block",name:"Sort all items by time block",editorCallback:(a,r)=>{let c=a.getValue(),u=U.sortByTimeBlock(c,this.settings);c!==u&&a.setValue(u)}}),this.addCommand({id:"show-task-info",name:"Show task info for current line",editorCallback:(a,r)=>{let c=a.getCursor(),u=a.getLine(c.line),d=f.extractId(u),h=f.extractParentId(u),m=N.extractTaskTextFromLine(u);d||h?this.showTaskInfo(d,h,m,a,c.line):new g.Notice("No task metadata on this line")}}),this.addCommand({id:"mark-task-complete",name:"Mark task complete",editorCheckCallback:(a,r,c)=>{let u=r.getCursor(),d=r.getLine(u.line);if(!f.isTask(d))return!1;if(a)return!0;let h=d.replace(/^([\t]*- \[)[^\]](\])/,"$1x$2");r.setLine(u.line,h)}}),this.addCommand({id:"mark-task-in-progress",name:"Mark task in progress",editorCheckCallback:(a,r,c)=>{let u=r.getCursor(),d=r.getLine(u.line);if(!f.isTask(d))return!1;if(a)return!0;let h=d.replace(/^([\t]*- \[)[^\]](\])/,"$1/$2");r.setLine(u.line,h)}}),this.addCommand({id:"mark-task-cancelled",name:"Mark task cancelled",editorCheckCallback:(a,r,c)=>{let u=r.getCursor(),d=r.getLine(u.line);if(!f.isTask(d))return!1;if(a)return!0;let h=d.replace(/^([\t]*- \[)[^\]](\])/,"$1-$2");r.setLine(u.line,h)}}),this.addCommand({id:"set-status-complete",name:"Set task status: Complete",callback:async()=>{let a=this.app.workspace.getActiveFile();if(!(a!=null&&a.path.startsWith(this.settings.taskNotesFolder+"/"))){new g.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(a,"complete")}}),this.addCommand({id:"set-status-incomplete",name:"Set task status: Incomplete",callback:async()=>{let a=this.app.workspace.getActiveFile();if(!(a!=null&&a.path.startsWith(this.settings.taskNotesFolder+"/"))){new g.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(a,"incomplete")}}),this.addCommand({id:"set-status-in-progress",name:"Set task status: In Progress",callback:async()=>{let a=this.app.workspace.getActiveFile();if(!(a!=null&&a.path.startsWith(this.settings.taskNotesFolder+"/"))){new g.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(a,"in-progress")}}),this.addCommand({id:"set-status-cancelled",name:"Set task status: Cancelled",callback:async()=>{let a=this.app.workspace.getActiveFile();if(!(a!=null&&a.path.startsWith(this.settings.taskNotesFolder+"/"))){new g.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(a,"cancelled")}}),this.addCommand({id:"schedule-task",name:"Schedule task",editorCheckCallback:(a,r,c)=>{let u=r.getCursor(),d=r.getLine(u.line);if(!f.isTask(d))return!1;if(a)return!0;new _(this,r,u.line).open()}}),this.addCommand({id:"unschedule-task",name:"Unschedule task",editorCheckCallback:(a,r,c)=>{let u=r.getCursor(),d=r.getLine(u.line);if(!f.isTask(d))return!1;let h=/^[\t]*- \[>\]/.test(d),m=/>\[\[\d{4}-\d{2}-\d{2}\]\]/.test(d)||/\[scheduled_to::\s*\[\[\d{4}-\d{2}-\d{2}\]\]\]/.test(d)||/\[>\s*\d{4}-\d{2}-\d{2}\]/.test(d);if(!h&&!m)return!1;if(a)return!0;D.unscheduleTask(this.app,this.settings,r,u.line)}}),this.addCommand({id:"set-time-block",name:"Set time block",editorCheckCallback:(a,r,c)=>{let u=r.getCursor(),d=r.getLine(u.line);if(!f.isTask(d))return!1;if(a)return!0;new L(this,r,u.line,"start").open()}}),this.addCommand({id:"schedule-overdue-to-today",name:"Schedule all overdue tasks to today",callback:async()=>{let a=new Date;a.setHours(0,0,0,0),await z.scheduleAllOverdueTo(this.app,this.settings,a)}}),this.addCommand({id:"schedule-overdue-to-this-note",name:"Schedule all overdue tasks to this note's date",checkCallback:a=>{let r=this.app.workspace.getActiveFile();if(!r||!f.shouldProcessFile(r,this.settings))return!1;let c=z.parseDateFromFilename(r.basename);if(!c)return!1;if(a)return!0;z.scheduleAllOverdueTo(this.app,this.settings,c)}}),this.addCommand({id:"archive-completed-tasks",name:"Archive completed/scheduled tasks now",editorCallback:async(a,r)=>{let c=r.file;if(!c||!f.shouldProcessFile(c,this.settings)){new g.Notice("This command only works in target folders");return}let u=a.getValue(),d=ot.archiveContent(u,this.settings);d!==u?(a.setValue(d),new g.Notice("Tasks archived")):new g.Notice("No tasks to archive")}}),this.addSettingTab(new tt(this.app,this));let i=this.manifest.version;this.addStatusBarItem().setText(`Task Manager: v${i} | remove-normalize-metadata-order`)}onunload(){if(console.log("Task Manager: unloaded"),this.taskNoteSyncTimers){for(let t of this.taskNoteSyncTimers.values())clearTimeout(t);this.taskNoteSyncTimers.clear()}}async loadSettings(){this.settings=Object.assign({},ft,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async processFile(t){this.isProcessing=!0;try{let e=this.app.workspace.getActiveViewOfType(g.MarkdownView),n=this.app.workspace.getActiveFile(),i=e&&n&&n.path===t.path,o,l;i?(l=e.editor,o=l.getValue()):o=await this.app.vault.read(t);let a=!1;if(this.settings.enableTaskIds){let r=H.processContent(o,this.settings);r!==o&&(o=r,a=!0)}if(this.settings.enableParentChildLinking){let r=at.linkContent(o,this.settings);r!==o&&(o=r,a=!0)}if(this.settings.enableAutoSort){let r=U.sortContent(o,this.settings);r!==o&&(o=r,a=!0)}if(this.settings.enableAutoArchive&&!i){let r=ot.archiveContent(o,this.settings);r!==o&&(o=r,a=!0)}if(a)if(i&&l){let r=l.getCursor(),c=l.getValue().split(`
`),u=o.split(`
`);for(let d=0;d<u.length;d++)if(d<c.length&&c[d]!==u[d])if(d===r.line){let h=c[d],m=u[d];if(m.length>h.length&&m.startsWith(h.trimEnd())){let T=m.slice(h.trimEnd().length);l.replaceRange(T,{line:d,ch:h.length})}}else l.setLine(d,u[d])}else await this.app.vault.modify(t,o);this.settings.enableTaskStatusSync&&!this.taskNoteSyncing&&await N.syncAllStatusesToTaskNotes(this.app,t,this.settings)}finally{setTimeout(()=>{this.isProcessing=!1},100)}}async updateTaskNoteStatus(t,e){let n=await this.app.vault.read(t);if(N.extractFrontmatterField(n,"status")===e){new g.Notice(`Status already set to ${e}`);return}let o=N.updateFrontmatterField(n,"status",e);o=this.updateButtonHighlighting(o,e),o!==n&&(await this.app.vault.modify(t,o),new g.Notice(`Status changed to ${e}`))}updateButtonHighlighting(t,e){let i={incomplete:"btn-incomplete","in-progress":"btn-progress",cancelled:"btn-cancelled",complete:"btn-complete"}[e];if(!i)return t;let o=/(```meta-bind-button\n(?:> )?label: "[^"]+"\n(?:> )?style: )(primary|default)(\n(?:> )?id: (btn-[a-z-]+))/g;return t.replace(o,(l,a,r,c,u)=>a+(u===i?"primary":"default")+c)}processLineOnLeave(t){let e=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(!e)return;let n=this.app.workspace.getActiveFile();if(!n||!f.shouldProcessFile(n,this.settings))return;let i=e.editor,o=i.getLine(t);if(!o||!f.isTask(o)||f.isCalendarEvent(o)||!o.replace(/^[\t]*- \[.\]\s*/,"").trim())return;let a=o,r=!1;if(this.settings.enableTaskIds&&!f.extractId(o)&&(a=f.addId(a,f.generateId(this.settings)),r=!0),this.settings.enableParentChildLinking&&f.isSubtask(o)){let c=null;for(let u=t-1;u>=0;u--){let d=i.getLine(u);if(f.isParentTask(d)){c=f.extractId(d);break}}c&&!f.extractParentId(a)&&(a=f.addParentId(a,c),r=!0)}if(r&&(this.isProcessing=!0,i.setLine(t,a),setTimeout(()=>{this.isProcessing=!1},50)),this.settings.autoCreateTaskNotes&&this.settings.enableTaskNotes&&f.isParentTask(a||o)){let c=i.getLine(t);if(!c||f.hasWikiLink(c))return;let u=N.extractTaskTextFromLine(c);if(!u||!u.trim())return;let d=f.extractId(c),h=n.path;(async()=>{try{if(!await N.ensureTaskNoteExists(this.app,this.settings,u,h,d,c))return;let T=i.getLine(t);if(!T||f.hasWikiLink(T))return;let w=f.wrapTaskTextWithLink(T);w&&w!==T&&(this.isProcessing=!0,i.setLine(t,w),setTimeout(()=>{this.isProcessing=!1},50))}catch(m){console.error("Task Manager: auto-create task note failed",m)}})()}}showTaskInfo(t,e,n,i,o,l,a,r){let c=null;if(e&&this.app.workspace.getActiveFile()){let h=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(h&&h.editor){let T=h.editor.getValue().split(`
`);for(let w of T)if(f.extractId(w)===e){c=N.extractTaskTextFromLine(w);break}}}new Z(this.app,t,e,n,c,()=>{if(i&&o!==void 0){let d=i.getLine(o),h=f.removeParentId(d);i.setLine(o,h),new g.Notice("Task unlinked from parent")}},l,a,r).open()}showSchedulePopupFromWidget(t,e){let n=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(!n||!n.editor)return;let i=n.editor;new G(this,i,e,t).open()}showTimeblockPickerFromWidget(t,e){let n=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(!n||!n.editor)return;let i=n.editor;new J(this,i,e,"start",null,null,t).open()}};module.exports=et;
