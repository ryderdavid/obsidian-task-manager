"use strict";var m=require("obsidian"),{EditorView:St,Decoration:$,ViewPlugin:lt,WidgetType:wt}=require("@codemirror/view"),{RangeSetBuilder:vt}=require("@codemirror/state"),bt={targetFolders:["00 - Daily/"],enableTaskIds:!0,idPrefix:"t-",idLength:8,enableParentChildLinking:!0,preserveExistingParentLinks:!0,enableAutoSort:!1,sortDebounceMs:500,tasksWithoutTimePosition:"end",showInfoButton:!0,hideMetadataFields:!0,enableTaskNotes:!0,taskNotesFolder:"Task Notes",enableEventNotes:!0,eventNotesFolder:"Event Notes",enableIcsSync:!0,enableAutoArchive:!0,enableTaskStatusSync:!0,statusMappings:{" ":"incomplete",x:"complete",X:"complete","/":"in-progress","-":"cancelled",">":"scheduled"}},g={TASK_PATTERN:/^[\t]*- \[.\]/,PARENT_TASK_PATTERN:/^- \[.\]/,SUBTASK_PATTERN:/^\t+- \[.\]/,ID_PATTERN:/\[id::([^\]]+)\]/,PARENT_ID_PATTERN:/\[parent::([^\]]+)\]/,METADATA_PATTERN:/\s*\[(?:id|parent|uid)::[^\]]+\]/g,COMPLETED_PATTERN:/^[\t]*- \[[xX]\]/,TIMEBLOCK_PATTERN:/^- \[.\]\s*(\d{2}):(\d{2}) - (\d{2}):(\d{2})/,CALENDAR_EVENT_PATTERN:/^[\t]*- \[c\]/,extractId(i){let t=i.match(this.ID_PATTERN);return t?t[1].trim():null},extractParentId(i){let t=i.match(this.PARENT_ID_PATTERN);return t?t[1].trim():null},generateId(i){let t="abcdefghijklmnopqrstuvwxyz0123456789",e=i.idPrefix;for(let n=0;n<i.idLength;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e},addId(i,t){return this.extractId(i)?i:i.trimEnd()+` [id::${t}]`},addParentId(i,t){let e=this.extractParentId(i);return e?e!==t?i.replace(this.PARENT_ID_PATTERN,`[parent::${t}]`):i:i.trimEnd()+` [parent::${t}]`},normalizeMetadataOrder(i){if(!this.isTask(i))return i;let t=i.match(/^([\t]*- \[.\]\s*)/);if(!t)return i;let e=t[1],n=i.slice(e.length),s=n.match(/\[id::([^\]]+)\]/),a=n.match(/\[parent::([^\]]+)\]/),o=n.match(/\[uid::([^\]]+)\]/),c=n.match(/\[>\s*(\d{4}-\d{2}-\d{2})\]/),r=n.match(/\[<\s*(\d{4}-\d{2}-\d{2})\]/);n=n.replace(/\s*\[id::[^\]]+\]/g,"").replace(/\s*\[parent::[^\]]+\]/g,"").replace(/\s*\[uid::[^\]]+\]/g,"").replace(/\s*\[>\s*\d{4}-\d{2}-\d{2}\]/g,"").replace(/\s*\[<\s*\d{4}-\d{2}-\d{2}\]/g,"").trimEnd();let l=[e+n];return s&&l.push(`[id::${s[1]}]`),a&&l.push(`[parent::${a[1]}]`),o&&l.push(`[uid::${o[1]}]`),r&&l.push(`[< ${r[1]}]`),c&&l.push(`[> ${c[1]}]`),l.join(" ")},removeParentId(i){return i.replace(/\s*\[parent::[^\]]+\]/,"")},isTask(i){return this.TASK_PATTERN.test(i)},isCalendarEvent(i){return this.CALENDAR_EVENT_PATTERN.test(i)},isParentTask(i){return this.PARENT_TASK_PATTERN.test(i)},isSubtask(i){return this.SUBTASK_PATTERN.test(i)},isCompleted(i){return this.COMPLETED_PATTERN.test(i)},getTaskSortKey(i){let t=i.match(this.TIMEBLOCK_PATTERN);if(t){let e=parseInt(t[1])*60+parseInt(t[2]),n=parseInt(t[3])*60+parseInt(t[4]);return{hasTime:!0,start:e,end:n}}return{hasTime:!1,start:1/0,end:1/0}},shouldProcessFile(i,t){return i.extension!=="md"?!1:t.targetFolders.some(e=>i.path.includes(e))}},j={UID_PATTERN:/\[uid::([^\]]+)\]/,CALENDAR_PATTERN:/\[calendar::([^\]]+)\]/,extractUid(i){let t=i.match(this.UID_PATTERN);return t?t[1].trim():null},extractCalendar(i){let t=i.match(this.CALENDAR_PATTERN);return t?t[1].trim():null},parseEventLine(i){let t=i.match(/^- \[c\]\s*(\d{2}):(\d{2})\s*-\s*(\d{2}):(\d{2})\s+(.+?)(?:\s*\[uid::[^\]]+\])?\s*$/);return t?{startHour:parseInt(t[1]),startMinute:parseInt(t[2]),endHour:parseInt(t[3]),endMinute:parseInt(t[4]),text:t[5].trim(),uid:this.extractUid(i)}:null},formatTime(i,t){return`${i.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},buildEventLine(i,t){let e=i.time||"00:00",n=i.endTime||e,s=i.summary||"Untitled Event";i.location&&(s+=` ${i.location}`),i.callUrl&&(s+=` ${i.callUrl}`);let a=i.uid||`fallback-${i.utime}`,o=i.icsName||"",c=`- [c] ${e} - ${n} ${s} [uid::${a}]`;return o&&(c+=` [calendar::${o}]`),c},getDailyNoteDate(i,t){if(!g.shouldProcessFile(i,t))return null;let e=i.basename.match(/^(\d{4})-(\d{2})-(\d{2})$/);return e?new Date(parseInt(e[1]),parseInt(e[2])-1,parseInt(e[3])):null},async getIcsEvents(i,t){try{let e=i.plugins.getPlugin("ics");if(!e||!e.getEvents)return null;let n=window.moment;return n?await e.getEvents(n(t)):null}catch(e){return console.error("Task Manager: Error fetching ICS events",e),null}},async syncEventsToNote(i,t,e){let n=this.getDailyNoteDate(t,e);if(!n)return!1;let s=await this.getIcsEvents(i,n);if(!s||s.length===0)return!1;let a=await i.vault.read(t),o=a.split(`
`),c=[],r=[];for(let k of o)g.isCalendarEvent(k)?c.push(k):r.push(k);let l=new Map;for(let k of c){let T=this.extractUid(k);T&&l.set(T,k)}let p=[];for(let k of s){let T=this.buildEventLine(k,e);p.push({line:T,utime:k.utime||0})}p.sort((k,T)=>k.utime-T.utime);let h=[...p.map(k=>k.line),...r].join(`
`);return h!==a?(await i.vault.modify(t,h),!0):!1}},G={processContent(i,t){let e=i.split(`
`),n=[];for(let s=0;s<e.length;s++){let a=e[s];if(g.isCalendarEvent(a)){n.push(a);continue}g.isTask(a)&&(g.extractId(a)||(a=g.addId(a,g.generateId(t)))),n.push(a)}return n.join(`
`)}},dt={linkContent(i,t){let e=i.split(`
`),n=[],s=null;for(let a=0;a<e.length;a++){let o=e[a],c=g.isParentTask(o),r=g.isSubtask(o);c?(s=g.extractId(o),g.extractParentId(o)&&(o=g.removeParentId(o)),n.push(o)):r?(!g.extractParentId(o)&&s&&(o=g.addParentId(o,s)),n.push(o)):(/^#/.test(o)&&(s=null),n.push(o))}return n.join(`
`)}},J={sortContent(i,t){let e=i.split(`
`),n=[],s=[],a=!1,o=[],c=[],r=[],l=!1;for(let u=0;u<e.length;u++){let f=e[u];if(/^##\s*Completed\s*$/i.test(f)){a=!0;continue}let b=g.isParentTask(f),v=g.isSubtask(f);if(a){if(b)s.push({id:g.extractId(f),parent:f,subtasks:[]});else if(v&&s.length>0){let E=g.extractParentId(f);if(E){let y=s.find(x=>x.id===E);y?y.subtasks.push(f):s[s.length-1].subtasks.push(f)}else s[s.length-1].subtasks.push(f)}else/^#/.test(f)&&(a=!1,r.push({line:f,index:u,isTaskArea:!1}));continue}b?(l||(l=!0),o.push({id:g.extractId(f),line:f,index:u})):v?c.push({parentId:g.extractParentId(f),line:f,index:u}):(l&&/^#/.test(f)&&(l=!1),r.push({line:f,index:u,isTaskArea:l}))}let p=[];for(let u of o){let f={parent:u.line,subtasks:[],sortKey:g.getTaskSortKey(u.line)};if(u.id)for(let v of c)v.parentId===u.id&&f.subtasks.push(v.line);let b=u.index;for(let v of c)if(!v.parentId){let E=!0;for(let x of o)if(x.index>b&&x.index<v.index){E=!1;break}let y=o.filter(x=>x.index<v.index).sort((x,S)=>S.index-x.index)[0];y&&y.index===b&&E&&(f.subtasks.includes(v.line)||f.subtasks.push(v.line))}p.push(f)}let d=p.filter(u=>!g.isCompleted(u.parent)),h=p.filter(u=>g.isCompleted(u.parent));d.sort((u,f)=>u.sortKey.hasTime&&!f.sortKey.hasTime?-1:!u.sortKey.hasTime&&f.sortKey.hasTime?1:u.sortKey.start!==f.sortKey.start?u.sortKey.start-f.sortKey.start:u.sortKey.end-f.sortKey.end),h.sort((u,f)=>u.sortKey.hasTime&&!f.sortKey.hasTime?-1:!u.sortKey.hasTime&&f.sortKey.hasTime?1:u.sortKey.start!==f.sortKey.start?u.sortKey.start-f.sortKey.start:u.sortKey.end-f.sortKey.end);let k=o.length>0?o[0].index:0,T=o.length>0?Math.max(...o.map(u=>u.index),...c.map(u=>u.index)):0;for(let u of r)u.index<k&&n.push(u.line);for(let u of d){n.push(u.parent);for(let f of u.subtasks)n.push(f)}for(let u of r)u.index>T&&n.push(u.line);let w=[...h,...s];if(w.length>0){for(;n.length>0&&n[n.length-1].trim()==="";)n.pop();n.push(""),n.push("## Completed"),w.sort((u,f)=>{let b=g.getTaskSortKey(u.parent),v=g.getTaskSortKey(f.parent);return b.hasTime&&!v.hasTime?-1:!b.hasTime&&v.hasTime?1:b.start!==v.start?b.start-v.start:b.end-v.end});for(let u of w){n.push(u.parent);for(let f of u.subtasks)n.push(f)}}return n.join(`
`)},sortByTimeBlock(i,t){let e=i.split(`
`),n=/^[\t]*- \[.\]\s*(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/,s=/^> \[!archived\]-?\s*Archived\s*$/,a=/^> /,o=[],c=[],r=[],l=0,p=!1;for(;l<e.length;){let h=e[l];if(s.test(h)){p=!0,r.push(h),l++;continue}if(p)if(a.test(h)||h.trim()===""){r.push(h),l++;continue}else p=!1;let k=g.isParentTask(h),T=g.isCalendarEvent(h);if(k||T){let w=h.match(n),u=[];if(k){let b=g.extractId(h),v=l+1;for(;v<e.length&&g.isSubtask(e[v]);){let E=g.extractParentId(e[v]);(!E||E===b)&&u.push(e[v]),v++}l=v}else l++;let f={line:h,subtasks:u,isEvent:T};w?(f.startMinutes=parseInt(w[1])*60+parseInt(w[2]),f.endMinutes=parseInt(w[3])*60+parseInt(w[4]),o.push(f)):c.push(f)}else g.isSubtask(h),l++}o.sort((h,k)=>h.startMinutes!==k.startMinutes?h.startMinutes-k.startMinutes:h.endMinutes-k.endMinutes);let d=[];for(let h of o){d.push(h.line);for(let k of h.subtasks)d.push(k)}c.length>0&&o.length>0&&d.push("");for(let h of c){d.push(h.line);for(let k of h.subtasks)d.push(k)}if(r.length>0){d.push("");for(let h of r)d.push(h)}return d.join(`
`)}},ut={ARCHIVE_STATES:/^[\t]*- \[[xX>\-]\]/,ACTIVE_STATES:/^[\t]*- \[[ \/c]\]/,ARCHIVE_CALLOUT_START:/^> \[!archived\]-?\s*Archived\s*$/,ARCHIVE_LINE:/^> /,archiveContent(i,t){let e=i.split(`
`),n=[],s=[],a=[],o=[],c=!1,r=0;for(;r<e.length;){let d=e[r];if(this.ARCHIVE_CALLOUT_START.test(d)){c=!0,r++;continue}if(c)if(this.ARCHIVE_LINE.test(d)){o.push(d.substring(2)),r++;continue}else c=!1;if(g.CALENDAR_EVENT_PATTERN.test(d)){n.push(d),r++;continue}if(this.ARCHIVE_STATES.test(d)){let h=[d];for(r++;r<e.length&&g.SUBTASK_PATTERN.test(e[r]);)h.push(e[r]),r++;a.push(...h);continue}if(this.ACTIVE_STATES.test(d)){let h=[d];for(r++;r<e.length&&g.SUBTASK_PATTERN.test(e[r]);)h.push(e[r]),r++;s.push(...h);continue}(d.trim()!==""||s.length>0)&&s.push(d),r++}let l=[...a,...o],p=[];for(let d of n)p.push(d);for(let d of s)p.push(d);if(l.length>0){if(p.length>0){for(;p.length>0&&p[p.length-1]==="";)p.pop();for(let d=0;d<7;d++)p.push("")}p.push("> [!archived]- Archived");for(let d of l)p.push("> "+d)}return p.join(`
`)}},I={cleanTaskText(i){return i=i.replace(/\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/g,""),i=i.replace(/üìÖ\s*\[\[[^\]]+\]\]/g,""),i=i.replace(/üìÖ\s*\d{4}-\d{2}-\d{2}/g,""),i=i.replace(/#\w+/g,""),i=i.replace(/üîó\[\[[^\]]+\]\]/g,""),i=i.replace(/\[\[([^\]|]+)\|?([^\]]*)\]\]/g,(t,e,n)=>n||e),i=i.replace(/[üìÖüóìÔ∏è‚è≥üõ´‚úÖ‚ùå‚ûïüî∫‚è´üîºüîΩ‚è¨üÜî‚õîüîÅ][^\s]*/g,""),i=i.replace(/üìù/g,""),i=i.replace(/üîó/g,""),i=i.replace(/\s*\[[^\]]+::[^\]]*\]/g,""),i=i.replace(/\s*\[[<>]\s*\d{4}-\d{2}-\d{2}\]/g,""),i=i.replace(/\s+/g," ").trim(),i},sanitizeFilename(i){return i.replace(/[\\/:*?"<>|#\[\]]/g,"-").replace(/-+/g,"-").replace(/\s+/g," ").trim().substring(0,100)},extractTaskTextFromLine(i){let t=i.match(/^- \[.\]\s*(.+)$/);return t?this.cleanTaskText(t[1]):null},extractCheckboxMarker(i){let t=i.match(/^[\t]*- \[(.)\]/);return t?t[1]:null},checkboxToStatus(i,t){return t.statusMappings[i]||"incomplete"},statusToCheckbox(i,t){for(let[e,n]of Object.entries(t.statusMappings))if(n===i)return e;return" "},extractFrontmatterField(i,t){let e=i.match(/^---\n([\s\S]*?)\n---/);if(!e)return null;let s=e[1].match(new RegExp(`^${t}:\\s*"?([^"\\n]*)"?`,"m"));return s?s[1]:null},updateFrontmatterField(i,t,e){let n=i.match(/^(---\n)([\s\S]*?)(\n---)/);if(!n)return i;let[s,a,o,c]=n,r=new RegExp(`^(${t}:\\s*)"?[^"\\n]*"?`,"m"),l;return r.test(o)?l=o.replace(r,`$1"${e}"`):l=o+`
${t}: "${e}"`,i.replace(s,a+l+c)},updateTaskCheckbox(i,t,e){let n=i.split(`
`),s=new RegExp(`\\[id::\\s*${t}\\]`);for(let a=0;a<n.length;a++)if(s.test(n[a])){n[a]=n[a].replace(/^([\t]*- \[).(])/,`$1${e}$2`);break}return n.join(`
`)},async findTaskNoteByTaskId(i,t,e){let n=e.taskNotesFolder,s=i.vault.getFiles().filter(a=>a.path.startsWith(n+"/"));for(let a of s){let o=await i.vault.read(a);if(this.extractFrontmatterField(o,"taskId")===t)return a}return null},async syncStatusToSource(i,t,e){if(!e.enableTaskStatusSync)return;let n=await i.vault.read(t),s=this.extractFrontmatterField(n,"taskId"),a=this.extractFrontmatterField(n,"status"),o=this.extractFrontmatterField(n,"sourceFile");if(!s||!a||!o)return;let c=i.vault.getAbstractFileByPath(o);if(!c||!(c instanceof m.TFile))return;let r=this.statusToCheckbox(a,e),l=await i.vault.read(c),p=new RegExp(`\\[id::\\s*${s}\\]`),d=l.split(`
`);for(let k of d)if(p.test(k)){if(this.extractCheckboxMarker(k)===r)return;break}let h=this.updateTaskCheckbox(l,s,r);h!==l&&await i.vault.modify(c,h)},async syncStatusToTaskNote(i,t,e,n){if(!n.enableTaskStatusSync)return;let s=await this.findTaskNoteByTaskId(i,t,n);if(!s)return;let a=this.checkboxToStatus(e,n),o=await i.vault.read(s);if(this.extractFrontmatterField(o,"status")===a)return;let r=this.updateFrontmatterField(o,"status",a);r!==o&&await i.vault.modify(s,r)},async syncAllStatusesToTaskNotes(i,t,e){if(!e.enableTaskStatusSync)return;let s=(await i.vault.read(t)).split(`
`);for(let a of s){let o=g.extractId(a);if(!o||g.CALENDAR_EVENT_PATTERN.test(a))continue;let c=this.extractCheckboxMarker(a);c&&await this.syncStatusToTaskNote(i,o,c,e)}},async getSubtasksFromSource(i,t,e){if(!t)return[];let n=i.vault.getAbstractFileByPath(t);if(!n||!(n instanceof m.TFile))return[];let a=(await i.vault.read(n)).split(`
`),o=[],c=-1;for(let l=0;l<a.length;l++){let d=a[l].match(/^(\s*)- \[[ x]\]\s*(.+)$/);if(d&&this.cleanTaskText(d[2])===e){c=l;break}}if(c===-1)return[];let r=a[c].match(/^(\s*)/)[1].length;for(let l=c+1;l<a.length;l++){let p=a[l],d=p.match(/^(\s*)- \[([ x])\]\s*(.+)$/);if(!d){let k=p.match(/^(\s*)/);if(k&&k[1].length<=r&&p.trim()!=="")break;continue}if(d[1].length>r){let k=d[2]==="x",T=this.cleanTaskText(d[3]);T&&o.push({text:T,completed:k,originalLine:p})}else break}return o},async syncSubtasksToTaskNote(i,t,e,n){let s=await i.vault.read(t),a=s.match(/sourceFile:\s*"([^"]+)"/),o=a?a[1]:null,c=n&&o&&o!==n,r=s.match(/## Subtasks\n\n([\s\S]*?)(?=\n## |$)/);if(!r)return;let l=r[1],p=[],d=l.split(`
`);for(let w of d){let u=w.match(/^- \[([ x])\]\s*(.*)$/);u&&u[2].trim()&&p.push({text:u[2].trim(),completed:u[1]==="x"})}let h=[...p];for(let w of e)p.some(f=>f.text.toLowerCase()===w.text.toLowerCase())||h.push(w);let k=h.length>p.length,T=n&&(!o||c);if(k||T){let w=s;if(k){let u=h.map(f=>`- [${f.completed?"x":" "}] ${f.text}`).join(`
`);w=w.replace(/## Subtasks\n\n[\s\S]*?(?=\n## |$)/,`## Subtasks

${u}
`)}T&&(o?w=w.replace(/sourceFile:\s*"[^"]*"/,`sourceFile: "${n}"`):w=w.replace(/^---\n([\s\S]*?)---/,`---
$1sourceFile: "${n}"
---`)),await i.vault.modify(t,w),k&&new m.Notice(`Synced ${e.length} subtask(s) from source`)}},async syncSubtasksBackToSource(i,t,e){if(e)return!1;let n=await i.vault.read(t),s=n.match(/sourceFile:\s*"([^"]+)"/);if(!s||!s[1])return!1;let a=s[1],o=i.vault.getAbstractFileByPath(a);if(!o||!(o instanceof m.TFile))return!1;let c=n.match(/task:\s*"?([^"\n]+)"?/);if(!c)return!1;let r=c[1].replace(/\\"/g,'"'),l=n.match(/## Subtasks\n\n([\s\S]*?)(?=\n## |$)/);if(!l)return!1;let p=[],d=l[1].split(`
`);for(let x of d){let S=x.match(/^- \[([ x])\]\s*(.+)$/);S&&S[2].trim()&&p.push({text:S[2].trim(),completed:S[1]==="x"})}if(p.length===0)return!1;let h=await i.vault.read(o),k=h.split(`
`),T=-1,w=0;for(let x=0;x<k.length;x++){let N=k[x].match(/^(\s*)- \[[ x]\]\s*(.+)$/);if(N&&this.cleanTaskText(N[2])===r){T=x,w=N[1].length;break}}if(T===-1)return!1;let u=T;for(let x=T+1;x<k.length;x++){let S=k[x],N=S.match(/^(\s*)/),D=N?N[1].length:0;if(S.trim()!=="")if(D>w)u=x;else break}let f="	",b=p.map(x=>`${f}- [${x.completed?"x":" "}] ${x.text}`),v=k.slice(0,T+1),E=k.slice(u+1),y=[...v,...b,...E].join(`
`);return y!==h?(await i.vault.modify(o,y),!0):!1},async openOrCreateTaskNote(i,t,e,n,s=null){let a=this.sanitizeFilename(e);if(!a)return new m.Notice("Could not extract task name"),null;let o=t.taskNotesFolder,c=`${o}/${a}.md`;i.vault.getAbstractFileByPath(o)||await i.vault.createFolder(o);let l=await this.getSubtasksFromSource(i,n,e),p=" ";if(n&&s){let T=i.vault.getAbstractFileByPath(n);if(T instanceof m.TFile){let w=await i.vault.read(T),u=new RegExp(`\\[id::\\s*${s}\\]`),f=w.split(`
`);for(let b of f)if(u.test(b)){let v=this.extractCheckboxMarker(b);v&&(p=v);break}}}let d=this.checkboxToStatus(p,t),h=i.vault.getAbstractFileByPath(c),k=!h;if(h)h instanceof m.TFile&&await this.syncSubtasksToTaskNote(i,h,l,n);else{let T=l.length>0?l.map(f=>`- [${f.completed?"x":" "}] ${f.text}`).join(`
`):"- [ ] ",w=n?`[[${n.replace(/\.md$/,"")}]]`:"",u=`---
task: "${e.replace(/"/g,'\\"')}"
taskId: "${s||""}"
status: "${d}"
created: ${new Date().toISOString().split("T")[0]}
sourceFile: "${n||""}"
---

# ${e}

**Source:** ${w}

---

## Status
\`BUTTON[btn-incomplete, btn-progress, btn-cancelled, btn-complete]\`

## Notes


## Subtasks

${T}

## References


---
> [!meta]- Button Definitions
> \`\`\`meta-bind-button
> label: "\u25CB Incomplete"
> style: primary
> id: btn-incomplete
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-incomplete
> \`\`\`
>
> \`\`\`meta-bind-button
> label: "\u25D0 In Progress"
> style: default
> id: btn-progress
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-in-progress
> \`\`\`
>
> \`\`\`meta-bind-button
> label: "\u2715 Cancelled"
> style: default
> id: btn-cancelled
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-cancelled
> \`\`\`
>
> \`\`\`meta-bind-button
> label: "\u2713 Complete"
> style: default
> id: btn-complete
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-complete
> \`\`\`
`;h=await i.vault.create(c,u),new m.Notice(`Created: ${a}`)}return h instanceof m.TFile&&await i.workspace.getLeaf().openFile(h),h},async updateTaskNoteSourceFile(i,t,e,n,s){let a=this.sanitizeFilename(e);if(!a)return!1;let o=`${t.taskNotesFolder}/${a}.md`,c=i.vault.getAbstractFileByPath(o);if(!c||!(c instanceof m.TFile))return!1;let r=await i.vault.read(c),l=!1,p=/^(sourceFile:\s*")([^"]*)(")$/m,d=r.replace(p,`$1${n}$3`);d!==r&&(r=d,l=!0);let h=/^(scheduled:\s*)(\S+)$/m;if(h.test(r)){let u=r.replace(h,`$1${s}`);u!==r&&(r=u,l=!0)}else{let u=r.replace(/^(sourceFile:\s*"[^"]*")$/m,`$1
scheduled: ${s}`);u!==r?(r=u,l=!0):(r=r.replace(/^(---)$/m,`scheduled: ${s}
$1`),l=!0)}let k=`[[${n.replace(/\.md$/,"")}]]`,T=/^(\*\*Source:\*\*\s*)\[\[[^\]]+\]\]/m,w=r.replace(T,`$1${k}`);return w!==r&&(r=w,l=!0),l?(await i.vault.modify(c,r),!0):!1}},Z={sanitizeFilename(i){if(!i)return null;let t=i.replace(/^\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s*/,"");return t=t.replace(/https?:\/\/[^\s]+/g,""),t=t.replace(/[<>:"/\\|?*]/g,""),t=t.trim().substring(0,100),t||null},extractEventTitle(i){let t=i.replace(/^[\t]*- \[c\]\s*/,"");return t=t.replace(/^\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s*/,""),t=t.replace(/\s*\[uid::[^\]]+\]/g,""),t=t.replace(/\s*\[calendar::[^\]]+\]/g,""),t=t.replace(/\s*https?:\/\/[^\s]+/g,""),t.trim()},extractTimeRange(i){let t=i.match(/(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})/);return t?{start:t[1],end:t[2]}:null},async openOrCreateEventNote(i,t,e,n,s,a=null,o=null){var h;let c=this.sanitizeFilename(e);if(!c)return new m.Notice("Could not extract event name"),null;let r=t.eventNotesFolder,l=`${r}/${c}.md`;i.vault.getAbstractFileByPath(r)||await i.vault.createFolder(r);let d=i.vault.getAbstractFileByPath(l);if(!d){let k=s?`[[${s.replace(/\.md$/,"")}]]`:"",T=a?`${a.start} - ${a.end}`:"",w=s?(h=s.match(/(\d{4}-\d{2}-\d{2})/))==null?void 0:h[1]:new Date().toISOString().split("T")[0],u=`---
event: "${e.replace(/"/g,'\\"')}"
eventUID: "${n||""}"
calendar: "${o||""}"
date: ${w}
time: "${T}"
created: ${new Date().toISOString().split("T")[0]}
sourceFile: "${s||""}"
---

# ${e}

**Date:** ${w}${T?`  |  **Time:** ${T}`:""}
**Source:** ${k}

---

## Agenda


## Notes


## Action Items

- [ ]

## Follow-ups


`;d=await i.vault.create(l,u),new m.Notice(`Created: ${c}`)}return d instanceof m.TFile&&await i.workspace.getLeaf().openFile(d),d}},R={removeSchedulingTags(i){return i.replace(/\s*\[<\s*\d{4}-\d{2}-\d{2}\]/g,"").replace(/\s*\[>\s*\d{4}-\d{2}-\d{2}\]/g,"").replace(/\s*\[sch_from::[^\]]+\]/g,"").replace(/\s*\[sch_to::[^\]]+\]/g,"").replace(/\s*üìÖ\s*\[\[[^\]]+\]\]/g,"").replace(/\s*üìÖ\s*\d{4}-\d{2}-\d{2}/g,"")},getCurrentDate(){return new Date().toISOString().split("T")[0]},getDailyNotePath(i,t){return`${(t.targetFolders[0]||"00 - Daily/").replace(/\/$/,"")}/${i}.md`},createScheduledTaskCopy(i,t){let e=i.replace(/^([\t]*- \[)[^\]](\])/,"$1 $2");return e=this.removeSchedulingTags(e),e=e.replace(/\s*\[parent::\s*[^\]]+\]/g,""),e=e.trimEnd()+` [< ${t}]`,e},markTaskAsScheduled(i,t){let e=i.replace(/^([\t]*- \[)[^\]](\])/,"$1>$2");return e=e.replace(/^([\t]*- \[.\]\s*)\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/,"$1"),e=this.removeSchedulingTags(e),e=e.trimEnd()+` [> ${t}]`,e},async scheduleTask(i,t,e,n,s){let a=e.getLine(n);if(!g.isTask(a))return new m.Notice("Not a task line"),!1;if(a.includes(`[> ${s}]`))return new m.Notice("Task already scheduled to this date"),!1;let o=i.workspace.getActiveFile(),c=o?o.basename:this.getCurrentDate(),r=this.getDailyNotePath(s,t),l=i.vault.getAbstractFileByPath(r);if(!l){let u=r.substring(0,r.lastIndexOf("/"));i.vault.getAbstractFileByPath(u)||await i.vault.createFolder(u),l=await i.vault.create(r,""),new m.Notice(`Created daily note: ${s}`)}if(!(l instanceof m.TFile))return new m.Notice("Target is not a file"),!1;let p=g.extractId(a),d=await i.vault.read(l),h=!1;if(p&&(h=new RegExp(`\\[id::\\s*${p}\\]`).test(d)),h){let u=d.split(`
`),f=new RegExp(`\\[id::\\s*${p}\\]`);for(let b=0;b<u.length;b++)if(f.test(u[b])){let v=u[b];v=v.replace(/^([\t]*- \[)[^\]](\])/,"$1 $2"),v=this.removeSchedulingTags(v),v=v.trimEnd()+` [< ${c}]`,u[b]=v;break}d=u.join(`
`)}else{let u=this.createScheduledTaskCopy(a,c);d=d.trimEnd()+`
`+u}await i.vault.modify(l,d);let k=this.markTaskAsScheduled(a,s);e.setLine(n,k);let T=e.lineCount();for(let u=n+1;u<T;u++){let f=e.getLine(u);if(g.isSubtask(f)){let b=f.replace(/^([\t]*- \[)[^\]](\])/,"$1>$2");b!==f&&e.setLine(u,b)}else break}let w=I.extractTaskTextFromLine(a);return w&&await I.updateTaskNoteSourceFile(i,t,w,r,s),new m.Notice(`Task scheduled to ${s}`),!0}},X={INCOMPLETE_TASK_PATTERN:/^[\t]*- \[ \]/,isIncompleteTask(i){return this.INCOMPLETE_TASK_PATTERN.test(i)},parseDateFromFilename(i){let t=i.match(/^(\d{4})-(\d{2})-(\d{2})$/);return t?new Date(parseInt(t[1]),parseInt(t[2])-1,parseInt(t[3])):null},async getDailyNoteFiles(i,t){let e=[],n=t.targetFolders||["00 - Daily/"];for(let s of n){let a=s.replace(/\/$/,"");if(!i.vault.getAbstractFileByPath(a))continue;let c=i.vault.getMarkdownFiles();for(let r of c)if(r.path.startsWith(a+"/")&&r.path.endsWith(".md")){let l=this.parseDateFromFilename(r.basename);l&&e.push({file:r,date:l,basename:r.basename})}}return e},async findOverdueTasks(i,t,e){let n=await this.getDailyNoteFiles(i,t),s=[],a=e.getTime();for(let{file:o,date:c,basename:r}of n){if(c.getTime()>=a)continue;let p=(await i.vault.read(o)).split(`
`);for(let d=0;d<p.length;d++){let h=p[d];this.isIncompleteTask(h)&&!g.isCalendarEvent(h)&&s.push({file:o,fileDate:r,line:h,lineNum:d,taskId:g.extractId(h)})}}return s},async scheduleAllOverdueTo(i,t,e){let n=e.toISOString().split("T")[0],s=await this.findOverdueTasks(i,t,e);if(s.length===0)return new m.Notice("No overdue tasks found"),0;let a=0,o=new Map;for(let p of s)o.has(p.file.path)||o.set(p.file.path,[]),o.get(p.file.path).push(p);let c=R.getDailyNotePath(n,t),r=i.vault.getAbstractFileByPath(c);if(!r){let p=c.substring(0,c.lastIndexOf("/"));i.vault.getAbstractFileByPath(p)||await i.vault.createFolder(p),r=await i.vault.create(c,"")}if(!(r instanceof m.TFile))return new m.Notice("Could not access target daily note"),0;let l=await i.vault.read(r);for(let[p,d]of o){let h=i.vault.getAbstractFileByPath(p);if(!h||!(h instanceof m.TFile))continue;let k=await i.vault.read(h),T=k.split(`
`),w=h.basename,u=d.sort((f,b)=>b.lineNum-f.lineNum);for(let f of u){let b=T[f.lineNum];if(!b||!this.isIncompleteTask(b))continue;let v=g.extractId(b),E=!1;if(v&&(E=new RegExp(`\\[id::\\s*${v}\\]`).test(l)),E){let x=new RegExp(`\\[id::\\s*${v}\\]`),S=l.split(`
`);for(let N=0;N<S.length;N++)if(x.test(S[N])){let D=S[N];D=D.replace(/^([\t]*- \[)[^\]](\])/,"$1 $2"),D=R.removeSchedulingTags(D),D=D.trimEnd()+` [< ${w}]`,S[N]=D;break}l=S.join(`
`)}else{let x=R.createScheduledTaskCopy(b,w);l=l.trimEnd()+`
`+x}T[f.lineNum]=R.markTaskAsScheduled(b,n),a++;let y=I.extractTaskTextFromLine(b);y&&await I.updateTaskNoteSourceFile(i,t,y,c,n)}k=T.join(`
`),await i.vault.modify(h,k)}return await i.vault.modify(r,l),new m.Notice(`Scheduled ${a} overdue task(s) to ${n}`),a}},K={formatDate(i){return i.toISOString().split("T")[0]},getTomorrow(){let i=new Date;return i.setDate(i.getDate()+1),this.formatDate(i)},getDayAfterTomorrow(){let i=new Date;return i.setDate(i.getDate()+2),this.formatDate(i)},getNextMonday(){let i=new Date,t=i.getDay(),e=t===0?1:t===1?7:8-t;return i.setDate(i.getDate()+e),this.formatDate(i)},getOneWeekFromNow(){let i=new Date;return i.setDate(i.getDate()+7),this.formatDate(i)},parseCustomDate(i){if(!i)return null;let t=i.trim();return/^\d{4}-\d{2}-\d{2}$/.test(t)?t:/^\d{8}$/.test(t)?`${t.slice(0,4)}-${t.slice(4,6)}-${t.slice(6,8)}`:null}},Q=[{id:"tomorrow",label:"Tomorrow",getDate:()=>K.getTomorrow()},{id:"day-after",label:"Day After Tomorrow",getDate:()=>K.getDayAfterTomorrow()},{id:"next-monday",label:"Next Monday",getDate:()=>K.getNextMonday()},{id:"one-week",label:"In One Week",getDate:()=>K.getOneWeekFromNow()},{id:"custom",label:"Enter a date...",isCustom:!0}],A={check:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>',halfCircle:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M448 256c0-106-86-192-192-192V448c106 0 192-86 192-192zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z"/></svg>',ban:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M367.2 412.5L99.5 144.8C77.1 176.1 64 214.5 64 256c0 106 86 192 192 192c41.5 0 79.9-13.1 111.2-35.5zm45.3-45.3C434.9 335.9 448 297.5 448 256c0-106-86-192-192-192c-41.5 0-79.9 13.1-111.2 35.5L412.5 367.2zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z"/></svg>',anglesRight:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M470.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 256 265.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160zm-352 160l160-160c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L210.7 256 73.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0z"/></svg>',fileLines:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM112 256H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16z"/></svg>',clock:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M464 256A208 208 0 1 1 48 256a208 208 0 1 1 416 0zM0 256a256 256 0 1 0 512 0A256 256 0 1 0 0 256zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/></svg>',circleRight:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M0 256a256 256 0 1 0 512 0A256 256 0 1 0 0 256zM294.6 135.1l99.9 107.1c3.5 3.8 5.5 8.7 5.5 13.8s-2 10.1-5.5 13.8L294.6 376.9c-4.2 4.5-10.1 7.1-16.3 7.1C266 384 256 374 256 361.7l0-57.7-96 0c-17.7 0-32-14.3-32-32l0-32c0-17.7 14.3-32 32-32l96 0 0-57.7c0-12.3 10-22.3 22.3-22.3c6.2 0 12.1 2.6 16.3 7.1z"/></svg>'},F={extractTimeblock(i){let t=i.match(/^([\t]*- \[.\]\s*)(\d{2}):(\d{2})\s*-\s*(\d{2}):(\d{2})\s*/);return t?{prefix:t[1],startHour:parseInt(t[2]),startMinute:parseInt(t[3]),endHour:parseInt(t[4]),endMinute:parseInt(t[5]),fullMatch:t[0]}:null},formatTime(i,t){return`${i.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},formatDisplayTime(i){let t=e=>e.toString().padStart(2,"0");return i===0?"12 AM":i===12?"12 PM":i<12?`${t(i)} AM`:`${t(i-12)} PM`},addTimeblock(i,t,e,n,s){let a=this.extractTimeblock(i),o=`${this.formatTime(t,e)} - ${this.formatTime(n,s)} `;return a?i.replace(a.fullMatch,a.prefix+o):i.replace(/^([\t]*- \[.\]\s*)/,`$1${o}`)},removeTimeblock(i){return i.replace(/^([\t]*- \[.\]\s*)\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s*/,"$1")},getDefaultEndTime(i,t){let e=t+30,n=i;return e>=60&&(e-=60,n=(n+1)%24),{hour:n,minute:e}}},L=class i{constructor(t,e,n,s,a=null,o=null){this.plugin=t,this.editor=e,this.lineNum=n,this.mode=s,this.existingStart=a,this.onComplete=o,this.selectedHour=null,this.expandedHour=null,this.container=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleClickOutside=this.handleClickOutside.bind(this)}open(){this.container=document.createElement("div"),this.container.className="timeblock-picker-popup",this.render(),this.positionPopup(),document.body.appendChild(this.container),document.addEventListener("keydown",this.handleKeyDown,!0),setTimeout(()=>{document.addEventListener("click",this.handleClickOutside)},10)}close(){this.container&&(this.container.remove(),this.container=null),document.removeEventListener("keydown",this.handleKeyDown,!0),document.removeEventListener("click",this.handleClickOutside)}render(){this.container.empty();let t=document.createElement("div");if(t.className="timeblock-picker-header",t.textContent=this.mode==="start"?"Start":"End",this.container.appendChild(t),this.mode==="end"&&this.existingStart){let a=document.createElement("div");a.className="timeblock-picker-start-info",a.textContent=`Start: ${F.formatTime(this.existingStart.hour,this.existingStart.minute)}`,this.container.appendChild(a)}let e=document.createElement("div");e.className="timeblock-picker-columns";let n=this.createColumn("DAY",6,17);e.appendChild(n);let s=this.createColumn("NIGHT",18,29);e.appendChild(s),this.container.appendChild(e)}createColumn(t,e,n){let s=document.createElement("div");s.className="timeblock-picker-column";let a=document.createElement("div");a.className="timeblock-picker-column-header",a.textContent=t,s.appendChild(a);for(let o=e;o<=n;o++){let c=o%24,r=this.createHourRow(c);s.appendChild(r)}return s}createHourRow(t){let e=document.createElement("div");e.className="timeblock-picker-row",this.expandedHour===t&&e.addClass("is-expanded");let s=null;if(this.mode==="end"&&this.existingStart){let c=F.getDefaultEndTime(this.existingStart.hour,this.existingStart.minute);t===c.hour&&(e.addClass("is-suggested"),s=c.minute)}let a=document.createElement("div");a.className="timeblock-picker-hour",a.textContent=F.formatDisplayTime(t),a.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),this.handleHourClick(t)}),e.appendChild(a);let o=document.createElement("div");o.className="timeblock-picker-row-minutes";for(let c of[0,15,30,45]){let r=document.createElement("button");r.className="timeblock-picker-minute-btn",s===c&&r.addClass("is-suggested"),r.textContent=c.toString().padStart(2,"0"),r.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.selectTime(t,c)}),o.appendChild(r)}return e.appendChild(o),e}handleHourClick(t){if(this.expandedHour===t){this.selectTime(t,0);return}this.expandedHour=t,this.render()}selectTime(t,e){this.selectedHour=t,this.close(),this.mode==="start"?new i(this.plugin,this.editor,this.lineNum,"end",{hour:t,minute:e},(s,a)=>{this.applyTimeblock(t,e,s,a)}).open():this.mode==="end"&&this.onComplete&&this.onComplete(t,e)}applyTimeblock(t,e,n,s){let a=this.editor.getLine(this.lineNum),o=F.addTimeblock(a,t,e,n,s);this.editor.setLine(this.lineNum,o),new m.Notice(`Timeblock set: ${F.formatTime(t,e)} - ${F.formatTime(n,s)}`)}positionPopup(){let t=this.plugin.app.workspace.getActiveViewOfType(m.MarkdownView);if(!t)return;let e=t.editor.cm;if(!e)return;let n=this.editor.getCursor(),s=e.coordsAtPos(e.state.doc.line(n.line+1).from);s&&(this.container.style.position="absolute",this.container.style.left=`${s.left}px`,this.container.style.top=`${s.bottom+5}px`,this.container.style.zIndex="1000")}handleKeyDown(t){t.key==="Escape"&&(t.preventDefault(),t.stopPropagation(),this.close())}handleClickOutside(t){this.container&&!this.container.contains(t.target)&&this.close()}},tt=class extends m.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,n){let s=e.getLine(t.line);if(!g.isTask(s))return null;let a=s.substring(0,t.ch),o=a.lastIndexOf("^");if(o===-1||o===0||a.substring(0,o).endsWith("^"))return null;let r={line:t.line,ch:o},l=t;e.replaceRange("",r,l);let p=F.extractTimeblock(s);return new L(this.plugin,e,t.line,"start").open(),null}getSuggestions(t){return[]}renderSuggestion(t,e){}selectSuggestion(t,e){}},xt=[{id:"complete",label:"Mark Complete",icon:A.check,marker:"x"},{id:"in-progress",label:"Mark In Progress",icon:A.halfCircle,marker:"/"},{id:"cancelled",label:"Mark Cancelled",icon:A.ban,marker:"-"},{id:"schedule",label:"Schedule Task",icon:A.anglesRight,action:"schedule"},{id:"timeblock",label:"Set Time Block",icon:A.clock,action:"timeblock"}],et=class extends m.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,n){let s=e.getLine(t.line);if(!g.isTask(s))return null;let a=s.substring(0,t.ch),o=a.lastIndexOf("/");if(o===-1)return null;let c=a.substring(0,o);return/\d$/.test(c)?null:{start:{line:t.line,ch:o},end:t,query:a.substring(o+1).toLowerCase()}}getSuggestions(t){let e=t.query.toLowerCase();return xt.filter(n=>n.label.toLowerCase().includes(e)||n.id.includes(e))}renderSuggestion(t,e){e.addClass("slash-command-item");let n=e.createSpan({cls:"slash-command-icon"});n.innerHTML=t.icon,e.createSpan({text:t.label,cls:"slash-command-label"})}selectSuggestion(t,e){let{editor:n}=this.context,s=this.context.start.line,a=n.getLine(s);n.replaceRange("",this.context.start,this.context.end);let o=n.getLine(s);if(t.marker){let c=o.replace(/^([\t]*- \[)[^\]](\])/,`$1${t.marker}$2`);n.setLine(s,c)}else t.action==="schedule"?this.openSchedulePopup(n,s):t.action==="timeblock"&&this.openTimeBlockPopup(n,s)}openSchedulePopup(t,e){new O(this.plugin,t,e).open()}openTimeBlockPopup(t,e){new L(this.plugin,t,e,"start").open()}},st=class extends m.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,n){let s=e.getLine(t.line);if(!g.isTask(s))return null;let a=s.substring(0,t.ch),o=a.lastIndexOf(">");if(o===-1||o===0)return null;let c=a.substring(0,o);if(c.endsWith(">")||c.endsWith("["))return null;let r={line:t.line,ch:o},l=t;return e.replaceRange("",r,l),new O(this.plugin,e,t.line).open(),null}getSuggestions(t){return[]}renderSuggestion(t,e){}selectSuggestion(t,e){}},O=class{constructor(t,e,n){this.plugin=t,this.editor=e,this.lineNum=n,this.selectedIndex=0,this.isCustomMode=!1,this.container=null,this.customInput=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleClickOutside=this.handleClickOutside.bind(this)}open(){this.container=document.createElement("div"),this.container.className="schedule-date-popup",this.renderOptions(),this.positionPopup(),document.body.appendChild(this.container),document.addEventListener("keydown",this.handleKeyDown,!0),setTimeout(()=>{document.addEventListener("click",this.handleClickOutside)},10)}close(){this.container&&(this.container.remove(),this.container=null),document.removeEventListener("keydown",this.handleKeyDown,!0),document.removeEventListener("click",this.handleClickOutside)}renderOptions(){this.container.empty(),Q.forEach((t,e)=>{let n=document.createElement("div");n.className="schedule-date-option",e===this.selectedIndex&&n.addClass("is-selected"),t.isCustom&&this.isCustomMode?(this.customInput=document.createElement("input"),this.customInput.type="text",this.customInput.className="schedule-date-custom-input",this.customInput.placeholder="YYYY-MM-DD",this.customInput.addEventListener("keydown",s=>{s.key==="Enter"?(s.preventDefault(),s.stopPropagation(),this.submitCustomDate()):s.key==="Escape"&&(s.preventDefault(),s.stopPropagation(),this.close())}),n.appendChild(this.customInput),setTimeout(()=>this.customInput.focus(),0)):(n.createSpan({text:t.label,cls:"schedule-date-label"}),t.getDate&&n.createSpan({text:t.getDate(),cls:"schedule-date-value"})),n.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.selectedIndex=e,this.selectOption(t)}),this.container.appendChild(n)})}positionPopup(){let t=this.plugin.app.workspace.getActiveViewOfType(m.MarkdownView);if(!t)return;let e=t.editor.cm;if(!e)return;let n=this.editor.getCursor(),s=e.coordsAtPos(e.state.doc.line(n.line+1).from);s&&(this.container.style.position="absolute",this.container.style.left=`${s.left}px`,this.container.style.top=`${s.bottom+5}px`,this.container.style.zIndex="1000")}handleKeyDown(t){if(this.isCustomMode&&this.customInput&&document.activeElement===this.customInput){t.key==="Escape"&&(t.preventDefault(),t.stopPropagation(),this.close());return}switch(t.key){case"ArrowDown":t.preventDefault(),t.stopPropagation(),this.selectedIndex=Math.min(this.selectedIndex+1,Q.length-1),this.renderOptions();break;case"ArrowUp":t.preventDefault(),t.stopPropagation(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.renderOptions();break;case"Enter":t.preventDefault(),t.stopPropagation(),this.selectOption(Q[this.selectedIndex]);break;case"Escape":t.preventDefault(),t.stopPropagation(),this.close();break}}handleClickOutside(t){this.container&&!this.container.contains(t.target)&&this.close()}selectOption(t){t.isCustom?this.isCustomMode||(this.isCustomMode=!0,this.renderOptions()):t.getDate&&this.scheduleToDate(t.getDate())}submitCustomDate(){if(!this.customInput)return;let t=K.parseCustomDate(this.customInput.value);t?this.scheduleToDate(t):new m.Notice("Invalid date format. Use YYYY-MM-DD or YYYYMMDD")}async scheduleToDate(t){this.close(),await R.scheduleTask(this.plugin.app,this.plugin.settings,this.editor,this.lineNum,t)}},nt=class extends O{constructor(t,e,n,s){super(t,e,n),this.anchorEl=s}positionPopup(){if(!this.anchorEl)return;let t=this.anchorEl.getBoundingClientRect();this.container.style.position="absolute",this.container.style.left=`${t.left}px`,this.container.style.top=`${t.bottom+5}px`,this.container.style.zIndex="1000",requestAnimationFrame(()=>{let e=this.container.getBoundingClientRect();e.right>window.innerWidth&&(this.container.style.left=`${window.innerWidth-e.width-10}px`),e.bottom>window.innerHeight&&(this.container.style.top=`${t.top-e.height-5}px`)})}},it=class i extends L{constructor(t,e,n,s,a,o,c){super(t,e,n,s,a,o),this.anchorEl=c}positionPopup(){if(!this.anchorEl)return;let t=this.anchorEl.getBoundingClientRect();this.container.style.position="absolute",this.container.style.left=`${t.left}px`,this.container.style.top=`${t.bottom+5}px`,this.container.style.zIndex="1000",requestAnimationFrame(()=>{let e=this.container.getBoundingClientRect();e.right>window.innerWidth&&(this.container.style.left=`${window.innerWidth-e.width-10}px`),e.bottom>window.innerHeight&&(this.container.style.top=`${t.top-e.height-5}px`)})}selectTime(t,e){this.selectedHour=t,this.close(),this.mode==="start"?new i(this.plugin,this.editor,this.lineNum,"end",{hour:t,minute:e},(s,a)=>{this.applyTimeblock(t,e,s,a)},this.anchorEl).open():this.mode==="end"&&this.onComplete&&this.onComplete(t,e)}},at=class extends wt{constructor(t,e){super(),this.options=t,this.plugin=e}toDOM(){let t=document.createElement("span");if(t.className="task-decorations-container",this.options.showNotesButton&&this.options.taskText){let e=document.createElement("span");e.className="task-note-button";let n=document.createElement("span");n.className="task-note-button-icon",n.innerHTML=A.fileLines,e.appendChild(n),e.appendChild(document.createTextNode("notes")),e.setAttribute("aria-label",this.options.isCalendarEvent?"Open event note":"Open task note"),e.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation();let a=this.plugin.app.workspace.getActiveFile(),o=a?a.path:null;this.options.isCalendarEvent?await Z.openOrCreateEventNote(this.plugin.app,this.plugin.settings,this.options.taskText,this.options.uid,o,this.options.eventTimeRange,this.options.calendarSource):await I.openOrCreateTaskNote(this.plugin.app,this.plugin.settings,this.options.taskText,o,this.options.taskId)}),t.appendChild(e)}if(this.options.scheduleToDates)for(let e of this.options.scheduleToDates){let n=document.createElement("span");n.className="schedule-pill schedule-pill-to",n.textContent=`\u2192 ${e}`,n.setAttribute("aria-label",`Go to ${e}`),n.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation(),await this.navigateToDate(e)}),t.appendChild(n)}if(this.options.scheduleFromDates)for(let e of this.options.scheduleFromDates){let n=document.createElement("span");n.className="schedule-pill schedule-pill-from",n.textContent=`\u2190 ${e}`,n.setAttribute("aria-label",`Go to ${e}`),n.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation(),await this.navigateToDate(e)}),t.appendChild(n)}if(this.options.showInfoButton&&(this.options.taskId||this.options.parentId||this.options.uid)){let e=document.createElement("span");e.className="task-info-button",e.textContent="\u24D8",e.title=this.options.isCalendarEvent?"Event info":"Task info",e.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),this.plugin.showTaskInfo(this.options.taskId,this.options.parentId,this.options.taskText,null,null,this.options.uid,this.options.isCalendarEvent,this.options.calendarSource)}),t.appendChild(e)}if(!this.options.isCalendarEvent){let e=document.createElement("span");e.className="task-action-button task-schedule-button";let n=document.createElement("span");n.className="task-action-button-icon",n.innerHTML=A.circleRight,e.appendChild(n),e.title="Schedule task",e.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.plugin.showSchedulePopupFromWidget(e,this.options.lineNum)}),t.appendChild(e)}if(!this.options.isCalendarEvent){let e=document.createElement("span");e.className="task-action-button task-timeblock-button";let n=document.createElement("span");n.className="task-action-button-icon",n.innerHTML=A.clock,e.appendChild(n),e.title="Set time block",e.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.plugin.showTimeblockPickerFromWidget(e,this.options.lineNum)}),t.appendChild(e)}return t}async navigateToDate(t){let e=R.getDailyNotePath(t,this.plugin.settings),n=this.plugin.app.vault.getAbstractFileByPath(e);n||(n=await this.plugin.app.vault.create(e,"")),n instanceof m.TFile&&await this.plugin.app.workspace.getLeaf().openFile(n)}eq(t){return t.options.taskText===this.options.taskText&&t.options.taskId===this.options.taskId&&t.options.parentId===this.options.parentId&&t.options.uid===this.options.uid&&t.options.calendarSource===this.options.calendarSource&&t.options.isCalendarEvent===this.options.isCalendarEvent&&JSON.stringify(t.options.eventTimeRange)===JSON.stringify(this.options.eventTimeRange)&&JSON.stringify(t.options.scheduleToDates)===JSON.stringify(this.options.scheduleToDates)&&JSON.stringify(t.options.scheduleFromDates)===JSON.stringify(this.options.scheduleFromDates)&&t.options.showInfoButton===this.options.showInfoButton&&t.options.showNotesButton===this.options.showNotesButton&&t.options.lineNum===this.options.lineNum}ignoreEvent(){return!1}};var ot=class extends m.Modal{constructor(t,e,n,s,a,o,c,r,l){super(t),this.taskId=e,this.parentId=n,this.taskText=s,this.parentText=a,this.onUnlink=o,this.uid=c,this.isCalendarEvent=r,this.calendarSource=l}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("task-info-modal"),t.createEl("h3",{text:this.isCalendarEvent?"Event Information":"Task Information"});let e=t.createDiv({cls:"task-info-content"});if(this.isCalendarEvent&&this.uid){if(this.taskText){let a=e.createDiv({cls:"task-info-row"});a.createSpan({text:"Event: ",cls:"task-info-label"}),a.createSpan({text:this.taskText,cls:"task-info-value task-info-name"})}if(this.calendarSource){let a=e.createDiv({cls:"task-info-row"});a.createSpan({text:"Calendar: ",cls:"task-info-label"}),a.createSpan({text:this.calendarSource,cls:"task-info-value task-info-name"})}let n=e.createDiv({cls:"task-info-row"});n.createSpan({text:"Event UID: ",cls:"task-info-label"}),n.createSpan({text:this.uid,cls:"task-info-value"}),e.createDiv({cls:"task-info-row"}).createSpan({text:"Calendar events sync from ICS and are read-only",cls:"task-info-note"})}else if(this.taskId){if(this.taskText){let s=e.createDiv({cls:"task-info-row"});s.createSpan({text:"Task: ",cls:"task-info-label"}),s.createSpan({text:this.taskText,cls:"task-info-value task-info-name"})}let n=e.createDiv({cls:"task-info-row"});n.createSpan({text:"Task ID: ",cls:"task-info-label"}),n.createSpan({text:this.taskId,cls:"task-info-value"})}if(this.parentId){if(this.parentText){let a=e.createDiv({cls:"task-info-row"});a.createSpan({text:"Parent: ",cls:"task-info-label"}),a.createSpan({text:this.parentText,cls:"task-info-value task-info-name"})}let n=e.createDiv({cls:"task-info-row"});n.createSpan({text:"Parent ID: ",cls:"task-info-label"}),n.createSpan({text:this.parentId,cls:"task-info-value"}),t.createEl("button",{text:"Unlink from Parent",cls:"task-unlink-btn"}).addEventListener("click",()=>{this.onUnlink(),this.close()})}else this.taskId&&e.createDiv({cls:"task-info-row"}).createSpan({text:"This is a parent task (no parent link)",cls:"task-info-note"})}onClose(){let{contentEl:t}=this;t.empty()}};var rt=class extends m.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Task Manager Settings"}),t.createEl("h3",{text:"Scope"}),new m.Setting(t).setName("Target folders").setDesc('Comma-separated list of folder paths to process (e.g., "00 - Daily/, 01 - Projects/")').addText(e=>e.setPlaceholder("00 - Daily/").setValue(this.plugin.settings.targetFolders.join(", ")).onChange(async n=>{this.plugin.settings.targetFolders=n.split(",").map(s=>s.trim()).filter(s=>s),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Task IDs"}),new m.Setting(t).setName("Enable task IDs").setDesc("Automatically assign unique IDs to all tasks").addToggle(e=>e.setValue(this.plugin.settings.enableTaskIds).onChange(async n=>{this.plugin.settings.enableTaskIds=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("ID prefix").setDesc("Prefix for generated task IDs").addText(e=>e.setPlaceholder("t-").setValue(this.plugin.settings.idPrefix).onChange(async n=>{this.plugin.settings.idPrefix=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("ID length").setDesc("Number of random characters in task IDs").addText(e=>e.setPlaceholder("8").setValue(String(this.plugin.settings.idLength)).onChange(async n=>{let s=parseInt(n);!isNaN(s)&&s>0&&(this.plugin.settings.idLength=s,await this.plugin.saveSettings())})),t.createEl("h3",{text:"Parent-Child Linking"}),new m.Setting(t).setName("Enable parent-child linking").setDesc("Automatically link subtasks to their parent tasks").addToggle(e=>e.setValue(this.plugin.settings.enableParentChildLinking).onChange(async n=>{this.plugin.settings.enableParentChildLinking=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Preserve existing parent links").setDesc("Do not overwrite existing parent links when subtasks are moved").addToggle(e=>e.setValue(this.plugin.settings.preserveExistingParentLinks).onChange(async n=>{this.plugin.settings.preserveExistingParentLinks=n,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Sorting"}),new m.Setting(t).setName("Enable auto-sort").setDesc("Automatically sort tasks by time when file is modified").addToggle(e=>e.setValue(this.plugin.settings.enableAutoSort).onChange(async n=>{this.plugin.settings.enableAutoSort=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Sort debounce delay").setDesc("Milliseconds to wait after last edit before sorting").addText(e=>e.setPlaceholder("500").setValue(String(this.plugin.settings.sortDebounceMs)).onChange(async n=>{let s=parseInt(n);!isNaN(s)&&s>=0&&(this.plugin.settings.sortDebounceMs=s,await this.plugin.saveSettings())})),new m.Setting(t).setName("Tasks without time position").setDesc("Where to place tasks that do not have a timeblock").addDropdown(e=>e.addOption("end","End of list").addOption("start","Start of list").setValue(this.plugin.settings.tasksWithoutTimePosition).onChange(async n=>{this.plugin.settings.tasksWithoutTimePosition=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Auto-archive completed tasks").setDesc("Move completed, scheduled, and cancelled tasks to a collapsed section").addToggle(e=>e.setValue(this.plugin.settings.enableAutoArchive).onChange(async n=>{this.plugin.settings.enableAutoArchive=n,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Task Status Sync"}),new m.Setting(t).setName("Enable status sync").setDesc("Sync task status between task notes and daily notes bidirectionally").addToggle(e=>e.setValue(this.plugin.settings.enableTaskStatusSync).onChange(async n=>{this.plugin.settings.enableTaskStatusSync=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Status mappings").setDesc("Checkbox marker \u2192 status name mappings (JSON format)").addTextArea(e=>{e.inputEl.rows=8,e.inputEl.cols=40,e.setValue(JSON.stringify(this.plugin.settings.statusMappings,null,2)).onChange(async n=>{try{let s=JSON.parse(n);this.plugin.settings.statusMappings=s,await this.plugin.saveSettings()}catch(s){}})}),t.createEl("h3",{text:"Display"}),new m.Setting(t).setName("Show info button").setDesc("Display info button (i) on tasks to view metadata").addToggle(e=>e.setValue(this.plugin.settings.showInfoButton).onChange(async n=>{this.plugin.settings.showInfoButton=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Hide metadata fields").setDesc("Hide [id::...] and [parent::...] fields in the editor").addToggle(e=>e.setValue(this.plugin.settings.hideMetadataFields).onChange(async n=>{this.plugin.settings.hideMetadataFields=n,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Task Notes"}),new m.Setting(t).setName("Enable task notes").setDesc('Show "notes" button on parent tasks to create/open dedicated task notes').addToggle(e=>e.setValue(this.plugin.settings.enableTaskNotes).onChange(async n=>{this.plugin.settings.enableTaskNotes=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Task notes folder").setDesc("Folder where task notes will be created").addText(e=>e.setPlaceholder("Task Notes").setValue(this.plugin.settings.taskNotesFolder).onChange(async n=>{this.plugin.settings.taskNotesFolder=n.trim()||"Task Notes",await this.plugin.saveSettings()})),t.createEl("h3",{text:"Event Notes"}),new m.Setting(t).setName("Enable event notes").setDesc('Show "notes" button on calendar events to create/open dedicated event notes with eventUID in frontmatter').addToggle(e=>e.setValue(this.plugin.settings.enableEventNotes).onChange(async n=>{this.plugin.settings.enableEventNotes=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Event notes folder").setDesc("Folder where event notes will be created").addText(e=>e.setPlaceholder("Event Notes").setValue(this.plugin.settings.eventNotesFolder).onChange(async n=>{this.plugin.settings.eventNotesFolder=n.trim()||"Event Notes",await this.plugin.saveSettings()})),t.createEl("h3",{text:"Calendar Sync"}),new m.Setting(t).setName("Enable ICS calendar sync").setDesc("Automatically sync calendar events from ICS plugin when opening daily notes. Events use [c] checkbox and are read-only.").addToggle(e=>e.setValue(this.plugin.settings.enableIcsSync).onChange(async n=>{this.plugin.settings.enableIcsSync=n,await this.plugin.saveSettings()}))}},ct=class extends m.Plugin{async onload(){console.log("Task Manager: loaded"),await this.loadSettings();let t=this;this.isProcessing=!1;let e=lt.fromClass(class{constructor(s){this.decorations=this.buildDecorations(s,t)}update(s){(s.docChanged||s.viewportChanged)&&(this.decorations=this.buildDecorations(s.view,t))}buildDecorations(s,a){let o=[],c=g.TASK_PATTERN,r=g.PARENT_TASK_PATTERN,l=/\s*\[(?:id|parent|uid|calendar)::\s*[^\]]+\]/g,p=/^([\t]*- \[.\]\s*)(\d{2}:\d{2}\s*-\s*\d{2}:\d{2})/,d=/\s*\[>\s*(\d{4}-\d{2}-\d{2})\]/g,h=/\s*\[<\s*(\d{4}-\d{2}-\d{2})\]/g,k=/\s*\[sch_to::([^\]]+)\]/g,T=/\s*\[sch_from::([^\]]+)\]/g,w=a.app.workspace.getActiveFile(),u=w&&w.path.startsWith(a.settings.taskNotesFolder+"/");for(let{from:b,to:v}of s.visibleRanges)for(let E=b;E<v;){let y=s.state.doc.lineAt(E),x=y.text;if(c.test(x)){let S=g.extractId(x),N=g.extractParentId(x),D=r.test(x),q=x.match(p);if(q){let C=y.from+q[1].length,P=C+q[2].length;o.push({from:C,to:P,value:$.mark({class:"timeblock-pill",attributes:{"data-line":String(y.number-1)}})})}let B=[],V=[];if(a.settings.hideMetadataFields){let C;for(l.lastIndex=0;(C=l.exec(x))!==null;){let P=y.from+C.index,Tt=P+C[0].length;o.push({from:P,to:Tt,value:$.replace({})})}}let H;for(d.lastIndex=0;(H=d.exec(x))!==null;){let C=y.from+H.index,P=C+H[0].length;B.push(H[1]),o.push({from:C,to:P,value:$.replace({})})}let U;for(h.lastIndex=0;(U=h.exec(x))!==null;){let C=y.from+U.index,P=C+U[0].length;V.push(U[1]),o.push({from:C,to:P,value:$.replace({})})}let z;for(k.lastIndex=0;(z=k.exec(x))!==null;){let C=y.from+z.index,P=C+z[0].length;B.push(z[1]),o.push({from:C,to:P,value:$.replace({})})}let W;for(T.lastIndex=0;(W=T.exec(x))!==null;){let C=y.from+W.index,P=C+W[0].length;V.push(W[1]),o.push({from:C,to:P,value:$.replace({})})}let M=g.isCalendarEvent(x),Y=M?j.extractUid(x):null,ht=M?j.extractCalendar(x):null,_=M?Z.extractEventTitle(x):I.extractTaskTextFromLine(x),pt=M?Z.extractTimeRange(x):null,gt=a.settings.enableTaskNotes&&D&&!u&&_&&_.trim()!=="",mt=a.settings.enableEventNotes&&M&&Y&&_&&_.trim()!=="",ft=gt||mt,kt=a.settings.showInfoButton&&(S||N||Y),yt=B.length>0||V.length>0;o.push({from:y.to,to:y.to,value:$.widget({widget:new at({taskText:_,taskId:S,parentId:N,uid:Y,calendarSource:ht,isCalendarEvent:M,eventTimeRange:pt,scheduleToDates:B.length>0?B:null,scheduleFromDates:V.length>0?V:null,showInfoButton:kt,showNotesButton:ft,lineNum:y.number},a),side:1})})}E=y.to+1}o.sort((b,v)=>b.from-v.from||b.to-v.to);let f=new vt;for(let b of o)f.add(b.from,b.to,b.value);return f.finish()}},{decorations:s=>s.decorations});this.registerEditorExtension([e]),this.registerEditorSuggest(new et(this.app,this)),this.registerEditorSuggest(new st(this.app,this)),this.registerEditorSuggest(new tt(this.app,this)),this.taskNoteSyncing=!1,this.taskNoteSyncTimers=new Map,this.lastCursorLine=-1;let n=lt.fromClass(class{constructor(s){this.plugin=t,this.lastLine=-1}update(s){if(!s.selectionSet)return;let a=s.state.doc.lineAt(s.state.selection.main.head).number-1;if(this.lastLine!==-1&&this.lastLine!==a){let o=this.lastLine;setTimeout(()=>this.plugin.processLineOnLeave(o),0)}this.lastLine=a}});this.registerEditorExtension([n]),this.registerDomEvent(document,"click",s=>{let a=s.target;if(a.matches('input[data-task="c"], .task-list-item-checkbox[data-task="c"]')||a.closest('li[data-task="c"]')&&a.matches('input[type="checkbox"]'))return s.preventDefault(),s.stopPropagation(),!1},!0),this.registerDomEvent(document,"click",s=>{let o=s.target.closest(".timeblock-pill");if(!o)return;s.preventDefault(),s.stopPropagation();let c=parseInt(o.dataset.line,10);if(isNaN(c))return;let r=this.app.workspace.getActiveViewOfType(m.MarkdownView);if(!r||!r.editor)return;let l=r.editor;new L(this,l,c,"start").open()}),this.registerEvent(this.app.vault.on("modify",s=>{if(!this.isProcessing&&this.settings.enableTaskNotes&&s.path.startsWith(this.settings.taskNotesFolder+"/")){this.taskNoteSyncing||(this.taskNoteSyncTimers.has(s.path)&&clearTimeout(this.taskNoteSyncTimers.get(s.path)),this.taskNoteSyncTimers.set(s.path,setTimeout(async()=>{this.taskNoteSyncTimers.delete(s.path),this.taskNoteSyncing=!0;try{await I.syncSubtasksBackToSource(this.app,s,!1),await I.syncStatusToSource(this.app,s,this.settings)}finally{setTimeout(()=>{this.taskNoteSyncing=!1},100)}},500)));return}})),this.registerEvent(this.app.workspace.on("file-open",async s=>{if(!(!s||!this.settings.enableIcsSync||this.isProcessing||!j.getDailyNoteDate(s,this.settings))){this.isProcessing=!0;try{await j.syncEventsToNote(this.app,s,this.settings)&&console.log("Task Manager: Synced ICS events to",s.path)}catch(o){console.error("Task Manager: Error syncing ICS events",o)}finally{setTimeout(()=>{this.isProcessing=!1},100)}}})),this.addCommand({id:"assign-task-ids",name:"Assign IDs to all tasks in current file",editorCallback:(s,a)=>{let o=s.getValue(),c=G.processContent(o,this.settings);o!==c&&s.setValue(c)}}),this.addCommand({id:"link-parent-child",name:"Link subtasks to parent tasks in current file",editorCallback:(s,a)=>{let o=s.getValue();o=G.processContent(o,this.settings);let c=dt.linkContent(o,this.settings);s.getValue()!==c&&s.setValue(c)}}),this.addCommand({id:"unlink-from-parent",name:"Unlink task from parent",editorCallback:(s,a)=>{let o=s.getCursor(),c=s.getLine(o.line);if(g.extractParentId(c)){let r=g.removeParentId(c);s.setLine(o.line,r),new m.Notice("Task unlinked from parent")}else new m.Notice("This task has no parent link")}}),this.addCommand({id:"sort-tasks",name:"Sort tasks chronologically in current file",editorCallback:(s,a)=>{let o=s.getValue(),c=J.sortContent(o,this.settings);o!==c&&s.setValue(c)}}),this.addCommand({id:"sort-by-time-block",name:"Sort all items by time block",editorCallback:(s,a)=>{let o=s.getValue(),c=J.sortByTimeBlock(o,this.settings);o!==c&&s.setValue(c)}}),this.addCommand({id:"show-task-info",name:"Show task info for current line",editorCallback:(s,a)=>{let o=s.getCursor(),c=s.getLine(o.line),r=g.extractId(c),l=g.extractParentId(c),p=I.extractTaskTextFromLine(c);r||l?this.showTaskInfo(r,l,p,s,o.line):new m.Notice("No task metadata on this line")}}),this.addCommand({id:"mark-task-complete",name:"Mark task complete",editorCheckCallback:(s,a,o)=>{let c=a.getCursor(),r=a.getLine(c.line);if(!g.isTask(r))return!1;if(s)return!0;let l=r.replace(/^([\t]*- \[)[^\]](\])/,"$1x$2");a.setLine(c.line,l)}}),this.addCommand({id:"mark-task-in-progress",name:"Mark task in progress",editorCheckCallback:(s,a,o)=>{let c=a.getCursor(),r=a.getLine(c.line);if(!g.isTask(r))return!1;if(s)return!0;let l=r.replace(/^([\t]*- \[)[^\]](\])/,"$1/$2");a.setLine(c.line,l)}}),this.addCommand({id:"mark-task-cancelled",name:"Mark task cancelled",editorCheckCallback:(s,a,o)=>{let c=a.getCursor(),r=a.getLine(c.line);if(!g.isTask(r))return!1;if(s)return!0;let l=r.replace(/^([\t]*- \[)[^\]](\])/,"$1-$2");a.setLine(c.line,l)}}),this.addCommand({id:"set-status-complete",name:"Set task status: Complete",callback:async()=>{let s=this.app.workspace.getActiveFile();if(!(s!=null&&s.path.startsWith(this.settings.taskNotesFolder+"/"))){new m.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(s,"complete")}}),this.addCommand({id:"set-status-incomplete",name:"Set task status: Incomplete",callback:async()=>{let s=this.app.workspace.getActiveFile();if(!(s!=null&&s.path.startsWith(this.settings.taskNotesFolder+"/"))){new m.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(s,"incomplete")}}),this.addCommand({id:"set-status-in-progress",name:"Set task status: In Progress",callback:async()=>{let s=this.app.workspace.getActiveFile();if(!(s!=null&&s.path.startsWith(this.settings.taskNotesFolder+"/"))){new m.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(s,"in-progress")}}),this.addCommand({id:"set-status-cancelled",name:"Set task status: Cancelled",callback:async()=>{let s=this.app.workspace.getActiveFile();if(!(s!=null&&s.path.startsWith(this.settings.taskNotesFolder+"/"))){new m.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(s,"cancelled")}}),this.addCommand({id:"schedule-task",name:"Schedule task",editorCheckCallback:(s,a,o)=>{let c=a.getCursor(),r=a.getLine(c.line);if(!g.isTask(r))return!1;if(s)return!0;new O(this,a,c.line).open()}}),this.addCommand({id:"set-time-block",name:"Set time block",editorCheckCallback:(s,a,o)=>{let c=a.getCursor(),r=a.getLine(c.line);if(!g.isTask(r))return!1;if(s)return!0;new L(this,a,c.line,"start").open()}}),this.addCommand({id:"schedule-overdue-to-today",name:"Schedule all overdue tasks to today",callback:async()=>{let s=new Date;s.setHours(0,0,0,0),await X.scheduleAllOverdueTo(this.app,this.settings,s)}}),this.addCommand({id:"schedule-overdue-to-this-note",name:"Schedule all overdue tasks to this note's date",checkCallback:s=>{let a=this.app.workspace.getActiveFile();if(!a||!g.shouldProcessFile(a,this.settings))return!1;let o=X.parseDateFromFilename(a.basename);if(!o)return!1;if(s)return!0;X.scheduleAllOverdueTo(this.app,this.settings,o)}}),this.addCommand({id:"archive-completed-tasks",name:"Archive completed/scheduled tasks now",editorCallback:async(s,a)=>{let o=a.file;if(!o||!g.shouldProcessFile(o,this.settings)){new m.Notice("This command only works in target folders");return}let c=s.getValue(),r=ut.archiveContent(c,this.settings);r!==c?(s.setValue(r),new m.Notice("Tasks archived")):new m.Notice("No tasks to archive")}}),this.addSettingTab(new rt(this.app,this))}onunload(){if(console.log("Task Manager: unloaded"),this.taskNoteSyncTimers){for(let t of this.taskNoteSyncTimers.values())clearTimeout(t);this.taskNoteSyncTimers.clear()}}async loadSettings(){this.settings=Object.assign({},bt,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async processFile(t){this.isProcessing=!0;try{let e=this.app.workspace.getActiveViewOfType(m.MarkdownView),n=this.app.workspace.getActiveFile(),s=e&&n&&n.path===t.path,a,o;s?(o=e.editor,a=o.getValue()):a=await this.app.vault.read(t);let c=!1;if(this.settings.enableTaskIds){let r=G.processContent(a,this.settings);r!==a&&(a=r,c=!0)}if(this.settings.enableParentChildLinking){let r=dt.linkContent(a,this.settings);r!==a&&(a=r,c=!0)}if(this.settings.enableAutoSort){let r=J.sortContent(a,this.settings);r!==a&&(a=r,c=!0)}if(this.settings.enableAutoArchive&&!s){let r=ut.archiveContent(a,this.settings);r!==a&&(a=r,c=!0)}if(c)if(s&&o){let r=o.getCursor(),l=o.getValue().split(`
`),p=a.split(`
`);for(let d=0;d<p.length;d++)if(d<l.length&&l[d]!==p[d])if(d===r.line){let h=l[d],k=p[d];if(k.length>h.length&&k.startsWith(h.trimEnd())){let T=k.slice(h.trimEnd().length);o.replaceRange(T,{line:d,ch:h.length})}}else o.setLine(d,p[d])}else await this.app.vault.modify(t,a);this.settings.enableTaskStatusSync&&!this.taskNoteSyncing&&await I.syncAllStatusesToTaskNotes(this.app,t,this.settings)}finally{setTimeout(()=>{this.isProcessing=!1},100)}}async updateTaskNoteStatus(t,e){let n=await this.app.vault.read(t);if(I.extractFrontmatterField(n,"status")===e){new m.Notice(`Status already set to ${e}`);return}let a=I.updateFrontmatterField(n,"status",e);a=this.updateButtonHighlighting(a,e),a!==n&&(await this.app.vault.modify(t,a),new m.Notice(`Status changed to ${e}`))}updateButtonHighlighting(t,e){let s={incomplete:"btn-incomplete","in-progress":"btn-progress",cancelled:"btn-cancelled",complete:"btn-complete"}[e];if(!s)return t;let a=/(```meta-bind-button\n(?:> )?label: "[^"]+"\n(?:> )?style: )(primary|default)(\n(?:> )?id: (btn-[a-z-]+))/g;return t.replace(a,(o,c,r,l,p)=>c+(p===s?"primary":"default")+l)}processLineOnLeave(t){let e=this.app.workspace.getActiveViewOfType(m.MarkdownView);if(!e)return;let n=this.app.workspace.getActiveFile();if(!n||!g.shouldProcessFile(n,this.settings))return;let s=e.editor,a=s.getLine(t);if(!a||!g.isTask(a)||g.isCalendarEvent(a))return;let o=a,c=!1;if(this.settings.enableTaskIds&&!g.extractId(a)&&(o=g.addId(o,g.generateId(this.settings)),c=!0),this.settings.enableParentChildLinking&&g.isSubtask(a)){let l=null;for(let p=t-1;p>=0;p--){let d=s.getLine(p);if(g.isParentTask(d)){l=g.extractId(d);break}}l&&!g.extractParentId(o)&&(o=g.addParentId(o,l),c=!0)}let r=g.normalizeMetadataOrder(o);r!==o&&(o=r,c=!0),c&&(this.isProcessing=!0,s.setLine(t,o),setTimeout(()=>{this.isProcessing=!1},50))}showTaskInfo(t,e,n,s,a,o,c,r){let l=null;if(e&&this.app.workspace.getActiveFile()){let h=this.app.workspace.getActiveViewOfType(m.MarkdownView);if(h&&h.editor){let T=h.editor.getValue().split(`
`);for(let w of T)if(g.extractId(w)===e){l=I.extractTaskTextFromLine(w);break}}}new ot(this.app,t,e,n,l,()=>{if(s&&a!==void 0){let d=s.getLine(a),h=g.removeParentId(d);s.setLine(a,h),new m.Notice("Task unlinked from parent")}},o,c,r).open()}showSchedulePopupFromWidget(t,e){let n=this.app.workspace.getActiveViewOfType(m.MarkdownView);if(!n||!n.editor)return;let s=n.editor;new nt(this,s,e,t).open()}showTimeblockPickerFromWidget(t,e){let n=this.app.workspace.getActiveViewOfType(m.MarkdownView);if(!n||!n.editor)return;let s=n.editor;new it(this,s,e,"start",null,null,t).open()}};module.exports=ct;
