"use strict";var m=require("obsidian"),{EditorView:Nt,Decoration:A,ViewPlugin:ut,WidgetType:St}=require("@codemirror/view"),{RangeSetBuilder:xt}=require("@codemirror/state"),yt={targetFolders:["00 - Daily/"],enableTaskIds:!0,idPrefix:"t-",idLength:8,enableParentChildLinking:!0,preserveExistingParentLinks:!0,enableAutoSort:!1,sortDebounceMs:500,tasksWithoutTimePosition:"end",showInfoButton:!0,hideMetadataFields:!0,enableTaskNotes:!0,taskNotesFolder:"Task Notes",enableEventNotes:!0,eventNotesFolder:"Event Notes",enableIcsSync:!0,enableAutoArchive:!0,enableTaskStatusSync:!0,statusMappings:{" ":"incomplete",x:"complete",X:"complete","/":"in-progress","-":"cancelled",">":"scheduled"}},g={TASK_PATTERN:/^[\t]*- \[.\]/,PARENT_TASK_PATTERN:/^- \[.\]/,SUBTASK_PATTERN:/^\t+- \[.\]/,ID_PATTERN:/\[id::([^\]]+)\]/,PARENT_ID_PATTERN:/\[parent::([^\]]+)\]/,METADATA_PATTERN:/\s*\[(?:id|parent|uid)::[^\]]+\]/g,COMPLETED_PATTERN:/^[\t]*- \[[xX\->]\]/,TIMEBLOCK_PATTERN:/^- \[.\]\s*(\d{2}):(\d{2}) - (\d{2}):(\d{2})/,CALENDAR_EVENT_PATTERN:/^[\t]*- \[c\]/,extractId(s){let t=s.match(this.ID_PATTERN);return t?t[1].trim():null},extractParentId(s){let t=s.match(this.PARENT_ID_PATTERN);return t?t[1].trim():null},generateId(s){let t="abcdefghijklmnopqrstuvwxyz0123456789",e=s.idPrefix;for(let n=0;n<s.idLength;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e},addId(s,t){return this.extractId(s)?s:s.trimEnd()+` [id::${t}]`},addParentId(s,t){let e=this.extractParentId(s);return e?e!==t?s.replace(this.PARENT_ID_PATTERN,`[parent::${t}]`):s:s.trimEnd()+` [parent::${t}]`},normalizeMetadataOrder(s){if(!this.isTask(s))return s;let t=s.match(/^([\t]*- \[.\]\s*)/);if(!t)return s;let e=t[1],n=s.slice(e.length),a=n.match(/\[id::([^\]]+)\]/),r=n.match(/\[parent::([^\]]+)\]/),l=n.match(/\[uid::([^\]]+)\]/),i=n.match(/\[>\s*(\d{4}-\d{2}-\d{2})\]/),o=n.match(/\[<\s*(\d{4}-\d{2}-\d{2})\]/);n=n.replace(/\s*\[id::[^\]]+\]/g,"").replace(/\s*\[parent::[^\]]+\]/g,"").replace(/\s*\[uid::[^\]]+\]/g,"").replace(/\s*\[>\s*\d{4}-\d{2}-\d{2}\]/g,"").replace(/\s*\[<\s*\d{4}-\d{2}-\d{2}\]/g,"").trimEnd();let c=[e+n];return a&&c.push(`[id::${a[1]}]`),r&&c.push(`[parent::${r[1]}]`),l&&c.push(`[uid::${l[1]}]`),o&&c.push(`[< ${o[1]}]`),i&&c.push(`[> ${i[1]}]`),c.join(" ")},removeParentId(s){return s.replace(/\s*\[parent::[^\]]+\]/,"")},isTask(s){return this.TASK_PATTERN.test(s)},isCalendarEvent(s){return this.CALENDAR_EVENT_PATTERN.test(s)},isParentTask(s){return this.PARENT_TASK_PATTERN.test(s)},isSubtask(s){return this.SUBTASK_PATTERN.test(s)},isCompleted(s){return this.COMPLETED_PATTERN.test(s)},getTaskSortKey(s){let t=s.match(this.TIMEBLOCK_PATTERN);if(t){let e=parseInt(t[1])*60+parseInt(t[2]),n=parseInt(t[3])*60+parseInt(t[4]);return{hasTime:!0,start:e,end:n}}return{hasTime:!1,start:1/0,end:1/0}},shouldProcessFile(s,t){return s.extension!=="md"?!1:t.targetFolders.some(e=>s.path.includes(e))}},j={UID_PATTERN:/\[uid::([^\]]+)\]/,CALENDAR_PATTERN:/\[calendar::([^\]]+)\]/,extractUid(s){let t=s.match(this.UID_PATTERN);return t?t[1].trim():null},extractCalendar(s){let t=s.match(this.CALENDAR_PATTERN);return t?t[1].trim():null},parseEventLine(s){let t=s.match(/^- \[c\]\s*(\d{2}):(\d{2})\s*-\s*(\d{2}):(\d{2})\s+(.+?)(?:\s*\[uid::[^\]]+\])?\s*$/);return t?{startHour:parseInt(t[1]),startMinute:parseInt(t[2]),endHour:parseInt(t[3]),endMinute:parseInt(t[4]),text:t[5].trim(),uid:this.extractUid(s)}:null},formatTime(s,t){return`${s.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},buildEventLine(s,t){let e=s.time||"00:00",n=s.endTime||e,a=s.summary||"Untitled Event";s.location&&(a+=` ${s.location}`),s.callUrl&&(a+=` ${s.callUrl}`);let r=s.uid||`fallback-${s.utime}`,l=s.icsName||"",i=`- [c] ${e} - ${n} ${a} [uid::${r}]`;return l&&(i+=` [calendar::${l}]`),i},getDailyNoteDate(s,t){if(!g.shouldProcessFile(s,t))return null;let e=s.basename.match(/^(\d{4})-(\d{2})-(\d{2})$/);return e?new Date(parseInt(e[1]),parseInt(e[2])-1,parseInt(e[3])):null},async getIcsEvents(s,t){try{let e=s.plugins.getPlugin("ics");if(!e||!e.getEvents)return null;let n=window.moment;return n?await e.getEvents(n(t)):null}catch(e){return console.error("Task Manager: Error fetching ICS events",e),null}},async syncEventsToNote(s,t,e){let n=this.getDailyNoteDate(t,e);if(!n)return!1;let a=await this.getIcsEvents(s,n);if(!a||a.length===0)return!1;let r=await s.vault.read(t),l=r.split(`
`),i=[],o=[];for(let k of l)g.isCalendarEvent(k)?i.push(k):o.push(k);let c=new Map;for(let k of i){let w=this.extractUid(k);w&&c.set(w,k)}let u=[];for(let k of a){let w=this.buildEventLine(k,e);u.push({line:w,utime:k.utime||0})}u.sort((k,w)=>k.utime-w.utime);let h=[...u.map(k=>k.line),...o].join(`
`);return h!==r?(await s.vault.modify(t,h),!0):!1}},Y={processContent(s,t){let e=s.split(`
`),n=[];for(let a=0;a<e.length;a++){let r=e[a];if(g.isCalendarEvent(r)){n.push(r);continue}g.isTask(r)&&(g.extractId(r)||(r=g.addId(r,g.generateId(t)))),n.push(r)}return n.join(`
`)}},ht={linkContent(s,t){let e=s.split(`
`),n=[],a=null;for(let r=0;r<e.length;r++){let l=e[r],i=g.isParentTask(l),o=g.isSubtask(l);i?(a=g.extractId(l),g.extractParentId(l)&&(l=g.removeParentId(l)),n.push(l)):o?(!g.extractParentId(l)&&a&&(l=g.addParentId(l,a)),n.push(l)):(/^#/.test(l)&&(a=null),n.push(l))}return n.join(`
`)}},J={sortContent(s,t){let e=s.split(`
`),n=[],a=[],r=!1,l=[],i=[],o=[],c=!1;for(let p=0;p<e.length;p++){let f=e[p];if(/^##\s*Completed\s*$/i.test(f)){r=!0;continue}let b=g.isParentTask(f),v=g.isSubtask(f);if(r){if(b)a.push({id:g.extractId(f),parent:f,subtasks:[]});else if(v&&a.length>0){let C=g.extractParentId(f);if(C){let E=a.find(S=>S.id===C);E?E.subtasks.push(f):a[a.length-1].subtasks.push(f)}else a[a.length-1].subtasks.push(f)}else/^#/.test(f)&&(r=!1,o.push({line:f,index:p,isTaskArea:!1}));continue}b?(c||(c=!0),l.push({id:g.extractId(f),line:f,index:p})):v?i.push({parentId:g.extractParentId(f),line:f,index:p}):(c&&/^#/.test(f)&&(c=!1),o.push({line:f,index:p,isTaskArea:c}))}let u=[];for(let p of l){let f={parent:p.line,subtasks:[],sortKey:g.getTaskSortKey(p.line)};if(p.id)for(let v of i)v.parentId===p.id&&f.subtasks.push(v.line);let b=p.index;for(let v of i)if(!v.parentId){let C=!0;for(let S of l)if(S.index>b&&S.index<v.index){C=!1;break}let E=l.filter(S=>S.index<v.index).sort((S,N)=>N.index-S.index)[0];E&&E.index===b&&C&&(f.subtasks.includes(v.line)||f.subtasks.push(v.line))}u.push(f)}let d=u.filter(p=>!g.isCompleted(p.parent)),h=u.filter(p=>g.isCompleted(p.parent));d.sort((p,f)=>p.sortKey.hasTime&&!f.sortKey.hasTime?-1:!p.sortKey.hasTime&&f.sortKey.hasTime?1:p.sortKey.start!==f.sortKey.start?p.sortKey.start-f.sortKey.start:p.sortKey.end-f.sortKey.end),h.sort((p,f)=>p.sortKey.hasTime&&!f.sortKey.hasTime?-1:!p.sortKey.hasTime&&f.sortKey.hasTime?1:p.sortKey.start!==f.sortKey.start?p.sortKey.start-f.sortKey.start:p.sortKey.end-f.sortKey.end);let k=l.length>0?l[0].index:0,w=l.length>0?Math.max(...l.map(p=>p.index),...i.map(p=>p.index)):0;for(let p of o)p.index<k&&n.push(p.line);for(let p of d){n.push(p.parent);for(let f of p.subtasks)n.push(f)}for(let p of o)p.index>w&&n.push(p.line);let T=[...h,...a];if(T.length>0){for(;n.length>0&&n[n.length-1].trim()==="";)n.pop();n.push(""),n.push("## Completed"),T.sort((p,f)=>{let b=g.getTaskSortKey(p.parent),v=g.getTaskSortKey(f.parent);return b.hasTime&&!v.hasTime?-1:!b.hasTime&&v.hasTime?1:b.start!==v.start?b.start-v.start:b.end-v.end});for(let p of T){n.push(p.parent);for(let f of p.subtasks)n.push(f)}}return n.join(`
`)},sortByTimeBlock(s,t){let e=s.split(`
`),n=/^[\t]*- \[.\]\s*(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/,a=/^> \[!archived\]-?\s*Archived\s*$/,r=/^> /,l=[],i=[],o=[],c=0,u=!1;for(;c<e.length;){let h=e[c];if(a.test(h)){u=!0,o.push(h),c++;continue}if(u)if(r.test(h)||h.trim()===""){o.push(h),c++;continue}else u=!1;let k=g.isParentTask(h),w=g.isCalendarEvent(h);if(k||w){let T=h.match(n),p=[];if(k){let b=g.extractId(h),v=c+1;for(;v<e.length&&g.isSubtask(e[v]);){let C=g.extractParentId(e[v]);(!C||C===b)&&p.push(e[v]),v++}c=v}else c++;let f={line:h,subtasks:p,isEvent:w};T?(f.startMinutes=parseInt(T[1])*60+parseInt(T[2]),f.endMinutes=parseInt(T[3])*60+parseInt(T[4]),l.push(f)):i.push(f)}else g.isSubtask(h),c++}l.sort((h,k)=>h.startMinutes!==k.startMinutes?h.startMinutes-k.startMinutes:h.endMinutes-k.endMinutes);let d=[];for(let h of l){d.push(h.line);for(let k of h.subtasks)d.push(k)}i.length>0&&l.length>0&&d.push("");for(let h of i){d.push(h.line);for(let k of h.subtasks)d.push(k)}if(o.length>0){d.push("");for(let h of o)d.push(h)}return d.join(`
`)}},pt={ARCHIVE_STATES:/^[\t]*- \[[xX>\-]\]/,ACTIVE_STATES:/^[\t]*- \[[ \/c]\]/,ARCHIVE_CALLOUT_START:/^> \[!archived\]-?\s*Archived\s*$/,ARCHIVE_LINE:/^> /,archiveContent(s,t){let e=s.split(`
`),n=[],a=[],r=[],l=[],i=!1,o=0;for(;o<e.length;){let d=e[o];if(this.ARCHIVE_CALLOUT_START.test(d)){i=!0,o++;continue}if(i)if(this.ARCHIVE_LINE.test(d)){l.push(d.substring(2)),o++;continue}else i=!1;if(g.CALENDAR_EVENT_PATTERN.test(d)){n.push(d),o++;continue}if(this.ARCHIVE_STATES.test(d)){let h=[d];for(o++;o<e.length&&g.SUBTASK_PATTERN.test(e[o]);)h.push(e[o]),o++;r.push(...h);continue}if(this.ACTIVE_STATES.test(d)){let h=[d];for(o++;o<e.length&&g.SUBTASK_PATTERN.test(e[o]);)h.push(e[o]),o++;a.push(...h);continue}(d.trim()!==""||a.length>0)&&a.push(d),o++}let c=[...r,...l],u=[];for(let d of n)u.push(d);for(let d of a)u.push(d);if(c.length>0){if(u.length>0){for(;u.length>0&&u[u.length-1]==="";)u.pop();for(let d=0;d<7;d++)u.push("")}u.push("> [!archived]- Archived");for(let d of c)u.push("> "+d)}return u.join(`
`)}},D={cleanTaskText(s){return s=s.replace(/\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/g,""),s=s.replace(/üìÖ\s*\[\[[^\]]+\]\]/g,""),s=s.replace(/üìÖ\s*\d{4}-\d{2}-\d{2}/g,""),s=s.replace(/#\w+/g,""),s=s.replace(/üîó\[\[[^\]]+\]\]/g,""),s=s.replace(/\[\[([^\]|]+)\|?([^\]]*)\]\]/g,(t,e,n)=>n||e),s=s.replace(/[üìÖüóìÔ∏è‚è≥üõ´‚úÖ‚ùå‚ûïüî∫‚è´üîºüîΩ‚è¨üÜî‚õîüîÅ][^\s]*/g,""),s=s.replace(/üìù/g,""),s=s.replace(/üîó/g,""),s=s.replace(/\s*\[[^\]]+::[^\]]*\]/g,""),s=s.replace(/\s*\[[<>]\s*\d{4}-\d{2}-\d{2}\]/g,""),s=s.replace(/\s+/g," ").trim(),s},sanitizeFilename(s){return s.replace(/[\\/:*?"<>|#\[\]]/g,"-").replace(/-+/g,"-").replace(/\s+/g," ").trim().substring(0,100)},extractTaskTextFromLine(s){let t=s.match(/^(?:>\s*)?- \[.\]\s*(.+)$/);return t?this.cleanTaskText(t[1]):null},extractCheckboxMarker(s){let t=s.match(/^[\t]*- \[(.)\]/);return t?t[1]:null},checkboxToStatus(s,t){return t.statusMappings[s]||"incomplete"},statusToCheckbox(s,t){for(let[e,n]of Object.entries(t.statusMappings))if(n===s)return e;return" "},extractFrontmatterField(s,t){let e=s.match(/^---\n([\s\S]*?)\n---/);if(!e)return null;let a=e[1].match(new RegExp(`^${t}:\\s*"?([^"\\n]*)"?`,"m"));return a?a[1]:null},updateFrontmatterField(s,t,e){let n=s.match(/^(---\n)([\s\S]*?)(\n---)/);if(!n)return s;let[a,r,l,i]=n,o=new RegExp(`^(${t}:\\s*)"?[^"\\n]*"?`,"m"),c;return o.test(l)?c=l.replace(o,`$1"${e}"`):c=l+`
${t}: "${e}"`,s.replace(a,r+c+i)},updateTaskCheckbox(s,t,e){let n=s.split(`
`),a=new RegExp(`\\[id::\\s*${t}\\]`);for(let r=0;r<n.length;r++)if(a.test(n[r])){n[r]=n[r].replace(/^([\t]*- \[).(])/,`$1${e}$2`);break}return n.join(`
`)},async findTaskNoteByTaskId(s,t,e){let n=e.taskNotesFolder,a=s.vault.getFiles().filter(r=>r.path.startsWith(n+"/"));for(let r of a){let l=await s.vault.read(r);if(this.extractFrontmatterField(l,"taskId")===t)return r}return null},async syncStatusToSource(s,t,e){if(!e.enableTaskStatusSync)return;let n=await s.vault.read(t),a=this.extractFrontmatterField(n,"taskId"),r=this.extractFrontmatterField(n,"status"),l=this.extractFrontmatterField(n,"sourceFile");if(!a||!r||!l)return;let i=s.vault.getAbstractFileByPath(l);if(!i||!(i instanceof m.TFile))return;let o=this.statusToCheckbox(r,e),c=await s.vault.read(i),u=new RegExp(`\\[id::\\s*${a}\\]`),d=c.split(`
`);for(let k of d)if(u.test(k)){if(this.extractCheckboxMarker(k)===o)return;break}let h=this.updateTaskCheckbox(c,a,o);h!==c&&await s.vault.modify(i,h)},async syncStatusToTaskNote(s,t,e,n){if(!n.enableTaskStatusSync)return;let a=await this.findTaskNoteByTaskId(s,t,n);if(!a)return;let r=this.checkboxToStatus(e,n),l=await s.vault.read(a);if(this.extractFrontmatterField(l,"status")===r)return;let o=this.updateFrontmatterField(l,"status",r);o!==l&&await s.vault.modify(a,o)},async syncAllStatusesToTaskNotes(s,t,e){if(!e.enableTaskStatusSync)return;let a=(await s.vault.read(t)).split(`
`);for(let r of a){let l=g.extractId(r);if(!l||g.CALENDAR_EVENT_PATTERN.test(r))continue;let i=this.extractCheckboxMarker(r);i&&await this.syncStatusToTaskNote(s,l,i,e)}},async getSubtasksFromSource(s,t,e){if(!t)return[];let n=s.vault.getAbstractFileByPath(t);if(!n||!(n instanceof m.TFile))return[];let r=(await s.vault.read(n)).split(`
`),l=[],i=-1;for(let c=0;c<r.length;c++){let d=r[c].match(/^(\s*)- \[[ x]\]\s*(.+)$/);if(d&&this.cleanTaskText(d[2])===e){i=c;break}}if(i===-1)return[];let o=r[i].match(/^(\s*)/)[1].length;for(let c=i+1;c<r.length;c++){let u=r[c],d=u.match(/^(\s*)- \[([ x])\]\s*(.+)$/);if(!d){let k=u.match(/^(\s*)/);if(k&&k[1].length<=o&&u.trim()!=="")break;continue}if(d[1].length>o){let k=d[2]==="x",w=this.cleanTaskText(d[3]);w&&l.push({text:w,completed:k,originalLine:u})}else break}return l},async syncSubtasksToTaskNote(s,t,e,n){let a=await s.vault.read(t),r=a.match(/sourceFile:\s*"([^"]+)"/),l=r?r[1]:null,i=n&&l&&l!==n,o=a.match(/## Subtasks\n\n([\s\S]*?)(?=\n## |$)/);if(!o)return;let c=o[1],u=[],d=c.split(`
`);for(let T of d){let p=T.match(/^- \[([ x])\]\s*(.*)$/);p&&p[2].trim()&&u.push({text:p[2].trim(),completed:p[1]==="x"})}let h=[...u];for(let T of e)u.some(f=>f.text.toLowerCase()===T.text.toLowerCase())||h.push(T);let k=h.length>u.length,w=n&&(!l||i);if(k||w){let T=a;if(k){let p=h.map(f=>`- [${f.completed?"x":" "}] ${f.text}`).join(`
`);T=T.replace(/## Subtasks\n\n[\s\S]*?(?=\n## |$)/,`## Subtasks

${p}
`)}w&&(l?T=T.replace(/sourceFile:\s*"[^"]*"/,`sourceFile: "${n}"`):T=T.replace(/^---\n([\s\S]*?)---/,`---
$1sourceFile: "${n}"
---`)),await s.vault.modify(t,T),k&&new m.Notice(`Synced ${e.length} subtask(s) from source`)}},async syncSubtasksBackToSource(s,t,e){if(e)return!1;let n=await s.vault.read(t),a=n.match(/sourceFile:\s*"([^"]+)"/);if(!a||!a[1])return!1;let r=a[1],l=s.vault.getAbstractFileByPath(r);if(!l||!(l instanceof m.TFile))return!1;let i=n.match(/task:\s*"?([^"\n]+)"?/);if(!i)return!1;let o=i[1].replace(/\\"/g,'"'),c=n.match(/## Subtasks\n\n([\s\S]*?)(?=\n## |$)/);if(!c)return!1;let u=[],d=c[1].split(`
`);for(let S of d){let N=S.match(/^- \[([ x])\]\s*(.+)$/);N&&N[2].trim()&&u.push({text:N[2].trim(),completed:N[1]==="x"})}if(u.length===0)return!1;let h=await s.vault.read(l),k=h.split(`
`),w=-1,T=0;for(let S=0;S<k.length;S++){let y=k[S].match(/^(\s*)- \[[ x]\]\s*(.+)$/);if(y&&this.cleanTaskText(y[2])===o){w=S,T=y[1].length;break}}if(w===-1)return!1;let p=w;for(let S=w+1;S<k.length;S++){let N=k[S],y=N.match(/^(\s*)/),x=y?y[1].length:0;if(N.trim()!=="")if(x>T)p=S;else break}let f="	",b=u.map(S=>`${f}- [${S.completed?"x":" "}] ${S.text}`),v=k.slice(0,w+1),C=k.slice(p+1),E=[...v,...b,...C].join(`
`);return E!==h?(await s.vault.modify(l,E),!0):!1},async openOrCreateTaskNote(s,t,e,n,a=null){let r=this.sanitizeFilename(e);if(!r)return new m.Notice("Could not extract task name"),null;let l=t.taskNotesFolder,i=`${l}/${r}.md`;s.vault.getAbstractFileByPath(l)||await s.vault.createFolder(l);let c=await this.getSubtasksFromSource(s,n,e),u=" ";if(n&&a){let w=s.vault.getAbstractFileByPath(n);if(w instanceof m.TFile){let T=await s.vault.read(w),p=new RegExp(`\\[id::\\s*${a}\\]`),f=T.split(`
`);for(let b of f)if(p.test(b)){let v=this.extractCheckboxMarker(b);v&&(u=v);break}}}let d=this.checkboxToStatus(u,t),h=s.vault.getAbstractFileByPath(i),k=!h;if(h)h instanceof m.TFile&&await this.syncSubtasksToTaskNote(s,h,c,n);else{let w=c.length>0?c.map(f=>`- [${f.completed?"x":" "}] ${f.text}`).join(`
`):"- [ ] ",T=n?`[[${n.replace(/\.md$/,"")}]]`:"",p=`---
task: "${e.replace(/"/g,'\\"')}"
taskId: "${a||""}"
status: "${d}"
created: ${new Date().toISOString().split("T")[0]}
sourceFile: "${n||""}"
---

# ${e}

**Source:** ${T}

---

## Status
\`BUTTON[btn-incomplete, btn-progress, btn-cancelled, btn-complete]\`

## Notes


## Subtasks

${w}

## References


---
> [!meta]- Button Definitions
> \`\`\`meta-bind-button
> label: "\u25CB Incomplete"
> style: primary
> id: btn-incomplete
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-incomplete
> \`\`\`
>
> \`\`\`meta-bind-button
> label: "\u25D0 In Progress"
> style: default
> id: btn-progress
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-in-progress
> \`\`\`
>
> \`\`\`meta-bind-button
> label: "\u2715 Cancelled"
> style: default
> id: btn-cancelled
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-cancelled
> \`\`\`
>
> \`\`\`meta-bind-button
> label: "\u2713 Complete"
> style: default
> id: btn-complete
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-complete
> \`\`\`
`;h=await s.vault.create(i,p),new m.Notice(`Created: ${r}`)}return h instanceof m.TFile&&await s.workspace.getLeaf().openFile(h),h},async updateTaskNoteSourceFile(s,t,e,n,a){let r=this.sanitizeFilename(e);if(!r)return!1;let l=`${t.taskNotesFolder}/${r}.md`,i=s.vault.getAbstractFileByPath(l);if(!i||!(i instanceof m.TFile))return!1;let o=await s.vault.read(i),c=!1,u=/^(sourceFile:\s*")([^"]*)(")$/m,d=o.replace(u,`$1${n}$3`);d!==o&&(o=d,c=!0);let h=/^(scheduled:\s*)(\S+)$/m;if(h.test(o)){let p=o.replace(h,`$1${a}`);p!==o&&(o=p,c=!0)}else{let p=o.replace(/^(sourceFile:\s*"[^"]*")$/m,`$1
scheduled: ${a}`);p!==o?(o=p,c=!0):(o=o.replace(/^(---)$/m,`scheduled: ${a}
$1`),c=!0)}let k=`[[${n.replace(/\.md$/,"")}]]`,w=/^(\*\*Source:\*\*\s*)\[\[[^\]]+\]\]/m,T=o.replace(w,`$1${k}`);return T!==o&&(o=T,c=!0),c?(await s.vault.modify(i,o),!0):!1}},Z={sanitizeFilename(s){if(!s)return null;let t=s.replace(/^\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s*/,"");return t=t.replace(/https?:\/\/[^\s]+/g,""),t=t.replace(/[<>:"/\\|?*]/g,""),t=t.trim().substring(0,100),t||null},extractEventTitle(s){let t=s.replace(/^[\t]*- \[c\]\s*/,"");return t=t.replace(/^\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s*/,""),t=t.replace(/\s*\[uid::[^\]]+\]/g,""),t=t.replace(/\s*\[calendar::[^\]]+\]/g,""),t=t.replace(/\s*https?:\/\/[^\s]+/g,""),t.trim()},extractTimeRange(s){let t=s.match(/(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})/);return t?{start:t[1],end:t[2]}:null},async openOrCreateEventNote(s,t,e,n,a,r=null,l=null){var h;let i=this.sanitizeFilename(e);if(!i)return new m.Notice("Could not extract event name"),null;let o=t.eventNotesFolder,c=`${o}/${i}.md`;s.vault.getAbstractFileByPath(o)||await s.vault.createFolder(o);let d=s.vault.getAbstractFileByPath(c);if(!d){let k=a?`[[${a.replace(/\.md$/,"")}]]`:"",w=r?`${r.start} - ${r.end}`:"",T=a?(h=a.match(/(\d{4}-\d{2}-\d{2})/))==null?void 0:h[1]:new Date().toISOString().split("T")[0],p=`---
event: "${e.replace(/"/g,'\\"')}"
eventUID: "${n||""}"
calendar: "${l||""}"
date: ${T}
time: "${w}"
created: ${new Date().toISOString().split("T")[0]}
sourceFile: "${a||""}"
---

# ${e}

**Date:** ${T}${w?`  |  **Time:** ${w}`:""}
**Source:** ${k}

---

## Agenda


## Notes


## Action Items

- [ ]

## Follow-ups


`;d=await s.vault.create(c,p),new m.Notice(`Created: ${i}`)}return d instanceof m.TFile&&await s.workspace.getLeaf().openFile(d),d}},L={removeSchedulingTags(s){return s.replace(/\s*\[<\s*\d{4}-\d{2}-\d{2}\]/g,"").replace(/\s*\[>\s*\d{4}-\d{2}-\d{2}\]/g,"").replace(/\s*\[sch_from::[^\]]+\]/g,"").replace(/\s*\[sch_to::[^\]]+\]/g,"").replace(/\s*üìÖ\s*\[\[[^\]]+\]\]/g,"").replace(/\s*üìÖ\s*\d{4}-\d{2}-\d{2}/g,"")},getCurrentDate(){return new Date().toISOString().split("T")[0]},getDailyNotePath(s,t){return`${(t.targetFolders[0]||"00 - Daily/").replace(/\/$/,"")}/${s}.md`},createScheduledTaskCopy(s,t){let e=s.replace(/^([\t]*- \[)[^\]](\])/,"$1 $2");return e=this.removeSchedulingTags(e),e=e.replace(/\s*\[parent::\s*[^\]]+\]/g,""),e=e.trimEnd()+` [< ${t}]`,e},markTaskAsScheduled(s,t){let e=s.replace(/^([\t]*- \[)[^\]](\])/,"$1>$2");return e=e.replace(/^([\t]*- \[.\]\s*)\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/,"$1"),e=this.removeSchedulingTags(e),e=e.trimEnd()+` [> ${t}]`,e},extractScheduledToDate(s){let t=s.match(/\[>\s*(\d{4}-\d{2}-\d{2})\]/);return t?t[1]:null},isScheduledAway(s){return/^[\t]*- \[>\]/.test(s)},resetScheduledTask(s){let t=s.replace(/^([\t]*- \[)>(\])/,"$1 $2");return t=this.removeSchedulingTags(t),t},async scheduleTask(s,t,e,n,a){let r=e.getLine(n);if(!g.isTask(r))return new m.Notice("Not a task line"),!1;if(r.includes(`[> ${a}]`))return new m.Notice("Task already scheduled to this date"),!1;let l=s.workspace.getActiveFile(),i=l?l.basename:this.getCurrentDate(),o=this.getDailyNotePath(a,t),c=s.vault.getAbstractFileByPath(o);if(!c){let p=o.substring(0,o.lastIndexOf("/"));s.vault.getAbstractFileByPath(p)||await s.vault.createFolder(p),c=await s.vault.create(o,""),new m.Notice(`Created daily note: ${a}`)}if(!(c instanceof m.TFile))return new m.Notice("Target is not a file"),!1;let u=g.extractId(r),d=await s.vault.read(c),h=!1;if(u&&(h=new RegExp(`\\[id::\\s*${u}\\]`).test(d)),h){let p=d.split(`
`),f=new RegExp(`\\[id::\\s*${u}\\]`);for(let b=0;b<p.length;b++)if(f.test(p[b])){let v=p[b];v=v.replace(/^([\t]*- \[)[^\]](\])/,"$1 $2"),v=this.removeSchedulingTags(v),v=v.trimEnd()+` [< ${i}]`,p[b]=v;break}d=p.join(`
`)}else{let p=this.createScheduledTaskCopy(r,i);d=d.trimEnd()+`
`+p}await s.vault.modify(c,d);let k=this.markTaskAsScheduled(r,a);e.setLine(n,k);let w=e.lineCount();for(let p=n+1;p<w;p++){let f=e.getLine(p);if(g.isSubtask(f)){let b=f.replace(/^([\t]*- \[)[^\]](\])/,"$1>$2");b!==f&&e.setLine(p,b)}else break}let T=D.extractTaskTextFromLine(r);return T&&await D.updateTaskNoteSourceFile(s,t,T,o,a),new m.Notice(`Task scheduled to ${a}`),!0},async unscheduleTask(s,t,e,n){let a=e.getLine(n);if(!g.isTask(a))return new m.Notice("Not a task line"),!1;let r=this.extractScheduledToDate(a),l=this.isScheduledAway(a);if(!r&&!l)return new m.Notice("Task is not scheduled"),!1;let i=g.extractId(a),o=s.workspace.getActiveFile(),c=o?o.path:null,u=o?o.basename:this.getCurrentDate(),d=this.resetScheduledTask(a);e.setLine(n,d);let h=e.lineCount();for(let w=n+1;w<h;w++){let T=e.getLine(w);if(g.isSubtask(T)){let p=T.replace(/^([\t]*- \[)>(\])/,"$1 $2");p!==T&&e.setLine(w,p)}else break}if(r&&i){let w=this.getDailyNotePath(r,t),T=s.vault.getAbstractFileByPath(w);if(T&&T instanceof m.TFile){let p=await s.vault.read(T),f=p.split(`
`),b=new RegExp(`\\[id::\\s*${i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\]`),v=-1;for(let C=0;C<f.length;C++)if(b.test(f[C])){v=C;break}if(v!==-1){let C=1;for(let E=v+1;E<f.length&&g.isSubtask(f[E]);E++)C++;f.splice(v,C),p=f.join(`
`).replace(/\n{3,}/g,`

`).trimEnd(),await s.vault.modify(T,p)}}}let k=D.extractTaskTextFromLine(a);return k&&c&&await this.updateTaskNoteForUnschedule(s,t,k,c,u),new m.Notice("Task unscheduled"),!0},async updateTaskNoteForUnschedule(s,t,e,n,a){let r=D.sanitizeFilename(e);if(!r)return!1;let l=`${t.taskNotesFolder}/${r}.md`,i=s.vault.getAbstractFileByPath(l);if(!i||!(i instanceof m.TFile))return!1;let o=await s.vault.read(i),c=!1,u=/^(sourceFile:\s*")([^"]*)(")$/m,d=o.replace(u,`$1${n}$3`);d!==o&&(o=d,c=!0);let h=/^(scheduled:\s*)(\S+)$/m;if(h.test(o)){let p=o.replace(h,`$1${a}`);p!==o&&(o=p,c=!0)}let k=`[[${n.replace(/\.md$/,"")}]]`,w=/^(\*\*Source:\*\*\s*)\[\[[^\]]+\]\]/m,T=o.replace(w,`$1${k}`);return T!==o&&(o=T,c=!0),c?(await s.vault.modify(i,o),!0):!1}},X={INCOMPLETE_TASK_PATTERN:/^[\t]*- \[ \]/,isIncompleteTask(s){return this.INCOMPLETE_TASK_PATTERN.test(s)},parseDateFromFilename(s){let t=s.match(/^(\d{4})-(\d{2})-(\d{2})$/);return t?new Date(parseInt(t[1]),parseInt(t[2])-1,parseInt(t[3])):null},async getDailyNoteFiles(s,t){let e=[],n=t.targetFolders||["00 - Daily/"];for(let a of n){let r=a.replace(/\/$/,"");if(!s.vault.getAbstractFileByPath(r))continue;let i=s.vault.getMarkdownFiles();for(let o of i)if(o.path.startsWith(r+"/")&&o.path.endsWith(".md")){let c=this.parseDateFromFilename(o.basename);c&&e.push({file:o,date:c,basename:o.basename})}}return e},async findOverdueTasks(s,t,e){let n=await this.getDailyNoteFiles(s,t),a=[],r=e.getTime();for(let{file:l,date:i,basename:o}of n){if(i.getTime()>=r)continue;let u=(await s.vault.read(l)).split(`
`);for(let d=0;d<u.length;d++){let h=u[d];this.isIncompleteTask(h)&&!g.isCalendarEvent(h)&&a.push({file:l,fileDate:o,line:h,lineNum:d,taskId:g.extractId(h)})}}return a},async scheduleAllOverdueTo(s,t,e){let n=e.toISOString().split("T")[0],a=await this.findOverdueTasks(s,t,e);if(a.length===0)return new m.Notice("No overdue tasks found"),0;let r=0,l=new Map;for(let u of a)l.has(u.file.path)||l.set(u.file.path,[]),l.get(u.file.path).push(u);let i=L.getDailyNotePath(n,t),o=s.vault.getAbstractFileByPath(i);if(!o){let u=i.substring(0,i.lastIndexOf("/"));s.vault.getAbstractFileByPath(u)||await s.vault.createFolder(u),o=await s.vault.create(i,"")}if(!(o instanceof m.TFile))return new m.Notice("Could not access target daily note"),0;let c=await s.vault.read(o);for(let[u,d]of l){let h=s.vault.getAbstractFileByPath(u);if(!h||!(h instanceof m.TFile))continue;let k=await s.vault.read(h),w=k.split(`
`),T=h.basename,p=d.sort((f,b)=>b.lineNum-f.lineNum);for(let f of p){let b=w[f.lineNum];if(!b||!this.isIncompleteTask(b))continue;let v=g.extractId(b),C=!1;if(v&&(C=new RegExp(`\\[id::\\s*${v}\\]`).test(c)),C){let S=new RegExp(`\\[id::\\s*${v}\\]`),N=c.split(`
`);for(let y=0;y<N.length;y++)if(S.test(N[y])){let x=N[y];x=x.replace(/^([\t]*- \[)[^\]](\])/,"$1 $2"),x=L.removeSchedulingTags(x),x=x.trimEnd()+` [< ${T}]`,N[y]=x;break}c=N.join(`
`)}else{let S=L.createScheduledTaskCopy(b,T);c=c.trimEnd()+`
`+S}w[f.lineNum]=L.markTaskAsScheduled(b,n),r++;let E=D.extractTaskTextFromLine(b);E&&await D.updateTaskNoteSourceFile(s,t,E,i,n)}k=w.join(`
`),await s.vault.modify(h,k)}return await s.vault.modify(o,c),new m.Notice(`Scheduled ${r} overdue task(s) to ${n}`),r}},H={formatDate(s){return s.toISOString().split("T")[0]},getTomorrow(){let s=new Date;return s.setDate(s.getDate()+1),this.formatDate(s)},getDayAfterTomorrow(){let s=new Date;return s.setDate(s.getDate()+2),this.formatDate(s)},getNextMonday(){let s=new Date,t=s.getDay(),e=t===0?1:t===1?7:8-t;return s.setDate(s.getDate()+e),this.formatDate(s)},getOneWeekFromNow(){let s=new Date;return s.setDate(s.getDate()+7),this.formatDate(s)},parseCustomDate(s){if(!s)return null;let t=s.trim();return/^\d{4}-\d{2}-\d{2}$/.test(t)?t:/^\d{8}$/.test(t)?`${t.slice(0,4)}-${t.slice(4,6)}-${t.slice(6,8)}`:null}},Q=[{id:"tomorrow",label:"Tomorrow",getDate:()=>H.getTomorrow()},{id:"day-after",label:"Day After Tomorrow",getDate:()=>H.getDayAfterTomorrow()},{id:"next-monday",label:"Next Monday",getDate:()=>H.getNextMonday()},{id:"one-week",label:"In One Week",getDate:()=>H.getOneWeekFromNow()},{id:"custom",label:"Enter a date...",isCustom:!0}],$={check:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>',halfCircle:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M448 256c0-106-86-192-192-192V448c106 0 192-86 192-192zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z"/></svg>',ban:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M367.2 412.5L99.5 144.8C77.1 176.1 64 214.5 64 256c0 106 86 192 192 192c41.5 0 79.9-13.1 111.2-35.5zm45.3-45.3C434.9 335.9 448 297.5 448 256c0-106-86-192-192-192c-41.5 0-79.9 13.1-111.2 35.5L412.5 367.2zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z"/></svg>',anglesRight:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M470.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 256 265.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160zm-352 160l160-160c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L210.7 256 73.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0z"/></svg>',fileLines:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM112 256H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16z"/></svg>',clock:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M464 256A208 208 0 1 1 48 256a208 208 0 1 1 416 0zM0 256a256 256 0 1 0 512 0A256 256 0 1 0 0 256zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/></svg>',circleRight:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M0 256a256 256 0 1 0 512 0A256 256 0 1 0 0 256zM294.6 135.1l99.9 107.1c3.5 3.8 5.5 8.7 5.5 13.8s-2 10.1-5.5 13.8L294.6 376.9c-4.2 4.5-10.1 7.1-16.3 7.1C266 384 256 374 256 361.7l0-57.7-96 0c-17.7 0-32-14.3-32-32l0-32c0-17.7 14.3-32 32-32l96 0 0-57.7c0-12.3 10-22.3 22.3-22.3c6.2 0 12.1 2.6 16.3 7.1z"/></svg>'},F={extractTimeblock(s){let t=s.match(/^([\t]*- \[.\]\s*)(\d{2}):(\d{2})\s*-\s*(\d{2}):(\d{2})\s*/);return t?{prefix:t[1],startHour:parseInt(t[2]),startMinute:parseInt(t[3]),endHour:parseInt(t[4]),endMinute:parseInt(t[5]),fullMatch:t[0]}:null},formatTime(s,t){return`${s.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},formatDisplayTime(s){let t=e=>e.toString().padStart(2,"0");return s===0?"12 AM":s===12?"12 PM":s<12?`${t(s)} AM`:`${t(s-12)} PM`},addTimeblock(s,t,e,n,a){let r=this.extractTimeblock(s),l=`${this.formatTime(t,e)} - ${this.formatTime(n,a)} `;return r?s.replace(r.fullMatch,r.prefix+l):s.replace(/^([\t]*- \[.\]\s*)/,`$1${l}`)},removeTimeblock(s){return s.replace(/^([\t]*- \[.\]\s*)\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s*/,"$1")},getDefaultEndTime(s,t){let e=t+30,n=s;return e>=60&&(e-=60,n=(n+1)%24),{hour:n,minute:e}}},M=class s{constructor(t,e,n,a,r=null,l=null){this.plugin=t,this.editor=e,this.lineNum=n,this.mode=a,this.existingStart=r,this.onComplete=l,this.selectedHour=null,this.expandedHour=null,this.container=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleClickOutside=this.handleClickOutside.bind(this)}open(){this.container=document.createElement("div"),this.container.className="timeblock-picker-popup",this.render(),this.positionPopup(),document.body.appendChild(this.container),document.addEventListener("keydown",this.handleKeyDown,!0),setTimeout(()=>{document.addEventListener("click",this.handleClickOutside)},10)}close(){this.container&&(this.container.remove(),this.container=null),document.removeEventListener("keydown",this.handleKeyDown,!0),document.removeEventListener("click",this.handleClickOutside)}render(){this.container.empty();let t=document.createElement("div");if(t.className="timeblock-picker-header",t.textContent=this.mode==="start"?"Start":"End",this.container.appendChild(t),this.mode==="end"&&this.existingStart){let r=document.createElement("div");r.className="timeblock-picker-start-info",r.textContent=`Start: ${F.formatTime(this.existingStart.hour,this.existingStart.minute)}`,this.container.appendChild(r)}let e=document.createElement("div");e.className="timeblock-picker-columns";let n=this.createColumn("DAY",6,17);e.appendChild(n);let a=this.createColumn("NIGHT",18,29);e.appendChild(a),this.container.appendChild(e)}createColumn(t,e,n){let a=document.createElement("div");a.className="timeblock-picker-column";let r=document.createElement("div");r.className="timeblock-picker-column-header",r.textContent=t,a.appendChild(r);for(let l=e;l<=n;l++){let i=l%24,o=this.createHourRow(i);a.appendChild(o)}return a}createHourRow(t){let e=document.createElement("div");e.className="timeblock-picker-row",this.expandedHour===t&&e.addClass("is-expanded");let a=null;if(this.mode==="end"&&this.existingStart){let i=F.getDefaultEndTime(this.existingStart.hour,this.existingStart.minute);t===i.hour&&(e.addClass("is-suggested"),a=i.minute)}let r=document.createElement("div");r.className="timeblock-picker-hour",r.textContent=F.formatDisplayTime(t),r.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.handleHourClick(t)}),e.appendChild(r);let l=document.createElement("div");l.className="timeblock-picker-row-minutes";for(let i of[0,15,30,45]){let o=document.createElement("button");o.className="timeblock-picker-minute-btn",a===i&&o.addClass("is-suggested"),o.textContent=i.toString().padStart(2,"0"),o.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),this.selectTime(t,i)}),l.appendChild(o)}return e.appendChild(l),e}handleHourClick(t){if(this.expandedHour===t){this.selectTime(t,0);return}this.expandedHour=t,this.render()}selectTime(t,e){this.selectedHour=t,this.close(),this.mode==="start"?new s(this.plugin,this.editor,this.lineNum,"end",{hour:t,minute:e},(a,r)=>{this.applyTimeblock(t,e,a,r)}).open():this.mode==="end"&&this.onComplete&&this.onComplete(t,e)}applyTimeblock(t,e,n,a){let r=this.editor.getLine(this.lineNum),l=F.addTimeblock(r,t,e,n,a);this.editor.setLine(this.lineNum,l),new m.Notice(`Timeblock set: ${F.formatTime(t,e)} - ${F.formatTime(n,a)}`)}positionPopup(){let t=this.plugin.app.workspace.getActiveViewOfType(m.MarkdownView);if(!t)return;let e=t.editor.cm;if(!e)return;let n=this.editor.getCursor(),a=e.coordsAtPos(e.state.doc.line(n.line+1).from);a&&(this.container.style.position="absolute",this.container.style.left=`${a.left}px`,this.container.style.top=`${a.bottom+5}px`,this.container.style.zIndex="1000")}handleKeyDown(t){t.key==="Escape"&&(t.preventDefault(),t.stopPropagation(),this.close())}handleClickOutside(t){this.container&&!this.container.contains(t.target)&&this.close()}},tt=class extends m.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,n){let a=e.getLine(t.line);if(!g.isTask(a))return null;let r=a.substring(0,t.ch),l=r.lastIndexOf("^");if(l===-1||l===0||r.substring(0,l).endsWith("^"))return null;let o={line:t.line,ch:l},c=t;e.replaceRange("",o,c);let u=F.extractTimeblock(a);return new M(this.plugin,e,t.line,"start").open(),null}getSuggestions(t){return[]}renderSuggestion(t,e){}selectSuggestion(t,e){}},Ct=[{id:"complete",label:"Mark Complete",icon:$.check,marker:"x"},{id:"in-progress",label:"Mark In Progress",icon:$.halfCircle,marker:"/"},{id:"cancelled",label:"Mark Cancelled",icon:$.ban,marker:"-"},{id:"schedule",label:"Schedule Task",icon:$.anglesRight,action:"schedule"},{id:"timeblock",label:"Set Time Block",icon:$.clock,action:"timeblock"}],et=class extends m.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,n){let a=e.getLine(t.line);if(!g.isTask(a))return null;let r=a.substring(0,t.ch),l=r.lastIndexOf("/");if(l===-1)return null;let i=r.substring(0,l);return/\d$/.test(i)?null:{start:{line:t.line,ch:l},end:t,query:r.substring(l+1).toLowerCase()}}getSuggestions(t){let e=t.query.toLowerCase();return Ct.filter(n=>n.label.toLowerCase().includes(e)||n.id.includes(e))}renderSuggestion(t,e){e.addClass("slash-command-item");let n=e.createSpan({cls:"slash-command-icon"});n.innerHTML=t.icon,e.createSpan({text:t.label,cls:"slash-command-label"})}selectSuggestion(t,e){let{editor:n}=this.context,a=this.context.start.line,r=n.getLine(a);n.replaceRange("",this.context.start,this.context.end);let l=n.getLine(a);if(t.marker){let i=l.replace(/^([\t]*- \[)[^\]](\])/,`$1${t.marker}$2`);n.setLine(a,i)}else t.action==="schedule"?this.openSchedulePopup(n,a):t.action==="timeblock"&&this.openTimeBlockPopup(n,a)}openSchedulePopup(t,e){new O(this.plugin,t,e).open()}openTimeBlockPopup(t,e){new M(this.plugin,t,e,"start").open()}},st=class extends m.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,n){let a=e.getLine(t.line);if(!g.isTask(a))return null;let r=a.substring(0,t.ch),l=r.lastIndexOf(">");if(l===-1||l===0)return null;let i=r.substring(0,l);if(i.endsWith(">")||i.endsWith("["))return null;let o={line:t.line,ch:l},c=t;return e.replaceRange("",o,c),new O(this.plugin,e,t.line).open(),null}getSuggestions(t){return[]}renderSuggestion(t,e){}selectSuggestion(t,e){}},O=class{constructor(t,e,n){this.plugin=t,this.editor=e,this.lineNum=n,this.selectedIndex=0,this.isCustomMode=!1,this.container=null,this.customInput=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleClickOutside=this.handleClickOutside.bind(this)}open(){this.container=document.createElement("div"),this.container.className="schedule-date-popup",this.renderOptions(),this.positionPopup(),document.body.appendChild(this.container),document.addEventListener("keydown",this.handleKeyDown,!0),setTimeout(()=>{document.addEventListener("click",this.handleClickOutside)},10)}close(){this.container&&(this.container.remove(),this.container=null),document.removeEventListener("keydown",this.handleKeyDown,!0),document.removeEventListener("click",this.handleClickOutside)}renderOptions(){this.container.empty(),Q.forEach((t,e)=>{let n=document.createElement("div");n.className="schedule-date-option",e===this.selectedIndex&&n.addClass("is-selected"),t.isCustom&&this.isCustomMode?(this.customInput=document.createElement("input"),this.customInput.type="text",this.customInput.className="schedule-date-custom-input",this.customInput.placeholder="YYYY-MM-DD",this.customInput.addEventListener("keydown",a=>{a.key==="Enter"?(a.preventDefault(),a.stopPropagation(),this.submitCustomDate()):a.key==="Escape"&&(a.preventDefault(),a.stopPropagation(),this.close())}),n.appendChild(this.customInput),setTimeout(()=>this.customInput.focus(),0)):(n.createSpan({text:t.label,cls:"schedule-date-label"}),t.getDate&&n.createSpan({text:t.getDate(),cls:"schedule-date-value"})),n.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.selectedIndex=e,this.selectOption(t)}),this.container.appendChild(n)})}positionPopup(){let t=this.plugin.app.workspace.getActiveViewOfType(m.MarkdownView);if(!t)return;let e=t.editor.cm;if(!e)return;let n=this.editor.getCursor(),a=e.coordsAtPos(e.state.doc.line(n.line+1).from);a&&(this.container.style.position="absolute",this.container.style.left=`${a.left}px`,this.container.style.top=`${a.bottom+5}px`,this.container.style.zIndex="1000")}handleKeyDown(t){if(this.isCustomMode&&this.customInput&&document.activeElement===this.customInput){t.key==="Escape"&&(t.preventDefault(),t.stopPropagation(),this.close());return}switch(t.key){case"ArrowDown":t.preventDefault(),t.stopPropagation(),this.selectedIndex=Math.min(this.selectedIndex+1,Q.length-1),this.renderOptions();break;case"ArrowUp":t.preventDefault(),t.stopPropagation(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.renderOptions();break;case"Enter":t.preventDefault(),t.stopPropagation(),this.selectOption(Q[this.selectedIndex]);break;case"Escape":t.preventDefault(),t.stopPropagation(),this.close();break}}handleClickOutside(t){this.container&&!this.container.contains(t.target)&&this.close()}selectOption(t){t.isCustom?this.isCustomMode||(this.isCustomMode=!0,this.renderOptions()):t.getDate&&this.scheduleToDate(t.getDate())}submitCustomDate(){if(!this.customInput)return;let t=H.parseCustomDate(this.customInput.value);t?this.scheduleToDate(t):new m.Notice("Invalid date format. Use YYYY-MM-DD or YYYYMMDD")}async scheduleToDate(t){this.close(),await L.scheduleTask(this.plugin.app,this.plugin.settings,this.editor,this.lineNum,t)}},nt=class extends O{constructor(t,e,n,a){super(t,e,n),this.anchorEl=a}positionPopup(){if(!this.anchorEl)return;let t=this.anchorEl.getBoundingClientRect();this.container.style.position="absolute",this.container.style.left=`${t.left}px`,this.container.style.top=`${t.bottom+5}px`,this.container.style.zIndex="1000",requestAnimationFrame(()=>{let e=this.container.getBoundingClientRect();e.right>window.innerWidth&&(this.container.style.left=`${window.innerWidth-e.width-10}px`),e.bottom>window.innerHeight&&(this.container.style.top=`${t.top-e.height-5}px`)})}},it=class s extends M{constructor(t,e,n,a,r,l,i){super(t,e,n,a,r,l),this.anchorEl=i}positionPopup(){if(!this.anchorEl)return;let t=this.anchorEl.getBoundingClientRect();this.container.style.position="absolute",this.container.style.left=`${t.left}px`,this.container.style.top=`${t.bottom+5}px`,this.container.style.zIndex="1000",requestAnimationFrame(()=>{let e=this.container.getBoundingClientRect();e.right>window.innerWidth&&(this.container.style.left=`${window.innerWidth-e.width-10}px`),e.bottom>window.innerHeight&&(this.container.style.top=`${t.top-e.height-5}px`)})}selectTime(t,e){this.selectedHour=t,this.close(),this.mode==="start"?new s(this.plugin,this.editor,this.lineNum,"end",{hour:t,minute:e},(a,r)=>{this.applyTimeblock(t,e,a,r)},this.anchorEl).open():this.mode==="end"&&this.onComplete&&this.onComplete(t,e)}},at=class extends St{constructor(t,e){super(),this.options=t,this.plugin=e}toDOM(){let t=document.createElement("span");if(t.className="task-decorations-container",this.options.showNotesButton&&this.options.taskText){let e=document.createElement("span");e.className="task-note-button";let n=document.createElement("span");n.className="task-note-button-icon",n.innerHTML=$.fileLines,e.appendChild(n),e.appendChild(document.createTextNode("notes")),e.setAttribute("aria-label",this.options.isCalendarEvent?"Open event note":"Open task note"),e.addEventListener("click",async a=>{a.preventDefault(),a.stopPropagation();let r=this.plugin.app.workspace.getActiveFile(),l=r?r.path:null;this.options.isCalendarEvent?await Z.openOrCreateEventNote(this.plugin.app,this.plugin.settings,this.options.taskText,this.options.uid,l,this.options.eventTimeRange,this.options.calendarSource):await D.openOrCreateTaskNote(this.plugin.app,this.plugin.settings,this.options.taskText,l,this.options.taskId)}),t.appendChild(e)}if(this.options.scheduleToDates)for(let e of this.options.scheduleToDates){let n=document.createElement("span");n.className="schedule-pill schedule-pill-to",n.textContent=`\u2192 ${e}`,n.setAttribute("aria-label",`Go to ${e}`),n.addEventListener("click",async a=>{a.preventDefault(),a.stopPropagation(),await this.navigateToDate(e)}),t.appendChild(n)}if(this.options.scheduleFromDates)for(let e of this.options.scheduleFromDates){let n=document.createElement("span");n.className="schedule-pill schedule-pill-from",n.textContent=`\u2190 ${e}`,n.setAttribute("aria-label",`Go to ${e}`),n.addEventListener("click",async a=>{a.preventDefault(),a.stopPropagation(),await this.navigateToDate(e)}),t.appendChild(n)}if(this.options.showInfoButton&&(this.options.taskId||this.options.parentId||this.options.uid)){let e=document.createElement("span");e.className="task-info-button",e.textContent="\u24D8",e.title=this.options.isCalendarEvent?"Event info":"Task info",e.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),this.plugin.showTaskInfo(this.options.taskId,this.options.parentId,this.options.taskText,null,null,this.options.uid,this.options.isCalendarEvent,this.options.calendarSource)}),t.appendChild(e)}if(!this.options.isCalendarEvent){let e=document.createElement("span");e.className="task-action-button task-schedule-button";let n=document.createElement("span");n.className="task-action-button-icon",n.innerHTML=$.circleRight,e.appendChild(n),e.title="Schedule task",e.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.plugin.showSchedulePopupFromWidget(e,this.options.lineNum)}),t.appendChild(e)}if(!this.options.isCalendarEvent){let e=document.createElement("span");e.className="task-action-button task-timeblock-button";let n=document.createElement("span");n.className="task-action-button-icon",n.innerHTML=$.clock,e.appendChild(n),e.title="Set time block",e.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.plugin.showTimeblockPickerFromWidget(e,this.options.lineNum)}),t.appendChild(e)}return t}async navigateToDate(t){let e=L.getDailyNotePath(t,this.plugin.settings),n=this.plugin.app.vault.getAbstractFileByPath(e);n||(n=await this.plugin.app.vault.create(e,"")),n instanceof m.TFile&&await this.plugin.app.workspace.getLeaf().openFile(n)}eq(t){return t.options.taskText===this.options.taskText&&t.options.taskId===this.options.taskId&&t.options.parentId===this.options.parentId&&t.options.uid===this.options.uid&&t.options.calendarSource===this.options.calendarSource&&t.options.isCalendarEvent===this.options.isCalendarEvent&&JSON.stringify(t.options.eventTimeRange)===JSON.stringify(this.options.eventTimeRange)&&JSON.stringify(t.options.scheduleToDates)===JSON.stringify(this.options.scheduleToDates)&&JSON.stringify(t.options.scheduleFromDates)===JSON.stringify(this.options.scheduleFromDates)&&t.options.showInfoButton===this.options.showInfoButton&&t.options.showNotesButton===this.options.showNotesButton&&t.options.lineNum===this.options.lineNum}ignoreEvent(){return!1}};var ot=class extends m.Modal{constructor(t,e,n,a,r,l,i,o,c){super(t),this.taskId=e,this.parentId=n,this.taskText=a,this.parentText=r,this.onUnlink=l,this.uid=i,this.isCalendarEvent=o,this.calendarSource=c}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("task-info-modal"),t.createEl("h3",{text:this.isCalendarEvent?"Event Information":"Task Information"});let e=t.createDiv({cls:"task-info-content"});if(this.isCalendarEvent&&this.uid){if(this.taskText){let r=e.createDiv({cls:"task-info-row"});r.createSpan({text:"Event: ",cls:"task-info-label"}),r.createSpan({text:this.taskText,cls:"task-info-value task-info-name"})}if(this.calendarSource){let r=e.createDiv({cls:"task-info-row"});r.createSpan({text:"Calendar: ",cls:"task-info-label"}),r.createSpan({text:this.calendarSource,cls:"task-info-value task-info-name"})}let n=e.createDiv({cls:"task-info-row"});n.createSpan({text:"Event UID: ",cls:"task-info-label"}),n.createSpan({text:this.uid,cls:"task-info-value"}),e.createDiv({cls:"task-info-row"}).createSpan({text:"Calendar events sync from ICS and are read-only",cls:"task-info-note"})}else if(this.taskId){if(this.taskText){let a=e.createDiv({cls:"task-info-row"});a.createSpan({text:"Task: ",cls:"task-info-label"}),a.createSpan({text:this.taskText,cls:"task-info-value task-info-name"})}let n=e.createDiv({cls:"task-info-row"});n.createSpan({text:"Task ID: ",cls:"task-info-label"}),n.createSpan({text:this.taskId,cls:"task-info-value"})}if(this.parentId){if(this.parentText){let r=e.createDiv({cls:"task-info-row"});r.createSpan({text:"Parent: ",cls:"task-info-label"}),r.createSpan({text:this.parentText,cls:"task-info-value task-info-name"})}let n=e.createDiv({cls:"task-info-row"});n.createSpan({text:"Parent ID: ",cls:"task-info-label"}),n.createSpan({text:this.parentId,cls:"task-info-value"}),t.createEl("button",{text:"Unlink from Parent",cls:"task-unlink-btn"}).addEventListener("click",()=>{this.onUnlink(),this.close()})}else this.taskId&&e.createDiv({cls:"task-info-row"}).createSpan({text:"This is a parent task (no parent link)",cls:"task-info-note"})}onClose(){let{contentEl:t}=this;t.empty()}};var rt=class extends m.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Task Manager Settings"}),t.createEl("h3",{text:"Scope"}),new m.Setting(t).setName("Target folders").setDesc('Comma-separated list of folder paths to process (e.g., "00 - Daily/, 01 - Projects/")').addText(e=>e.setPlaceholder("00 - Daily/").setValue(this.plugin.settings.targetFolders.join(", ")).onChange(async n=>{this.plugin.settings.targetFolders=n.split(",").map(a=>a.trim()).filter(a=>a),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Task IDs"}),new m.Setting(t).setName("Enable task IDs").setDesc("Automatically assign unique IDs to all tasks").addToggle(e=>e.setValue(this.plugin.settings.enableTaskIds).onChange(async n=>{this.plugin.settings.enableTaskIds=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("ID prefix").setDesc("Prefix for generated task IDs").addText(e=>e.setPlaceholder("t-").setValue(this.plugin.settings.idPrefix).onChange(async n=>{this.plugin.settings.idPrefix=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("ID length").setDesc("Number of random characters in task IDs").addText(e=>e.setPlaceholder("8").setValue(String(this.plugin.settings.idLength)).onChange(async n=>{let a=parseInt(n);!isNaN(a)&&a>0&&(this.plugin.settings.idLength=a,await this.plugin.saveSettings())})),t.createEl("h3",{text:"Parent-Child Linking"}),new m.Setting(t).setName("Enable parent-child linking").setDesc("Automatically link subtasks to their parent tasks").addToggle(e=>e.setValue(this.plugin.settings.enableParentChildLinking).onChange(async n=>{this.plugin.settings.enableParentChildLinking=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Preserve existing parent links").setDesc("Do not overwrite existing parent links when subtasks are moved").addToggle(e=>e.setValue(this.plugin.settings.preserveExistingParentLinks).onChange(async n=>{this.plugin.settings.preserveExistingParentLinks=n,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Sorting"}),new m.Setting(t).setName("Enable auto-sort").setDesc("Automatically sort tasks by time when file is modified").addToggle(e=>e.setValue(this.plugin.settings.enableAutoSort).onChange(async n=>{this.plugin.settings.enableAutoSort=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Sort debounce delay").setDesc("Milliseconds to wait after last edit before sorting").addText(e=>e.setPlaceholder("500").setValue(String(this.plugin.settings.sortDebounceMs)).onChange(async n=>{let a=parseInt(n);!isNaN(a)&&a>=0&&(this.plugin.settings.sortDebounceMs=a,await this.plugin.saveSettings())})),new m.Setting(t).setName("Tasks without time position").setDesc("Where to place tasks that do not have a timeblock").addDropdown(e=>e.addOption("end","End of list").addOption("start","Start of list").setValue(this.plugin.settings.tasksWithoutTimePosition).onChange(async n=>{this.plugin.settings.tasksWithoutTimePosition=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Auto-archive completed tasks").setDesc("Move completed, scheduled, and cancelled tasks to a collapsed section").addToggle(e=>e.setValue(this.plugin.settings.enableAutoArchive).onChange(async n=>{this.plugin.settings.enableAutoArchive=n,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Task Status Sync"}),new m.Setting(t).setName("Enable status sync").setDesc("Sync task status between task notes and daily notes bidirectionally").addToggle(e=>e.setValue(this.plugin.settings.enableTaskStatusSync).onChange(async n=>{this.plugin.settings.enableTaskStatusSync=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Status mappings").setDesc("Checkbox marker \u2192 status name mappings (JSON format)").addTextArea(e=>{e.inputEl.rows=8,e.inputEl.cols=40,e.setValue(JSON.stringify(this.plugin.settings.statusMappings,null,2)).onChange(async n=>{try{let a=JSON.parse(n);this.plugin.settings.statusMappings=a,await this.plugin.saveSettings()}catch(a){}})}),t.createEl("h3",{text:"Display"}),new m.Setting(t).setName("Show info button").setDesc("Display info button (i) on tasks to view metadata").addToggle(e=>e.setValue(this.plugin.settings.showInfoButton).onChange(async n=>{this.plugin.settings.showInfoButton=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Hide metadata fields").setDesc("Hide [id::...] and [parent::...] fields in the editor").addToggle(e=>e.setValue(this.plugin.settings.hideMetadataFields).onChange(async n=>{this.plugin.settings.hideMetadataFields=n,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Task Notes"}),new m.Setting(t).setName("Enable task notes").setDesc('Show "notes" button on parent tasks to create/open dedicated task notes').addToggle(e=>e.setValue(this.plugin.settings.enableTaskNotes).onChange(async n=>{this.plugin.settings.enableTaskNotes=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Task notes folder").setDesc("Folder where task notes will be created").addText(e=>e.setPlaceholder("Task Notes").setValue(this.plugin.settings.taskNotesFolder).onChange(async n=>{this.plugin.settings.taskNotesFolder=n.trim()||"Task Notes",await this.plugin.saveSettings()})),t.createEl("h3",{text:"Event Notes"}),new m.Setting(t).setName("Enable event notes").setDesc('Show "notes" button on calendar events to create/open dedicated event notes with eventUID in frontmatter').addToggle(e=>e.setValue(this.plugin.settings.enableEventNotes).onChange(async n=>{this.plugin.settings.enableEventNotes=n,await this.plugin.saveSettings()})),new m.Setting(t).setName("Event notes folder").setDesc("Folder where event notes will be created").addText(e=>e.setPlaceholder("Event Notes").setValue(this.plugin.settings.eventNotesFolder).onChange(async n=>{this.plugin.settings.eventNotesFolder=n.trim()||"Event Notes",await this.plugin.saveSettings()})),t.createEl("h3",{text:"Calendar Sync"}),new m.Setting(t).setName("Enable ICS calendar sync").setDesc("Automatically sync calendar events from ICS plugin when opening daily notes. Events use [c] checkbox and are read-only.").addToggle(e=>e.setValue(this.plugin.settings.enableIcsSync).onChange(async n=>{this.plugin.settings.enableIcsSync=n,await this.plugin.saveSettings()}))}},ct=class extends m.Plugin{async onload(){console.log("Task Manager: loaded"),await this.loadSettings();let t=this;this.isProcessing=!1;let e=ut.fromClass(class{constructor(i){this.decorations=this.buildDecorations(i,t)}update(i){(i.docChanged||i.viewportChanged)&&(this.decorations=this.buildDecorations(i.view,t))}buildDecorations(i,o){let c=[],u=g.TASK_PATTERN,d=g.PARENT_TASK_PATTERN,h=/\s*\[(?:id|parent|uid|calendar)::\s*[^\]]+\]/g,k=/^([\t]*- \[.\]\s*)(\d{2}:\d{2}\s*-\s*\d{2}:\d{2})/,w=/\s*\[>\s*(\d{4}-\d{2}-\d{2})\]/g,T=/\s*\[<\s*(\d{4}-\d{2}-\d{2})\]/g,p=/\s*\[sch_to::([^\]]+)\]/g,f=/\s*\[sch_from::([^\]]+)\]/g,b=o.app.workspace.getActiveFile(),v=b&&b.path.startsWith(o.settings.taskNotesFolder+"/");for(let{from:E,to:S}of i.visibleRanges)for(let N=E;N<S;){let y=i.state.doc.lineAt(N),x=y.text;if(u.test(x)){let lt=g.extractId(x),dt=g.extractParentId(x),gt=d.test(x),q=x.match(k);if(q){let I=y.from+q[1].length,P=I+q[2].length;c.push({from:I,to:P,value:A.mark({class:"timeblock-pill",attributes:{"data-line":String(y.number-1)}})})}let B=[],V=[];if(o.settings.hideMetadataFields){let I;for(h.lastIndex=0;(I=h.exec(x))!==null;){let P=y.from+I.index,bt=P+I[0].length;c.push({from:P,to:bt,value:A.replace({})})}}let K;for(w.lastIndex=0;(K=w.exec(x))!==null;){let I=y.from+K.index,P=I+K[0].length;B.push(K[1]),c.push({from:I,to:P,value:A.replace({})})}let U;for(T.lastIndex=0;(U=T.exec(x))!==null;){let I=y.from+U.index,P=I+U[0].length;V.push(U[1]),c.push({from:I,to:P,value:A.replace({})})}let z;for(p.lastIndex=0;(z=p.exec(x))!==null;){let I=y.from+z.index,P=I+z[0].length;B.push(z[1]),c.push({from:I,to:P,value:A.replace({})})}let W;for(f.lastIndex=0;(W=f.exec(x))!==null;){let I=y.from+W.index,P=I+W[0].length;V.push(W[1]),c.push({from:I,to:P,value:A.replace({})})}let R=g.isCalendarEvent(x),G=R?j.extractUid(x):null,ft=R?j.extractCalendar(x):null,_=R?Z.extractEventTitle(x):D.extractTaskTextFromLine(x),mt=R?Z.extractTimeRange(x):null,kt=o.settings.enableTaskNotes&&gt&&!v&&_&&_.trim()!=="",Tt=o.settings.enableEventNotes&&R&&G&&_&&_.trim()!=="",wt=kt||Tt,vt=o.settings.showInfoButton&&(lt||dt||G),Et=B.length>0||V.length>0;c.push({from:y.to,to:y.to,value:A.widget({widget:new at({taskText:_,taskId:lt,parentId:dt,uid:G,calendarSource:ft,isCalendarEvent:R,eventTimeRange:mt,scheduleToDates:B.length>0?B:null,scheduleFromDates:V.length>0?V:null,showInfoButton:vt,showNotesButton:wt,lineNum:y.number},o),side:1})})}N=y.to+1}c.sort((E,S)=>E.from-S.from||E.to-S.to);let C=new xt;for(let E of c)C.add(E.from,E.to,E.value);return C.finish()}},{decorations:i=>i.decorations});this.registerEditorExtension([e]),this.registerEditorSuggest(new et(this.app,this)),this.registerEditorSuggest(new st(this.app,this)),this.registerEditorSuggest(new tt(this.app,this)),this.taskNoteSyncing=!1,this.taskNoteSyncTimers=new Map,this.lastCursorLine=-1;let n=ut.fromClass(class{constructor(i){this.plugin=t,this.lastLine=-1}update(i){if(!i.selectionSet)return;let o=i.state.doc.lineAt(i.state.selection.main.head).number-1;if(this.lastLine!==-1&&this.lastLine!==o){let c=this.lastLine;setTimeout(()=>this.plugin.processLineOnLeave(c),0)}this.lastLine=o}});this.registerEditorExtension([n]),this.registerDomEvent(document,"click",i=>{let o=i.target;if(o.matches('input[data-task="c"], .task-list-item-checkbox[data-task="c"]')||o.closest('li[data-task="c"]')&&o.matches('input[type="checkbox"]'))return i.preventDefault(),i.stopPropagation(),!1},!0),this.registerDomEvent(document,"click",i=>{var k;if(i.metaKey||i.ctrlKey)return;let c=i.target.closest("a.internal-link, a.external-link, a.cm-underline");if(!c||!c.closest("li.task-list-item, li[data-task]"))return;i.preventDefault(),i.stopPropagation();let d=this.app.workspace.getActiveViewOfType(m.MarkdownView);if(!d||!d.editor)return;let h=d.leaf.getViewState();((k=h.state)==null?void 0:k.mode)==="preview"&&(h.state.mode="source",d.leaf.setViewState(h))},!0),this.registerDomEvent(document,"click",i=>{let c=i.target.closest(".timeblock-pill");if(!c)return;i.preventDefault(),i.stopPropagation();let u=parseInt(c.dataset.line,10);if(isNaN(u))return;let d=this.app.workspace.getActiveViewOfType(m.MarkdownView);if(!d||!d.editor)return;let h=d.editor;new M(this,h,u,"start").open()}),this.registerEvent(this.app.vault.on("modify",i=>{if(!this.isProcessing&&this.settings.enableTaskNotes&&i.path.startsWith(this.settings.taskNotesFolder+"/")){this.taskNoteSyncing||(this.taskNoteSyncTimers.has(i.path)&&clearTimeout(this.taskNoteSyncTimers.get(i.path)),this.taskNoteSyncTimers.set(i.path,setTimeout(async()=>{this.taskNoteSyncTimers.delete(i.path),this.taskNoteSyncing=!0;try{await D.syncSubtasksBackToSource(this.app,i,!1),await D.syncStatusToSource(this.app,i,this.settings)}finally{setTimeout(()=>{this.taskNoteSyncing=!1},100)}},500)));return}})),this.registerEvent(this.app.workspace.on("file-open",async i=>{if(!(!i||!this.settings.enableIcsSync||this.isProcessing||!j.getDailyNoteDate(i,this.settings))){this.isProcessing=!0;try{await j.syncEventsToNote(this.app,i,this.settings)&&console.log("Task Manager: Synced ICS events to",i.path)}catch(c){console.error("Task Manager: Error syncing ICS events",c)}finally{setTimeout(()=>{this.isProcessing=!1},100)}}})),this.addCommand({id:"assign-task-ids",name:"Assign IDs to all tasks in current file",editorCallback:(i,o)=>{let c=i.getValue(),u=Y.processContent(c,this.settings);c!==u&&i.setValue(u)}}),this.addCommand({id:"link-parent-child",name:"Link subtasks to parent tasks in current file",editorCallback:(i,o)=>{let c=i.getValue();c=Y.processContent(c,this.settings);let u=ht.linkContent(c,this.settings);i.getValue()!==u&&i.setValue(u)}}),this.addCommand({id:"unlink-from-parent",name:"Unlink task from parent",editorCallback:(i,o)=>{let c=i.getCursor(),u=i.getLine(c.line);if(g.extractParentId(u)){let d=g.removeParentId(u);i.setLine(c.line,d),new m.Notice("Task unlinked from parent")}else new m.Notice("This task has no parent link")}}),this.addCommand({id:"sort-tasks",name:"Sort tasks chronologically in current file",editorCallback:(i,o)=>{let c=i.getValue(),u=J.sortContent(c,this.settings);c!==u&&i.setValue(u)}}),this.addCommand({id:"sort-by-time-block",name:"Sort all items by time block",editorCallback:(i,o)=>{let c=i.getValue(),u=J.sortByTimeBlock(c,this.settings);c!==u&&i.setValue(u)}}),this.addCommand({id:"show-task-info",name:"Show task info for current line",editorCallback:(i,o)=>{let c=i.getCursor(),u=i.getLine(c.line),d=g.extractId(u),h=g.extractParentId(u),k=D.extractTaskTextFromLine(u);d||h?this.showTaskInfo(d,h,k,i,c.line):new m.Notice("No task metadata on this line")}}),this.addCommand({id:"mark-task-complete",name:"Mark task complete",editorCheckCallback:(i,o,c)=>{let u=o.getCursor(),d=o.getLine(u.line);if(!g.isTask(d))return!1;if(i)return!0;let h=d.replace(/^([\t]*- \[)[^\]](\])/,"$1x$2");o.setLine(u.line,h)}}),this.addCommand({id:"mark-task-in-progress",name:"Mark task in progress",editorCheckCallback:(i,o,c)=>{let u=o.getCursor(),d=o.getLine(u.line);if(!g.isTask(d))return!1;if(i)return!0;let h=d.replace(/^([\t]*- \[)[^\]](\])/,"$1/$2");o.setLine(u.line,h)}}),this.addCommand({id:"mark-task-cancelled",name:"Mark task cancelled",editorCheckCallback:(i,o,c)=>{let u=o.getCursor(),d=o.getLine(u.line);if(!g.isTask(d))return!1;if(i)return!0;let h=d.replace(/^([\t]*- \[)[^\]](\])/,"$1-$2");o.setLine(u.line,h)}}),this.addCommand({id:"set-status-complete",name:"Set task status: Complete",callback:async()=>{let i=this.app.workspace.getActiveFile();if(!(i!=null&&i.path.startsWith(this.settings.taskNotesFolder+"/"))){new m.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(i,"complete")}}),this.addCommand({id:"set-status-incomplete",name:"Set task status: Incomplete",callback:async()=>{let i=this.app.workspace.getActiveFile();if(!(i!=null&&i.path.startsWith(this.settings.taskNotesFolder+"/"))){new m.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(i,"incomplete")}}),this.addCommand({id:"set-status-in-progress",name:"Set task status: In Progress",callback:async()=>{let i=this.app.workspace.getActiveFile();if(!(i!=null&&i.path.startsWith(this.settings.taskNotesFolder+"/"))){new m.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(i,"in-progress")}}),this.addCommand({id:"set-status-cancelled",name:"Set task status: Cancelled",callback:async()=>{let i=this.app.workspace.getActiveFile();if(!(i!=null&&i.path.startsWith(this.settings.taskNotesFolder+"/"))){new m.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(i,"cancelled")}}),this.addCommand({id:"schedule-task",name:"Schedule task",editorCheckCallback:(i,o,c)=>{let u=o.getCursor(),d=o.getLine(u.line);if(!g.isTask(d))return!1;if(i)return!0;new O(this,o,u.line).open()}}),this.addCommand({id:"unschedule-task",name:"Unschedule task",editorCheckCallback:(i,o,c)=>{let u=o.getCursor(),d=o.getLine(u.line);if(!g.isTask(d))return!1;let h=/^[\t]*- \[>\]/.test(d),k=/\[>\s*\d{4}-\d{2}-\d{2}\]/.test(d);if(!h&&!k)return!1;if(i)return!0;L.unscheduleTask(this.app,this.settings,o,u.line)}}),this.addCommand({id:"set-time-block",name:"Set time block",editorCheckCallback:(i,o,c)=>{let u=o.getCursor(),d=o.getLine(u.line);if(!g.isTask(d))return!1;if(i)return!0;new M(this,o,u.line,"start").open()}}),this.addCommand({id:"schedule-overdue-to-today",name:"Schedule all overdue tasks to today",callback:async()=>{let i=new Date;i.setHours(0,0,0,0),await X.scheduleAllOverdueTo(this.app,this.settings,i)}}),this.addCommand({id:"schedule-overdue-to-this-note",name:"Schedule all overdue tasks to this note's date",checkCallback:i=>{let o=this.app.workspace.getActiveFile();if(!o||!g.shouldProcessFile(o,this.settings))return!1;let c=X.parseDateFromFilename(o.basename);if(!c)return!1;if(i)return!0;X.scheduleAllOverdueTo(this.app,this.settings,c)}}),this.addCommand({id:"archive-completed-tasks",name:"Archive completed/scheduled tasks now",editorCallback:async(i,o)=>{let c=o.file;if(!c||!g.shouldProcessFile(c,this.settings)){new m.Notice("This command only works in target folders");return}let u=i.getValue(),d=pt.archiveContent(u,this.settings);d!==u?(i.setValue(d),new m.Notice("Tasks archived")):new m.Notice("No tasks to archive")}}),this.addSettingTab(new rt(this.app,this));let a=this.manifest.version;this.addStatusBarItem().setText(`Task Manager: v${a} | main`)}onunload(){if(console.log("Task Manager: unloaded"),this.taskNoteSyncTimers){for(let t of this.taskNoteSyncTimers.values())clearTimeout(t);this.taskNoteSyncTimers.clear()}}async loadSettings(){this.settings=Object.assign({},yt,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async processFile(t){this.isProcessing=!0;try{let e=this.app.workspace.getActiveViewOfType(m.MarkdownView),n=this.app.workspace.getActiveFile(),a=e&&n&&n.path===t.path,r,l;a?(l=e.editor,r=l.getValue()):r=await this.app.vault.read(t);let i=!1;if(this.settings.enableTaskIds){let o=Y.processContent(r,this.settings);o!==r&&(r=o,i=!0)}if(this.settings.enableParentChildLinking){let o=ht.linkContent(r,this.settings);o!==r&&(r=o,i=!0)}if(this.settings.enableAutoSort){let o=J.sortContent(r,this.settings);o!==r&&(r=o,i=!0)}if(this.settings.enableAutoArchive&&!a){let o=pt.archiveContent(r,this.settings);o!==r&&(r=o,i=!0)}if(i)if(a&&l){let o=l.getCursor(),c=l.getValue().split(`
`),u=r.split(`
`);for(let d=0;d<u.length;d++)if(d<c.length&&c[d]!==u[d])if(d===o.line){let h=c[d],k=u[d];if(k.length>h.length&&k.startsWith(h.trimEnd())){let w=k.slice(h.trimEnd().length);l.replaceRange(w,{line:d,ch:h.length})}}else l.setLine(d,u[d])}else await this.app.vault.modify(t,r);this.settings.enableTaskStatusSync&&!this.taskNoteSyncing&&await D.syncAllStatusesToTaskNotes(this.app,t,this.settings)}finally{setTimeout(()=>{this.isProcessing=!1},100)}}async updateTaskNoteStatus(t,e){let n=await this.app.vault.read(t);if(D.extractFrontmatterField(n,"status")===e){new m.Notice(`Status already set to ${e}`);return}let r=D.updateFrontmatterField(n,"status",e);r=this.updateButtonHighlighting(r,e),r!==n&&(await this.app.vault.modify(t,r),new m.Notice(`Status changed to ${e}`))}updateButtonHighlighting(t,e){let a={incomplete:"btn-incomplete","in-progress":"btn-progress",cancelled:"btn-cancelled",complete:"btn-complete"}[e];if(!a)return t;let r=/(```meta-bind-button\n(?:> )?label: "[^"]+"\n(?:> )?style: )(primary|default)(\n(?:> )?id: (btn-[a-z-]+))/g;return t.replace(r,(l,i,o,c,u)=>i+(u===a?"primary":"default")+c)}processLineOnLeave(t){let e=this.app.workspace.getActiveViewOfType(m.MarkdownView);if(!e)return;let n=this.app.workspace.getActiveFile();if(!n||!g.shouldProcessFile(n,this.settings))return;let a=e.editor,r=a.getLine(t);if(!r||!g.isTask(r)||g.isCalendarEvent(r))return;let l=r,i=!1;if(this.settings.enableTaskIds&&!g.extractId(r)&&(l=g.addId(l,g.generateId(this.settings)),i=!0),this.settings.enableParentChildLinking&&g.isSubtask(r)){let c=null;for(let u=t-1;u>=0;u--){let d=a.getLine(u);if(g.isParentTask(d)){c=g.extractId(d);break}}c&&!g.extractParentId(l)&&(l=g.addParentId(l,c),i=!0)}let o=g.normalizeMetadataOrder(l);o!==l&&(l=o,i=!0),i&&(this.isProcessing=!0,a.setLine(t,l),setTimeout(()=>{this.isProcessing=!1},50))}showTaskInfo(t,e,n,a,r,l,i,o){let c=null;if(e&&this.app.workspace.getActiveFile()){let h=this.app.workspace.getActiveViewOfType(m.MarkdownView);if(h&&h.editor){let w=h.editor.getValue().split(`
`);for(let T of w)if(g.extractId(T)===e){c=D.extractTaskTextFromLine(T);break}}}new ot(this.app,t,e,n,c,()=>{if(a&&r!==void 0){let d=a.getLine(r),h=g.removeParentId(d);a.setLine(r,h),new m.Notice("Task unlinked from parent")}},l,i,o).open()}showSchedulePopupFromWidget(t,e){let n=this.app.workspace.getActiveViewOfType(m.MarkdownView);if(!n||!n.editor)return;let a=n.editor;new nt(this,a,e,t).open()}showTimeblockPickerFromWidget(t,e){let n=this.app.workspace.getActiveViewOfType(m.MarkdownView);if(!n||!n.editor)return;let a=n.editor;new it(this,a,e,"start",null,null,t).open()}};module.exports=ct;
