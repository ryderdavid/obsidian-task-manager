"use strict";var f=require("obsidian"),{EditorView:St,Decoration:A,ViewPlugin:ct,WidgetType:Tt}=require("@codemirror/view"),{RangeSetBuilder:wt}=require("@codemirror/state"),vt={targetFolders:["00 - Daily/"],enableTaskIds:!0,idPrefix:"t-",idLength:8,enableParentChildLinking:!0,preserveExistingParentLinks:!0,enableAutoSort:!1,sortDebounceMs:500,tasksWithoutTimePosition:"end",showInfoButton:!0,hideMetadataFields:!0,enableTaskNotes:!0,taskNotesFolder:"Task Notes",enableEventNotes:!0,eventNotesFolder:"Event Notes",enableIcsSync:!0,enableAutoArchive:!0,enableTaskStatusSync:!0,statusMappings:{" ":"incomplete",x:"complete",X:"complete","/":"in-progress","-":"cancelled",">":"scheduled"}},p={TASK_PATTERN:/^[\t]*- \[.\]/,PARENT_TASK_PATTERN:/^- \[.\]/,SUBTASK_PATTERN:/^\t+- \[.\]/,ID_PATTERN:/\[id::([^\]]+)\]/,PARENT_ID_PATTERN:/\[parent::([^\]]+)\]/,METADATA_PATTERN:/\s*\[(?:id|parent|uid)::[^\]]+\]/g,COMPLETED_PATTERN:/^[\t]*- \[[xX]\]/,TIMEBLOCK_PATTERN:/^- \[.\]\s*(\d{2}):(\d{2}) - (\d{2}):(\d{2})/,CALENDAR_EVENT_PATTERN:/^[\t]*- \[c\]/,extractId(n){let t=n.match(this.ID_PATTERN);return t?t[1].trim():null},extractParentId(n){let t=n.match(this.PARENT_ID_PATTERN);return t?t[1].trim():null},generateId(n){let t="abcdefghijklmnopqrstuvwxyz0123456789",e=n.idPrefix;for(let i=0;i<n.idLength;i++)e+=t.charAt(Math.floor(Math.random()*t.length));return e},addId(n,t){return this.extractId(n)?n:n.trimEnd()+` [id::${t}]`},addParentId(n,t){let e=this.extractParentId(n);return e?e!==t?n.replace(this.PARENT_ID_PATTERN,`[parent::${t}]`):n:n.trimEnd()+` [parent::${t}]`},normalizeMetadataOrder(n){if(!this.isTask(n))return n;let t=n.match(/^([\t]*- \[.\]\s*)/);if(!t)return n;let e=t[1],i=n.slice(e.length),s=i.match(/\[id::([^\]]+)\]/),a=i.match(/\[parent::([^\]]+)\]/),o=i.match(/\[uid::([^\]]+)\]/),l=i.match(/\[>\s*(\d{4}-\d{2}-\d{2})\]/),r=i.match(/\[<\s*(\d{4}-\d{2}-\d{2})\]/);i=i.replace(/\s*\[id::[^\]]+\]/g,"").replace(/\s*\[parent::[^\]]+\]/g,"").replace(/\s*\[uid::[^\]]+\]/g,"").replace(/\s*\[>\s*\d{4}-\d{2}-\d{2}\]/g,"").replace(/\s*\[<\s*\d{4}-\d{2}-\d{2}\]/g,"").trimEnd();let c=[e+i];return s&&c.push(`[id::${s[1]}]`),a&&c.push(`[parent::${a[1]}]`),o&&c.push(`[uid::${o[1]}]`),r&&c.push(`[< ${r[1]}]`),l&&c.push(`[> ${l[1]}]`),c.join(" ")},removeParentId(n){return n.replace(/\s*\[parent::[^\]]+\]/,"")},isTask(n){return this.TASK_PATTERN.test(n)},isCalendarEvent(n){return this.CALENDAR_EVENT_PATTERN.test(n)},isParentTask(n){return this.PARENT_TASK_PATTERN.test(n)},isSubtask(n){return this.SUBTASK_PATTERN.test(n)},isCompleted(n){return this.COMPLETED_PATTERN.test(n)},getTaskSortKey(n){let t=n.match(this.TIMEBLOCK_PATTERN);if(t){let e=parseInt(t[1])*60+parseInt(t[2]),i=parseInt(t[3])*60+parseInt(t[4]);return{hasTime:!0,start:e,end:i}}return{hasTime:!1,start:1/0,end:1/0}},shouldProcessFile(n,t){return n.extension!=="md"?!1:t.targetFolders.some(e=>n.path.includes(e))}},W={UID_PATTERN:/\[uid::([^\]]+)\]/,CALENDAR_PATTERN:/\[calendar::([^\]]+)\]/,extractUid(n){let t=n.match(this.UID_PATTERN);return t?t[1].trim():null},extractCalendar(n){let t=n.match(this.CALENDAR_PATTERN);return t?t[1].trim():null},parseEventLine(n){let t=n.match(/^- \[c\]\s*(\d{2}):(\d{2})\s*-\s*(\d{2}):(\d{2})\s+(.+?)(?:\s*\[uid::[^\]]+\])?\s*$/);return t?{startHour:parseInt(t[1]),startMinute:parseInt(t[2]),endHour:parseInt(t[3]),endMinute:parseInt(t[4]),text:t[5].trim(),uid:this.extractUid(n)}:null},formatTime(n,t){return`${n.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},buildEventLine(n,t){let e=n.time||"00:00",i=n.endTime||e,s=n.summary||"Untitled Event";n.location&&(s+=` ${n.location}`),n.callUrl&&(s+=` ${n.callUrl}`);let a=n.uid||`fallback-${n.utime}`,o=n.icsName||"",l=`- [c] ${e} - ${i} ${s} [uid::${a}]`;return o&&(l+=` [calendar::${o}]`),l},getDailyNoteDate(n,t){if(!p.shouldProcessFile(n,t))return null;let e=n.basename.match(/^(\d{4})-(\d{2})-(\d{2})$/);return e?new Date(parseInt(e[1]),parseInt(e[2])-1,parseInt(e[3])):null},async getIcsEvents(n,t){try{let e=n.plugins.getPlugin("ics");if(!e||!e.getEvents)return null;let i=window.moment;return i?await e.getEvents(i(t)):null}catch(e){return console.error("Task Manager: Error fetching ICS events",e),null}},async syncEventsToNote(n,t,e){let i=this.getDailyNoteDate(t,e);if(!i)return!1;let s=await this.getIcsEvents(n,i);if(!s||s.length===0)return!1;let a=await n.vault.read(t),o=a.split(`
`),l=[],r=[];for(let k of o)p.isCalendarEvent(k)?l.push(k):r.push(k);let c=new Map;for(let k of l){let T=this.extractUid(k);T&&c.set(T,k)}let h=[];for(let k of s){let T=this.buildEventLine(k,e);h.push({line:T,utime:k.utime||0})}h.sort((k,T)=>k.utime-T.utime);let g=[...h.map(k=>k.line),...r].join(`
`);return g!==a?(await n.vault.modify(t,g),!0):!1}},G={processContent(n,t){let e=n.split(`
`),i=[];for(let s=0;s<e.length;s++){let a=e[s];if(p.isCalendarEvent(a)){i.push(a);continue}p.isTask(a)&&(p.extractId(a)||(a=p.addId(a,p.generateId(t)))),i.push(a)}return i.join(`
`)}},dt={linkContent(n,t){let e=n.split(`
`),i=[],s=null;for(let a=0;a<e.length;a++){let o=e[a],l=p.isParentTask(o),r=p.isSubtask(o);l?(s=p.extractId(o),p.extractParentId(o)&&(o=p.removeParentId(o)),i.push(o)):r?(!p.extractParentId(o)&&s&&(o=p.addParentId(o,s)),i.push(o)):(/^#/.test(o)&&(s=null),i.push(o))}return i.join(`
`)}},J={sortContent(n,t){let e=n.split(`
`),i=[],s=[],a=!1,o=[],l=[],r=[],c=!1;for(let d=0;d<e.length;d++){let m=e[d];if(/^##\s*Completed\s*$/i.test(m)){a=!0;continue}let b=p.isParentTask(m),S=p.isSubtask(m);if(a){if(b)s.push({id:p.extractId(m),parent:m,subtasks:[]});else if(S&&s.length>0){let N=p.extractParentId(m);if(N){let x=s.find(w=>w.id===N);x?x.subtasks.push(m):s[s.length-1].subtasks.push(m)}else s[s.length-1].subtasks.push(m)}else/^#/.test(m)&&(a=!1,r.push({line:m,index:d,isTaskArea:!1}));continue}b?(c||(c=!0),o.push({id:p.extractId(m),line:m,index:d})):S?l.push({parentId:p.extractParentId(m),line:m,index:d}):(c&&/^#/.test(m)&&(c=!1),r.push({line:m,index:d,isTaskArea:c}))}let h=[];for(let d of o){let m={parent:d.line,subtasks:[],sortKey:p.getTaskSortKey(d.line)};if(d.id)for(let S of l)S.parentId===d.id&&m.subtasks.push(S.line);let b=d.index;for(let S of l)if(!S.parentId){let N=!0;for(let w of o)if(w.index>b&&w.index<S.index){N=!1;break}let x=o.filter(w=>w.index<S.index).sort((w,y)=>y.index-w.index)[0];x&&x.index===b&&N&&(m.subtasks.includes(S.line)||m.subtasks.push(S.line))}h.push(m)}let u=h.filter(d=>!p.isCompleted(d.parent)),g=h.filter(d=>p.isCompleted(d.parent));u.sort((d,m)=>d.sortKey.hasTime&&!m.sortKey.hasTime?-1:!d.sortKey.hasTime&&m.sortKey.hasTime?1:d.sortKey.start!==m.sortKey.start?d.sortKey.start-m.sortKey.start:d.sortKey.end-m.sortKey.end),g.sort((d,m)=>d.sortKey.hasTime&&!m.sortKey.hasTime?-1:!d.sortKey.hasTime&&m.sortKey.hasTime?1:d.sortKey.start!==m.sortKey.start?d.sortKey.start-m.sortKey.start:d.sortKey.end-m.sortKey.end);let k=o.length>0?o[0].index:0,T=o.length>0?Math.max(...o.map(d=>d.index),...l.map(d=>d.index)):0;for(let d of r)d.index<k&&i.push(d.line);for(let d of u){i.push(d.parent);for(let m of d.subtasks)i.push(m)}for(let d of r)d.index>T&&i.push(d.line);let v=[...g,...s];if(v.length>0){for(;i.length>0&&i[i.length-1].trim()==="";)i.pop();i.push(""),i.push("## Completed"),v.sort((d,m)=>{let b=p.getTaskSortKey(d.parent),S=p.getTaskSortKey(m.parent);return b.hasTime&&!S.hasTime?-1:!b.hasTime&&S.hasTime?1:b.start!==S.start?b.start-S.start:b.end-S.end});for(let d of v){i.push(d.parent);for(let m of d.subtasks)i.push(m)}}return i.join(`
`)},sortByTimeBlock(n,t){let e=n.split(`
`),i=/^[\t]*- \[.\]\s*(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/,s=[],a=[],o=[],l=0;for(;l<e.length;){let c=e[l],h=p.isParentTask(c),u=p.isCalendarEvent(c);if(h||u){let g=c.match(i),k=[];if(h){let v=p.extractId(c),d=l+1;for(;d<e.length&&p.isSubtask(e[d]);){let m=p.extractParentId(e[d]);(!m||m===v)&&k.push(e[d]),d++}l=d}else l++;let T={line:c,subtasks:k,isEvent:u};g?(T.startMinutes=parseInt(g[1])*60+parseInt(g[2]),T.endMinutes=parseInt(g[3])*60+parseInt(g[4]),s.push(T)):a.push(T)}else p.isSubtask(c)||o.push({line:c,index:l}),l++}s.sort((c,h)=>c.startMinutes!==h.startMinutes?c.startMinutes-h.startMinutes:c.endMinutes-h.endMinutes);let r=[];for(let c of s){r.push(c.line);for(let h of c.subtasks)r.push(h)}a.length>0&&s.length>0&&r.push("");for(let c of a){r.push(c.line);for(let h of c.subtasks)r.push(h)}return r.join(`
`)}},ut={ARCHIVE_STATES:/^[\t]*- \[[xX>\-]\]/,ACTIVE_STATES:/^[\t]*- \[[ \/c]\]/,ARCHIVE_CALLOUT_START:/^> \[!archived\]-?\s*Archived\s*$/,ARCHIVE_LINE:/^> /,archiveContent(n,t){let e=n.split(`
`),i=[],s=[],a=[],o=[],l=!1,r=0;for(;r<e.length;){let u=e[r];if(this.ARCHIVE_CALLOUT_START.test(u)){l=!0,r++;continue}if(l)if(this.ARCHIVE_LINE.test(u)){o.push(u.substring(2)),r++;continue}else l=!1;if(p.CALENDAR_EVENT_PATTERN.test(u)){i.push(u),r++;continue}if(this.ARCHIVE_STATES.test(u)){let g=[u];for(r++;r<e.length&&p.SUBTASK_PATTERN.test(e[r]);)g.push(e[r]),r++;a.push(...g);continue}if(this.ACTIVE_STATES.test(u)){let g=[u];for(r++;r<e.length&&p.SUBTASK_PATTERN.test(e[r]);)g.push(e[r]),r++;s.push(...g);continue}(u.trim()!==""||s.length>0)&&s.push(u),r++}let c=[...a,...o],h=[];for(let u of i)h.push(u);for(let u of s)h.push(u);if(c.length>0){if(h.length>0){for(;h.length>0&&h[h.length-1]==="";)h.pop();for(let u=0;u<7;u++)h.push("")}h.push("> [!archived]- Archived");for(let u of c)h.push("> "+u)}return h.join(`
`)}},I={cleanTaskText(n){return n=n.replace(/\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/g,""),n=n.replace(/üìÖ\s*\[\[[^\]]+\]\]/g,""),n=n.replace(/üìÖ\s*\d{4}-\d{2}-\d{2}/g,""),n=n.replace(/#\w+/g,""),n=n.replace(/üîó\[\[[^\]]+\]\]/g,""),n=n.replace(/\[\[([^\]|]+)\|?([^\]]*)\]\]/g,(t,e,i)=>i||e),n=n.replace(/[üìÖüóìÔ∏è‚è≥üõ´‚úÖ‚ùå‚ûïüî∫‚è´üîºüîΩ‚è¨üÜî‚õîüîÅ][^\s]*/g,""),n=n.replace(/üìù/g,""),n=n.replace(/üîó/g,""),n=n.replace(/\s*\[[^\]]+::[^\]]*\]/g,""),n=n.replace(/\s*\[[<>]\s*\d{4}-\d{2}-\d{2}\]/g,""),n=n.replace(/\s+/g," ").trim(),n},sanitizeFilename(n){return n.replace(/[\\/:*?"<>|#\[\]]/g,"-").replace(/-+/g,"-").replace(/\s+/g," ").trim().substring(0,100)},extractTaskTextFromLine(n){let t=n.match(/^- \[.\]\s*(.+)$/);return t?this.cleanTaskText(t[1]):null},extractCheckboxMarker(n){let t=n.match(/^[\t]*- \[(.)\]/);return t?t[1]:null},checkboxToStatus(n,t){return t.statusMappings[n]||"incomplete"},statusToCheckbox(n,t){for(let[e,i]of Object.entries(t.statusMappings))if(i===n)return e;return" "},extractFrontmatterField(n,t){let e=n.match(/^---\n([\s\S]*?)\n---/);if(!e)return null;let s=e[1].match(new RegExp(`^${t}:\\s*"?([^"\\n]*)"?`,"m"));return s?s[1]:null},updateFrontmatterField(n,t,e){let i=n.match(/^(---\n)([\s\S]*?)(\n---)/);if(!i)return n;let[s,a,o,l]=i,r=new RegExp(`^(${t}:\\s*)"?[^"\\n]*"?`,"m"),c;return r.test(o)?c=o.replace(r,`$1"${e}"`):c=o+`
${t}: "${e}"`,n.replace(s,a+c+l)},updateTaskCheckbox(n,t,e){let i=n.split(`
`),s=new RegExp(`\\[id::\\s*${t}\\]`);for(let a=0;a<i.length;a++)if(s.test(i[a])){i[a]=i[a].replace(/^([\t]*- \[).(])/,`$1${e}$2`);break}return i.join(`
`)},async findTaskNoteByTaskId(n,t,e){let i=e.taskNotesFolder,s=n.vault.getFiles().filter(a=>a.path.startsWith(i+"/"));for(let a of s){let o=await n.vault.read(a);if(this.extractFrontmatterField(o,"taskId")===t)return a}return null},async syncStatusToSource(n,t,e){if(!e.enableTaskStatusSync)return;let i=await n.vault.read(t),s=this.extractFrontmatterField(i,"taskId"),a=this.extractFrontmatterField(i,"status"),o=this.extractFrontmatterField(i,"sourceFile");if(!s||!a||!o)return;let l=n.vault.getAbstractFileByPath(o);if(!l||!(l instanceof f.TFile))return;let r=this.statusToCheckbox(a,e),c=await n.vault.read(l),h=new RegExp(`\\[id::\\s*${s}\\]`),u=c.split(`
`);for(let k of u)if(h.test(k)){if(this.extractCheckboxMarker(k)===r)return;break}let g=this.updateTaskCheckbox(c,s,r);g!==c&&await n.vault.modify(l,g)},async syncStatusToTaskNote(n,t,e,i){if(!i.enableTaskStatusSync)return;let s=await this.findTaskNoteByTaskId(n,t,i);if(!s)return;let a=this.checkboxToStatus(e,i),o=await n.vault.read(s);if(this.extractFrontmatterField(o,"status")===a)return;let r=this.updateFrontmatterField(o,"status",a);r!==o&&await n.vault.modify(s,r)},async syncAllStatusesToTaskNotes(n,t,e){if(!e.enableTaskStatusSync)return;let s=(await n.vault.read(t)).split(`
`);for(let a of s){let o=p.extractId(a);if(!o||p.CALENDAR_EVENT_PATTERN.test(a))continue;let l=this.extractCheckboxMarker(a);l&&await this.syncStatusToTaskNote(n,o,l,e)}},async getSubtasksFromSource(n,t,e){if(!t)return[];let i=n.vault.getAbstractFileByPath(t);if(!i||!(i instanceof f.TFile))return[];let a=(await n.vault.read(i)).split(`
`),o=[],l=-1;for(let c=0;c<a.length;c++){let u=a[c].match(/^(\s*)- \[[ x]\]\s*(.+)$/);if(u&&this.cleanTaskText(u[2])===e){l=c;break}}if(l===-1)return[];let r=a[l].match(/^(\s*)/)[1].length;for(let c=l+1;c<a.length;c++){let h=a[c],u=h.match(/^(\s*)- \[([ x])\]\s*(.+)$/);if(!u){let k=h.match(/^(\s*)/);if(k&&k[1].length<=r&&h.trim()!=="")break;continue}if(u[1].length>r){let k=u[2]==="x",T=this.cleanTaskText(u[3]);T&&o.push({text:T,completed:k,originalLine:h})}else break}return o},async syncSubtasksToTaskNote(n,t,e,i){let s=await n.vault.read(t),a=s.match(/sourceFile:\s*"([^"]+)"/),o=a?a[1]:null,l=i&&o&&o!==i,r=s.match(/## Subtasks\n\n([\s\S]*?)(?=\n## |$)/);if(!r)return;let c=r[1],h=[],u=c.split(`
`);for(let v of u){let d=v.match(/^- \[([ x])\]\s*(.*)$/);d&&d[2].trim()&&h.push({text:d[2].trim(),completed:d[1]==="x"})}let g=[...h];for(let v of e)h.some(m=>m.text.toLowerCase()===v.text.toLowerCase())||g.push(v);let k=g.length>h.length,T=i&&(!o||l);if(k||T){let v=s;if(k){let d=g.map(m=>`- [${m.completed?"x":" "}] ${m.text}`).join(`
`);v=v.replace(/## Subtasks\n\n[\s\S]*?(?=\n## |$)/,`## Subtasks

${d}
`)}T&&(o?v=v.replace(/sourceFile:\s*"[^"]*"/,`sourceFile: "${i}"`):v=v.replace(/^---\n([\s\S]*?)---/,`---
$1sourceFile: "${i}"
---`)),await n.vault.modify(t,v),k&&new f.Notice(`Synced ${e.length} subtask(s) from source`)}},async syncSubtasksBackToSource(n,t,e){if(e)return!1;let i=await n.vault.read(t),s=i.match(/sourceFile:\s*"([^"]+)"/);if(!s||!s[1])return!1;let a=s[1],o=n.vault.getAbstractFileByPath(a);if(!o||!(o instanceof f.TFile))return!1;let l=i.match(/task:\s*"?([^"\n]+)"?/);if(!l)return!1;let r=l[1].replace(/\\"/g,'"'),c=i.match(/## Subtasks\n\n([\s\S]*?)(?=\n## |$)/);if(!c)return!1;let h=[],u=c[1].split(`
`);for(let w of u){let y=w.match(/^- \[([ x])\]\s*(.+)$/);y&&y[2].trim()&&h.push({text:y[2].trim(),completed:y[1]==="x"})}if(h.length===0)return!1;let g=await n.vault.read(o),k=g.split(`
`),T=-1,v=0;for(let w=0;w<k.length;w++){let E=k[w].match(/^(\s*)- \[[ x]\]\s*(.+)$/);if(E&&this.cleanTaskText(E[2])===r){T=w,v=E[1].length;break}}if(T===-1)return!1;let d=T;for(let w=T+1;w<k.length;w++){let y=k[w],E=y.match(/^(\s*)/),D=E?E[1].length:0;if(y.trim()!=="")if(D>v)d=w;else break}let m="	",b=h.map(w=>`${m}- [${w.completed?"x":" "}] ${w.text}`),S=k.slice(0,T+1),N=k.slice(d+1),x=[...S,...b,...N].join(`
`);return x!==g?(await n.vault.modify(o,x),!0):!1},async openOrCreateTaskNote(n,t,e,i,s=null){let a=this.sanitizeFilename(e);if(!a)return new f.Notice("Could not extract task name"),null;let o=t.taskNotesFolder,l=`${o}/${a}.md`;n.vault.getAbstractFileByPath(o)||await n.vault.createFolder(o);let c=await this.getSubtasksFromSource(n,i,e),h=" ";if(i&&s){let T=n.vault.getAbstractFileByPath(i);if(T instanceof f.TFile){let v=await n.vault.read(T),d=new RegExp(`\\[id::\\s*${s}\\]`),m=v.split(`
`);for(let b of m)if(d.test(b)){let S=this.extractCheckboxMarker(b);S&&(h=S);break}}}let u=this.checkboxToStatus(h,t),g=n.vault.getAbstractFileByPath(l),k=!g;if(g)g instanceof f.TFile&&await this.syncSubtasksToTaskNote(n,g,c,i);else{let T=c.length>0?c.map(m=>`- [${m.completed?"x":" "}] ${m.text}`).join(`
`):"- [ ] ",v=i?`[[${i.replace(/\.md$/,"")}]]`:"",d=`---
task: "${e.replace(/"/g,'\\"')}"
taskId: "${s||""}"
status: "${u}"
created: ${new Date().toISOString().split("T")[0]}
sourceFile: "${i||""}"
---

# ${e}

**Source:** ${v}

---

## Status
\`BUTTON[btn-incomplete, btn-progress, btn-cancelled, btn-complete]\`

## Notes


## Subtasks

${T}

## References


---
> [!meta]- Button Definitions
> \`\`\`meta-bind-button
> label: "\u25CB Incomplete"
> style: primary
> id: btn-incomplete
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-incomplete
> \`\`\`
>
> \`\`\`meta-bind-button
> label: "\u25D0 In Progress"
> style: default
> id: btn-progress
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-in-progress
> \`\`\`
>
> \`\`\`meta-bind-button
> label: "\u2715 Cancelled"
> style: default
> id: btn-cancelled
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-cancelled
> \`\`\`
>
> \`\`\`meta-bind-button
> label: "\u2713 Complete"
> style: default
> id: btn-complete
> hidden: true
> action:
>   type: command
>   command: task-manager:set-status-complete
> \`\`\`
`;g=await n.vault.create(l,d),new f.Notice(`Created: ${a}`)}return g instanceof f.TFile&&await n.workspace.getLeaf().openFile(g),g},async updateTaskNoteSourceFile(n,t,e,i,s){let a=this.sanitizeFilename(e);if(!a)return!1;let o=`${t.taskNotesFolder}/${a}.md`,l=n.vault.getAbstractFileByPath(o);if(!l||!(l instanceof f.TFile))return!1;let r=await n.vault.read(l),c=!1,h=/^(sourceFile:\s*")([^"]*)(")$/m,u=r.replace(h,`$1${i}$3`);u!==r&&(r=u,c=!0);let g=/^(scheduled:\s*)(\S+)$/m;if(g.test(r)){let d=r.replace(g,`$1${s}`);d!==r&&(r=d,c=!0)}else{let d=r.replace(/^(sourceFile:\s*"[^"]*")$/m,`$1
scheduled: ${s}`);d!==r?(r=d,c=!0):(r=r.replace(/^(---)$/m,`scheduled: ${s}
$1`),c=!0)}let k=`[[${i.replace(/\.md$/,"")}]]`,T=/^(\*\*Source:\*\*\s*)\[\[[^\]]+\]\]/m,v=r.replace(T,`$1${k}`);return v!==r&&(r=v,c=!0),c?(await n.vault.modify(l,r),!0):!1}},Z={sanitizeFilename(n){if(!n)return null;let t=n.replace(/^\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s*/,"");return t=t.replace(/https?:\/\/[^\s]+/g,""),t=t.replace(/[<>:"/\\|?*]/g,""),t=t.trim().substring(0,100),t||null},extractEventTitle(n){let t=n.replace(/^[\t]*- \[c\]\s*/,"");return t=t.replace(/^\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s*/,""),t=t.replace(/\s*\[uid::[^\]]+\]/g,""),t=t.replace(/\s*\[calendar::[^\]]+\]/g,""),t=t.replace(/\s*https?:\/\/[^\s]+/g,""),t.trim()},extractTimeRange(n){let t=n.match(/(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})/);return t?{start:t[1],end:t[2]}:null},async openOrCreateEventNote(n,t,e,i,s,a=null,o=null){var g;let l=this.sanitizeFilename(e);if(!l)return new f.Notice("Could not extract event name"),null;let r=t.eventNotesFolder,c=`${r}/${l}.md`;n.vault.getAbstractFileByPath(r)||await n.vault.createFolder(r);let u=n.vault.getAbstractFileByPath(c);if(!u){let k=s?`[[${s.replace(/\.md$/,"")}]]`:"",T=a?`${a.start} - ${a.end}`:"",v=s?(g=s.match(/(\d{4}-\d{2}-\d{2})/))==null?void 0:g[1]:new Date().toISOString().split("T")[0],d=`---
event: "${e.replace(/"/g,'\\"')}"
eventUID: "${i||""}"
calendar: "${o||""}"
date: ${v}
time: "${T}"
created: ${new Date().toISOString().split("T")[0]}
sourceFile: "${s||""}"
---

# ${e}

**Date:** ${v}${T?`  |  **Time:** ${T}`:""}
**Source:** ${k}

---

## Agenda


## Notes


## Action Items

- [ ]

## Follow-ups


`;u=await n.vault.create(c,d),new f.Notice(`Created: ${l}`)}return u instanceof f.TFile&&await n.workspace.getLeaf().openFile(u),u}},M={removeSchedulingTags(n){return n.replace(/\s*\[<\s*\d{4}-\d{2}-\d{2}\]/g,"").replace(/\s*\[>\s*\d{4}-\d{2}-\d{2}\]/g,"").replace(/\s*\[sch_from::[^\]]+\]/g,"").replace(/\s*\[sch_to::[^\]]+\]/g,"").replace(/\s*üìÖ\s*\[\[[^\]]+\]\]/g,"").replace(/\s*üìÖ\s*\d{4}-\d{2}-\d{2}/g,"")},getCurrentDate(){return new Date().toISOString().split("T")[0]},getDailyNotePath(n,t){return`${(t.targetFolders[0]||"00 - Daily/").replace(/\/$/,"")}/${n}.md`},createScheduledTaskCopy(n,t){let e=n.replace(/^([\t]*- \[)[^\]](\])/,"$1 $2");return e=this.removeSchedulingTags(e),e=e.replace(/\s*\[parent::\s*[^\]]+\]/g,""),e=e.trimEnd()+` [< ${t}]`,e},markTaskAsScheduled(n,t){let e=n.replace(/^([\t]*- \[)[^\]](\])/,"$1>$2");return e=e.replace(/^([\t]*- \[.\]\s*)\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/,"$1"),e=this.removeSchedulingTags(e),e=e.trimEnd()+` [> ${t}]`,e},async scheduleTask(n,t,e,i,s){let a=e.getLine(i);if(!p.isTask(a))return new f.Notice("Not a task line"),!1;if(a.includes(`[> ${s}]`))return new f.Notice("Task already scheduled to this date"),!1;let o=n.workspace.getActiveFile(),l=o?o.basename:this.getCurrentDate(),r=this.getDailyNotePath(s,t),c=n.vault.getAbstractFileByPath(r);if(!c){let d=r.substring(0,r.lastIndexOf("/"));n.vault.getAbstractFileByPath(d)||await n.vault.createFolder(d),c=await n.vault.create(r,""),new f.Notice(`Created daily note: ${s}`)}if(!(c instanceof f.TFile))return new f.Notice("Target is not a file"),!1;let h=p.extractId(a),u=await n.vault.read(c),g=!1;if(h&&(g=new RegExp(`\\[id::\\s*${h}\\]`).test(u)),g){let d=u.split(`
`),m=new RegExp(`\\[id::\\s*${h}\\]`);for(let b=0;b<d.length;b++)if(m.test(d[b])){let S=d[b];S=S.replace(/^([\t]*- \[)[^\]](\])/,"$1 $2"),S=this.removeSchedulingTags(S),S=S.trimEnd()+` [< ${l}]`,d[b]=S;break}u=d.join(`
`)}else{let d=this.createScheduledTaskCopy(a,l);u=u.trimEnd()+`
`+d}await n.vault.modify(c,u);let k=this.markTaskAsScheduled(a,s);e.setLine(i,k);let T=e.lineCount();for(let d=i+1;d<T;d++){let m=e.getLine(d);if(p.isSubtask(m)){let b=m.replace(/^([\t]*- \[)[^\]](\])/,"$1>$2");b!==m&&e.setLine(d,b)}else break}let v=I.extractTaskTextFromLine(a);return v&&await I.updateTaskNoteSourceFile(n,t,v,r,s),new f.Notice(`Task scheduled to ${s}`),!0}},X={INCOMPLETE_TASK_PATTERN:/^[\t]*- \[ \]/,isIncompleteTask(n){return this.INCOMPLETE_TASK_PATTERN.test(n)},parseDateFromFilename(n){let t=n.match(/^(\d{4})-(\d{2})-(\d{2})$/);return t?new Date(parseInt(t[1]),parseInt(t[2])-1,parseInt(t[3])):null},async getDailyNoteFiles(n,t){let e=[],i=t.targetFolders||["00 - Daily/"];for(let s of i){let a=s.replace(/\/$/,"");if(!n.vault.getAbstractFileByPath(a))continue;let l=n.vault.getMarkdownFiles();for(let r of l)if(r.path.startsWith(a+"/")&&r.path.endsWith(".md")){let c=this.parseDateFromFilename(r.basename);c&&e.push({file:r,date:c,basename:r.basename})}}return e},async findOverdueTasks(n,t,e){let i=await this.getDailyNoteFiles(n,t),s=[],a=e.getTime();for(let{file:o,date:l,basename:r}of i){if(l.getTime()>=a)continue;let h=(await n.vault.read(o)).split(`
`);for(let u=0;u<h.length;u++){let g=h[u];this.isIncompleteTask(g)&&!p.isCalendarEvent(g)&&s.push({file:o,fileDate:r,line:g,lineNum:u,taskId:p.extractId(g)})}}return s},async scheduleAllOverdueTo(n,t,e){let i=e.toISOString().split("T")[0],s=await this.findOverdueTasks(n,t,e);if(s.length===0)return new f.Notice("No overdue tasks found"),0;let a=0,o=new Map;for(let h of s)o.has(h.file.path)||o.set(h.file.path,[]),o.get(h.file.path).push(h);let l=M.getDailyNotePath(i,t),r=n.vault.getAbstractFileByPath(l);if(!r){let h=l.substring(0,l.lastIndexOf("/"));n.vault.getAbstractFileByPath(h)||await n.vault.createFolder(h),r=await n.vault.create(l,"")}if(!(r instanceof f.TFile))return new f.Notice("Could not access target daily note"),0;let c=await n.vault.read(r);for(let[h,u]of o){let g=n.vault.getAbstractFileByPath(h);if(!g||!(g instanceof f.TFile))continue;let k=await n.vault.read(g),T=k.split(`
`),v=g.basename,d=u.sort((m,b)=>b.lineNum-m.lineNum);for(let m of d){let b=T[m.lineNum];if(!b||!this.isIncompleteTask(b))continue;let S=p.extractId(b),N=!1;if(S&&(N=new RegExp(`\\[id::\\s*${S}\\]`).test(c)),N){let w=new RegExp(`\\[id::\\s*${S}\\]`),y=c.split(`
`);for(let E=0;E<y.length;E++)if(w.test(y[E])){let D=y[E];D=D.replace(/^([\t]*- \[)[^\]](\])/,"$1 $2"),D=M.removeSchedulingTags(D),D=D.trimEnd()+` [< ${v}]`,y[E]=D;break}c=y.join(`
`)}else{let w=M.createScheduledTaskCopy(b,v);c=c.trimEnd()+`
`+w}T[m.lineNum]=M.markTaskAsScheduled(b,i),a++;let x=I.extractTaskTextFromLine(b);x&&await I.updateTaskNoteSourceFile(n,t,x,l,i)}k=T.join(`
`),await n.vault.modify(g,k)}return await n.vault.modify(r,c),new f.Notice(`Scheduled ${a} overdue task(s) to ${i}`),a}},_={formatDate(n){return n.toISOString().split("T")[0]},getTomorrow(){let n=new Date;return n.setDate(n.getDate()+1),this.formatDate(n)},getDayAfterTomorrow(){let n=new Date;return n.setDate(n.getDate()+2),this.formatDate(n)},getNextMonday(){let n=new Date,t=n.getDay(),e=t===0?1:t===1?7:8-t;return n.setDate(n.getDate()+e),this.formatDate(n)},getOneWeekFromNow(){let n=new Date;return n.setDate(n.getDate()+7),this.formatDate(n)},parseCustomDate(n){if(!n)return null;let t=n.trim();return/^\d{4}-\d{2}-\d{2}$/.test(t)?t:/^\d{8}$/.test(t)?`${t.slice(0,4)}-${t.slice(4,6)}-${t.slice(6,8)}`:null}},Q=[{id:"tomorrow",label:"Tomorrow",getDate:()=>_.getTomorrow()},{id:"day-after",label:"Day After Tomorrow",getDate:()=>_.getDayAfterTomorrow()},{id:"next-monday",label:"Next Monday",getDate:()=>_.getNextMonday()},{id:"one-week",label:"In One Week",getDate:()=>_.getOneWeekFromNow()},{id:"custom",label:"Enter a date...",isCustom:!0}],L={check:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>',halfCircle:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M448 256c0-106-86-192-192-192V448c106 0 192-86 192-192zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z"/></svg>',ban:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M367.2 412.5L99.5 144.8C77.1 176.1 64 214.5 64 256c0 106 86 192 192 192c41.5 0 79.9-13.1 111.2-35.5zm45.3-45.3C434.9 335.9 448 297.5 448 256c0-106-86-192-192-192c-41.5 0-79.9 13.1-111.2 35.5L412.5 367.2zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z"/></svg>',anglesRight:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M470.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 256 265.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160zm-352 160l160-160c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L210.7 256 73.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0z"/></svg>',fileLines:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM112 256H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16z"/></svg>',clock:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M464 256A208 208 0 1 1 48 256a208 208 0 1 1 416 0zM0 256a256 256 0 1 0 512 0A256 256 0 1 0 0 256zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/></svg>'},F={extractTimeblock(n){let t=n.match(/^([\t]*- \[.\]\s*)(\d{2}):(\d{2})\s*-\s*(\d{2}):(\d{2})\s*/);return t?{prefix:t[1],startHour:parseInt(t[2]),startMinute:parseInt(t[3]),endHour:parseInt(t[4]),endMinute:parseInt(t[5]),fullMatch:t[0]}:null},formatTime(n,t){return`${n.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},formatDisplayTime(n){let t=e=>e.toString().padStart(2,"0");return n===0?"12 AM":n===12?"12 PM":n<12?`${t(n)} AM`:`${t(n-12)} PM`},addTimeblock(n,t,e,i,s){let a=this.extractTimeblock(n),o=`${this.formatTime(t,e)} - ${this.formatTime(i,s)} `;return a?n.replace(a.fullMatch,a.prefix+o):n.replace(/^([\t]*- \[.\]\s*)/,`$1${o}`)},removeTimeblock(n){return n.replace(/^([\t]*- \[.\]\s*)\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\s*/,"$1")},getDefaultEndTime(n,t){let e=t+30,i=n;return e>=60&&(e-=60,i=(i+1)%24),{hour:i,minute:e}}},R=class n{constructor(t,e,i,s,a=null,o=null){this.plugin=t,this.editor=e,this.lineNum=i,this.mode=s,this.existingStart=a,this.onComplete=o,this.selectedHour=null,this.expandedHour=null,this.container=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleClickOutside=this.handleClickOutside.bind(this)}open(){this.container=document.createElement("div"),this.container.className="timeblock-picker-popup",this.render(),this.positionPopup(),document.body.appendChild(this.container),document.addEventListener("keydown",this.handleKeyDown,!0),setTimeout(()=>{document.addEventListener("click",this.handleClickOutside)},10)}close(){this.container&&(this.container.remove(),this.container=null),document.removeEventListener("keydown",this.handleKeyDown,!0),document.removeEventListener("click",this.handleClickOutside)}render(){this.container.empty();let t=document.createElement("div");if(t.className="timeblock-picker-header",t.textContent=this.mode==="start"?"Start":"End",this.container.appendChild(t),this.mode==="end"&&this.existingStart){let a=document.createElement("div");a.className="timeblock-picker-start-info",a.textContent=`Start: ${F.formatTime(this.existingStart.hour,this.existingStart.minute)}`,this.container.appendChild(a)}let e=document.createElement("div");e.className="timeblock-picker-columns";let i=this.createColumn("DAY",6,17);e.appendChild(i);let s=this.createColumn("NIGHT",18,29);e.appendChild(s),this.container.appendChild(e)}createColumn(t,e,i){let s=document.createElement("div");s.className="timeblock-picker-column";let a=document.createElement("div");a.className="timeblock-picker-column-header",a.textContent=t,s.appendChild(a);for(let o=e;o<=i;o++){let l=o%24,r=this.createHourRow(l);s.appendChild(r)}return s}createHourRow(t){let e=document.createElement("div");e.className="timeblock-picker-row",this.expandedHour===t&&e.addClass("is-expanded");let s=null;if(this.mode==="end"&&this.existingStart){let l=F.getDefaultEndTime(this.existingStart.hour,this.existingStart.minute);t===l.hour&&(e.addClass("is-suggested"),s=l.minute)}let a=document.createElement("div");a.className="timeblock-picker-hour",a.textContent=F.formatDisplayTime(t),a.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.handleHourClick(t)}),e.appendChild(a);let o=document.createElement("div");o.className="timeblock-picker-row-minutes";for(let l of[0,15,30,45]){let r=document.createElement("button");r.className="timeblock-picker-minute-btn",s===l&&r.addClass("is-suggested"),r.textContent=l.toString().padStart(2,"0"),r.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),this.selectTime(t,l)}),o.appendChild(r)}return e.appendChild(o),e}handleHourClick(t){if(this.expandedHour===t){this.selectTime(t,0);return}this.expandedHour=t,this.render()}selectTime(t,e){this.selectedHour=t,this.close(),this.mode==="start"?new n(this.plugin,this.editor,this.lineNum,"end",{hour:t,minute:e},(s,a)=>{this.applyTimeblock(t,e,s,a)}).open():this.mode==="end"&&this.onComplete&&this.onComplete(t,e)}applyTimeblock(t,e,i,s){let a=this.editor.getLine(this.lineNum),o=F.addTimeblock(a,t,e,i,s);this.editor.setLine(this.lineNum,o),new f.Notice(`Timeblock set: ${F.formatTime(t,e)} - ${F.formatTime(i,s)}`)}positionPopup(){let t=this.plugin.app.workspace.getActiveViewOfType(f.MarkdownView);if(!t)return;let e=t.editor.cm;if(!e)return;let i=this.editor.getCursor(),s=e.coordsAtPos(e.state.doc.line(i.line+1).from);s&&(this.container.style.position="absolute",this.container.style.left=`${s.left}px`,this.container.style.top=`${s.bottom+5}px`,this.container.style.zIndex="1000")}handleKeyDown(t){t.key==="Escape"&&(t.preventDefault(),t.stopPropagation(),this.close())}handleClickOutside(t){this.container&&!this.container.contains(t.target)&&this.close()}},tt=class extends f.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,i){let s=e.getLine(t.line);if(!p.isTask(s))return null;let a=s.substring(0,t.ch),o=a.lastIndexOf("^");if(o===-1||o===0||a.substring(0,o).endsWith("^"))return null;let r={line:t.line,ch:o},c=t;e.replaceRange("",r,c);let h=F.extractTimeblock(s);return new R(this.plugin,e,t.line,"start").open(),null}getSuggestions(t){return[]}renderSuggestion(t,e){}selectSuggestion(t,e){}},bt=[{id:"complete",label:"Mark Complete",icon:L.check,marker:"x"},{id:"in-progress",label:"Mark In Progress",icon:L.halfCircle,marker:"/"},{id:"cancelled",label:"Mark Cancelled",icon:L.ban,marker:"-"},{id:"schedule",label:"Schedule Task",icon:L.anglesRight,action:"schedule"},{id:"timeblock",label:"Set Time Block",icon:L.clock,action:"timeblock"}],et=class extends f.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,i){let s=e.getLine(t.line);if(!p.isTask(s))return null;let a=s.substring(0,t.ch),o=a.lastIndexOf("/");if(o===-1)return null;let l=a.substring(0,o);return/\d$/.test(l)?null:{start:{line:t.line,ch:o},end:t,query:a.substring(o+1).toLowerCase()}}getSuggestions(t){let e=t.query.toLowerCase();return bt.filter(i=>i.label.toLowerCase().includes(e)||i.id.includes(e))}renderSuggestion(t,e){e.addClass("slash-command-item");let i=e.createSpan({cls:"slash-command-icon"});i.innerHTML=t.icon,e.createSpan({text:t.label,cls:"slash-command-label"})}selectSuggestion(t,e){let{editor:i}=this.context,s=this.context.start.line,a=i.getLine(s);i.replaceRange("",this.context.start,this.context.end);let o=i.getLine(s);if(t.marker){let l=o.replace(/^([\t]*- \[)[^\]](\])/,`$1${t.marker}$2`);i.setLine(s,l)}else t.action==="schedule"?this.openSchedulePopup(i,s):t.action==="timeblock"&&this.openTimeBlockPopup(i,s)}openSchedulePopup(t,e){new K(this.plugin,t,e).open()}openTimeBlockPopup(t,e){new R(this.plugin,t,e,"start").open()}},st=class extends f.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,i){let s=e.getLine(t.line);if(!p.isTask(s))return null;let a=s.substring(0,t.ch),o=a.lastIndexOf(">");if(o===-1||o===0)return null;let l=a.substring(0,o);if(l.endsWith(">")||l.endsWith("["))return null;let r={line:t.line,ch:o},c=t;return e.replaceRange("",r,c),new K(this.plugin,e,t.line).open(),null}getSuggestions(t){return[]}renderSuggestion(t,e){}selectSuggestion(t,e){}},K=class{constructor(t,e,i){this.plugin=t,this.editor=e,this.lineNum=i,this.selectedIndex=0,this.isCustomMode=!1,this.container=null,this.customInput=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleClickOutside=this.handleClickOutside.bind(this)}open(){this.container=document.createElement("div"),this.container.className="schedule-date-popup",this.renderOptions(),this.positionPopup(),document.body.appendChild(this.container),document.addEventListener("keydown",this.handleKeyDown,!0),setTimeout(()=>{document.addEventListener("click",this.handleClickOutside)},10)}close(){this.container&&(this.container.remove(),this.container=null),document.removeEventListener("keydown",this.handleKeyDown,!0),document.removeEventListener("click",this.handleClickOutside)}renderOptions(){this.container.empty(),Q.forEach((t,e)=>{let i=document.createElement("div");i.className="schedule-date-option",e===this.selectedIndex&&i.addClass("is-selected"),t.isCustom&&this.isCustomMode?(this.customInput=document.createElement("input"),this.customInput.type="text",this.customInput.className="schedule-date-custom-input",this.customInput.placeholder="YYYY-MM-DD",this.customInput.addEventListener("keydown",s=>{s.key==="Enter"?(s.preventDefault(),s.stopPropagation(),this.submitCustomDate()):s.key==="Escape"&&(s.preventDefault(),s.stopPropagation(),this.close())}),i.appendChild(this.customInput),setTimeout(()=>this.customInput.focus(),0)):(i.createSpan({text:t.label,cls:"schedule-date-label"}),t.getDate&&i.createSpan({text:t.getDate(),cls:"schedule-date-value"})),i.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.selectedIndex=e,this.selectOption(t)}),this.container.appendChild(i)})}positionPopup(){let t=this.plugin.app.workspace.getActiveViewOfType(f.MarkdownView);if(!t)return;let e=t.editor.cm;if(!e)return;let i=this.editor.getCursor(),s=e.coordsAtPos(e.state.doc.line(i.line+1).from);s&&(this.container.style.position="absolute",this.container.style.left=`${s.left}px`,this.container.style.top=`${s.bottom+5}px`,this.container.style.zIndex="1000")}handleKeyDown(t){if(this.isCustomMode&&this.customInput&&document.activeElement===this.customInput){t.key==="Escape"&&(t.preventDefault(),t.stopPropagation(),this.close());return}switch(t.key){case"ArrowDown":t.preventDefault(),t.stopPropagation(),this.selectedIndex=Math.min(this.selectedIndex+1,Q.length-1),this.renderOptions();break;case"ArrowUp":t.preventDefault(),t.stopPropagation(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.renderOptions();break;case"Enter":t.preventDefault(),t.stopPropagation(),this.selectOption(Q[this.selectedIndex]);break;case"Escape":t.preventDefault(),t.stopPropagation(),this.close();break}}handleClickOutside(t){this.container&&!this.container.contains(t.target)&&this.close()}selectOption(t){t.isCustom?this.isCustomMode||(this.isCustomMode=!0,this.renderOptions()):t.getDate&&this.scheduleToDate(t.getDate())}submitCustomDate(){if(!this.customInput)return;let t=_.parseCustomDate(this.customInput.value);t?this.scheduleToDate(t):new f.Notice("Invalid date format. Use YYYY-MM-DD or YYYYMMDD")}async scheduleToDate(t){this.close(),await M.scheduleTask(this.plugin.app,this.plugin.settings,this.editor,this.lineNum,t)}},nt=class extends Tt{constructor(t,e){super(),this.options=t,this.plugin=e}toDOM(){let t=document.createElement("span");if(t.className="task-decorations-container",this.options.showNotesButton&&this.options.taskText){let e=document.createElement("span");e.className="task-note-button";let i=document.createElement("span");i.className="task-note-button-icon",i.innerHTML=L.fileLines,e.appendChild(i),e.appendChild(document.createTextNode("notes")),e.setAttribute("aria-label",this.options.isCalendarEvent?"Open event note":"Open task note"),e.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation();let a=this.plugin.app.workspace.getActiveFile(),o=a?a.path:null;this.options.isCalendarEvent?await Z.openOrCreateEventNote(this.plugin.app,this.plugin.settings,this.options.taskText,this.options.uid,o,this.options.eventTimeRange,this.options.calendarSource):await I.openOrCreateTaskNote(this.plugin.app,this.plugin.settings,this.options.taskText,o,this.options.taskId)}),t.appendChild(e)}if(this.options.scheduleToDates)for(let e of this.options.scheduleToDates){let i=document.createElement("span");i.className="schedule-pill schedule-pill-to",i.textContent=`\u2192 ${e}`,i.setAttribute("aria-label",`Go to ${e}`),i.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation(),await this.navigateToDate(e)}),t.appendChild(i)}if(this.options.scheduleFromDates)for(let e of this.options.scheduleFromDates){let i=document.createElement("span");i.className="schedule-pill schedule-pill-from",i.textContent=`\u2190 ${e}`,i.setAttribute("aria-label",`Go to ${e}`),i.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation(),await this.navigateToDate(e)}),t.appendChild(i)}if(this.options.showInfoButton&&(this.options.taskId||this.options.parentId||this.options.uid)){let e=document.createElement("span");e.className="task-info-button",e.textContent="\u24D8",e.title=this.options.isCalendarEvent?"Event info":"Task info",e.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.plugin.showTaskInfo(this.options.taskId,this.options.parentId,this.options.taskText,null,null,this.options.uid,this.options.isCalendarEvent,this.options.calendarSource)}),t.appendChild(e)}return t}async navigateToDate(t){let e=M.getDailyNotePath(t,this.plugin.settings),i=this.plugin.app.vault.getAbstractFileByPath(e);i||(i=await this.plugin.app.vault.create(e,"")),i instanceof f.TFile&&await this.plugin.app.workspace.getLeaf().openFile(i)}eq(t){return t.options.taskText===this.options.taskText&&t.options.taskId===this.options.taskId&&t.options.parentId===this.options.parentId&&t.options.uid===this.options.uid&&t.options.calendarSource===this.options.calendarSource&&t.options.isCalendarEvent===this.options.isCalendarEvent&&JSON.stringify(t.options.eventTimeRange)===JSON.stringify(this.options.eventTimeRange)&&JSON.stringify(t.options.scheduleToDates)===JSON.stringify(this.options.scheduleToDates)&&JSON.stringify(t.options.scheduleFromDates)===JSON.stringify(this.options.scheduleFromDates)&&t.options.showInfoButton===this.options.showInfoButton&&t.options.showNotesButton===this.options.showNotesButton}ignoreEvent(){return!1}};var it=class extends f.Modal{constructor(t,e,i,s,a,o,l,r,c){super(t),this.taskId=e,this.parentId=i,this.taskText=s,this.parentText=a,this.onUnlink=o,this.uid=l,this.isCalendarEvent=r,this.calendarSource=c}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("task-info-modal"),t.createEl("h3",{text:this.isCalendarEvent?"Event Information":"Task Information"});let e=t.createDiv({cls:"task-info-content"});if(this.isCalendarEvent&&this.uid){if(this.taskText){let a=e.createDiv({cls:"task-info-row"});a.createSpan({text:"Event: ",cls:"task-info-label"}),a.createSpan({text:this.taskText,cls:"task-info-value task-info-name"})}if(this.calendarSource){let a=e.createDiv({cls:"task-info-row"});a.createSpan({text:"Calendar: ",cls:"task-info-label"}),a.createSpan({text:this.calendarSource,cls:"task-info-value task-info-name"})}let i=e.createDiv({cls:"task-info-row"});i.createSpan({text:"Event UID: ",cls:"task-info-label"}),i.createSpan({text:this.uid,cls:"task-info-value"}),e.createDiv({cls:"task-info-row"}).createSpan({text:"Calendar events sync from ICS and are read-only",cls:"task-info-note"})}else if(this.taskId){if(this.taskText){let s=e.createDiv({cls:"task-info-row"});s.createSpan({text:"Task: ",cls:"task-info-label"}),s.createSpan({text:this.taskText,cls:"task-info-value task-info-name"})}let i=e.createDiv({cls:"task-info-row"});i.createSpan({text:"Task ID: ",cls:"task-info-label"}),i.createSpan({text:this.taskId,cls:"task-info-value"})}if(this.parentId){if(this.parentText){let a=e.createDiv({cls:"task-info-row"});a.createSpan({text:"Parent: ",cls:"task-info-label"}),a.createSpan({text:this.parentText,cls:"task-info-value task-info-name"})}let i=e.createDiv({cls:"task-info-row"});i.createSpan({text:"Parent ID: ",cls:"task-info-label"}),i.createSpan({text:this.parentId,cls:"task-info-value"}),t.createEl("button",{text:"Unlink from Parent",cls:"task-unlink-btn"}).addEventListener("click",()=>{this.onUnlink(),this.close()})}else this.taskId&&e.createDiv({cls:"task-info-row"}).createSpan({text:"This is a parent task (no parent link)",cls:"task-info-note"})}onClose(){let{contentEl:t}=this;t.empty()}};var at=class extends f.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Task Manager Settings"}),t.createEl("h3",{text:"Scope"}),new f.Setting(t).setName("Target folders").setDesc('Comma-separated list of folder paths to process (e.g., "00 - Daily/, 01 - Projects/")').addText(e=>e.setPlaceholder("00 - Daily/").setValue(this.plugin.settings.targetFolders.join(", ")).onChange(async i=>{this.plugin.settings.targetFolders=i.split(",").map(s=>s.trim()).filter(s=>s),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Task IDs"}),new f.Setting(t).setName("Enable task IDs").setDesc("Automatically assign unique IDs to all tasks").addToggle(e=>e.setValue(this.plugin.settings.enableTaskIds).onChange(async i=>{this.plugin.settings.enableTaskIds=i,await this.plugin.saveSettings()})),new f.Setting(t).setName("ID prefix").setDesc("Prefix for generated task IDs").addText(e=>e.setPlaceholder("t-").setValue(this.plugin.settings.idPrefix).onChange(async i=>{this.plugin.settings.idPrefix=i,await this.plugin.saveSettings()})),new f.Setting(t).setName("ID length").setDesc("Number of random characters in task IDs").addText(e=>e.setPlaceholder("8").setValue(String(this.plugin.settings.idLength)).onChange(async i=>{let s=parseInt(i);!isNaN(s)&&s>0&&(this.plugin.settings.idLength=s,await this.plugin.saveSettings())})),t.createEl("h3",{text:"Parent-Child Linking"}),new f.Setting(t).setName("Enable parent-child linking").setDesc("Automatically link subtasks to their parent tasks").addToggle(e=>e.setValue(this.plugin.settings.enableParentChildLinking).onChange(async i=>{this.plugin.settings.enableParentChildLinking=i,await this.plugin.saveSettings()})),new f.Setting(t).setName("Preserve existing parent links").setDesc("Do not overwrite existing parent links when subtasks are moved").addToggle(e=>e.setValue(this.plugin.settings.preserveExistingParentLinks).onChange(async i=>{this.plugin.settings.preserveExistingParentLinks=i,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Sorting"}),new f.Setting(t).setName("Enable auto-sort").setDesc("Automatically sort tasks by time when file is modified").addToggle(e=>e.setValue(this.plugin.settings.enableAutoSort).onChange(async i=>{this.plugin.settings.enableAutoSort=i,await this.plugin.saveSettings()})),new f.Setting(t).setName("Sort debounce delay").setDesc("Milliseconds to wait after last edit before sorting").addText(e=>e.setPlaceholder("500").setValue(String(this.plugin.settings.sortDebounceMs)).onChange(async i=>{let s=parseInt(i);!isNaN(s)&&s>=0&&(this.plugin.settings.sortDebounceMs=s,await this.plugin.saveSettings())})),new f.Setting(t).setName("Tasks without time position").setDesc("Where to place tasks that do not have a timeblock").addDropdown(e=>e.addOption("end","End of list").addOption("start","Start of list").setValue(this.plugin.settings.tasksWithoutTimePosition).onChange(async i=>{this.plugin.settings.tasksWithoutTimePosition=i,await this.plugin.saveSettings()})),new f.Setting(t).setName("Auto-archive completed tasks").setDesc("Move completed, scheduled, and cancelled tasks to a collapsed section").addToggle(e=>e.setValue(this.plugin.settings.enableAutoArchive).onChange(async i=>{this.plugin.settings.enableAutoArchive=i,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Task Status Sync"}),new f.Setting(t).setName("Enable status sync").setDesc("Sync task status between task notes and daily notes bidirectionally").addToggle(e=>e.setValue(this.plugin.settings.enableTaskStatusSync).onChange(async i=>{this.plugin.settings.enableTaskStatusSync=i,await this.plugin.saveSettings()})),new f.Setting(t).setName("Status mappings").setDesc("Checkbox marker \u2192 status name mappings (JSON format)").addTextArea(e=>{e.inputEl.rows=8,e.inputEl.cols=40,e.setValue(JSON.stringify(this.plugin.settings.statusMappings,null,2)).onChange(async i=>{try{let s=JSON.parse(i);this.plugin.settings.statusMappings=s,await this.plugin.saveSettings()}catch(s){}})}),t.createEl("h3",{text:"Display"}),new f.Setting(t).setName("Show info button").setDesc("Display info button (i) on tasks to view metadata").addToggle(e=>e.setValue(this.plugin.settings.showInfoButton).onChange(async i=>{this.plugin.settings.showInfoButton=i,await this.plugin.saveSettings()})),new f.Setting(t).setName("Hide metadata fields").setDesc("Hide [id::...] and [parent::...] fields in the editor").addToggle(e=>e.setValue(this.plugin.settings.hideMetadataFields).onChange(async i=>{this.plugin.settings.hideMetadataFields=i,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Task Notes"}),new f.Setting(t).setName("Enable task notes").setDesc('Show "notes" button on parent tasks to create/open dedicated task notes').addToggle(e=>e.setValue(this.plugin.settings.enableTaskNotes).onChange(async i=>{this.plugin.settings.enableTaskNotes=i,await this.plugin.saveSettings()})),new f.Setting(t).setName("Task notes folder").setDesc("Folder where task notes will be created").addText(e=>e.setPlaceholder("Task Notes").setValue(this.plugin.settings.taskNotesFolder).onChange(async i=>{this.plugin.settings.taskNotesFolder=i.trim()||"Task Notes",await this.plugin.saveSettings()})),t.createEl("h3",{text:"Event Notes"}),new f.Setting(t).setName("Enable event notes").setDesc('Show "notes" button on calendar events to create/open dedicated event notes with eventUID in frontmatter').addToggle(e=>e.setValue(this.plugin.settings.enableEventNotes).onChange(async i=>{this.plugin.settings.enableEventNotes=i,await this.plugin.saveSettings()})),new f.Setting(t).setName("Event notes folder").setDesc("Folder where event notes will be created").addText(e=>e.setPlaceholder("Event Notes").setValue(this.plugin.settings.eventNotesFolder).onChange(async i=>{this.plugin.settings.eventNotesFolder=i.trim()||"Event Notes",await this.plugin.saveSettings()})),t.createEl("h3",{text:"Calendar Sync"}),new f.Setting(t).setName("Enable ICS calendar sync").setDesc("Automatically sync calendar events from ICS plugin when opening daily notes. Events use [c] checkbox and are read-only.").addToggle(e=>e.setValue(this.plugin.settings.enableIcsSync).onChange(async i=>{this.plugin.settings.enableIcsSync=i,await this.plugin.saveSettings()}))}},ot=class extends f.Plugin{async onload(){console.log("Task Manager: loaded"),await this.loadSettings();let t=this;this.isProcessing=!1;let e=ct.fromClass(class{constructor(s){this.decorations=this.buildDecorations(s,t)}update(s){(s.docChanged||s.viewportChanged)&&(this.decorations=this.buildDecorations(s.view,t))}buildDecorations(s,a){let o=[],l=p.TASK_PATTERN,r=p.PARENT_TASK_PATTERN,c=/\s*\[(?:id|parent|uid|calendar)::\s*[^\]]+\]/g,h=/^([\t]*- \[.\]\s*)(\d{2}:\d{2}\s*-\s*\d{2}:\d{2})/,u=/\s*\[>\s*(\d{4}-\d{2}-\d{2})\]/g,g=/\s*\[<\s*(\d{4}-\d{2}-\d{2})\]/g,k=/\s*\[sch_to::([^\]]+)\]/g,T=/\s*\[sch_from::([^\]]+)\]/g,v=a.app.workspace.getActiveFile(),d=v&&v.path.startsWith(a.settings.taskNotesFolder+"/");for(let{from:b,to:S}of s.visibleRanges)for(let N=b;N<S;){let x=s.state.doc.lineAt(N),w=x.text;if(l.test(w)){let y=p.extractId(w),E=p.extractParentId(w),D=r.test(w),Y=w.match(h);if(Y){let C=x.from+Y[1].length,P=C+Y[2].length;o.push({from:C,to:P,value:A.mark({class:"timeblock-pill",attributes:{"data-line":String(x.number-1)}})})}let O=[],B=[];if(a.settings.hideMetadataFields){let C;for(c.lastIndex=0;(C=c.exec(w))!==null;){let P=x.from+C.index,kt=P+C[0].length;o.push({from:P,to:kt,value:A.replace({})})}}let H;for(u.lastIndex=0;(H=u.exec(w))!==null;){let C=x.from+H.index,P=C+H[0].length;O.push(H[1]),o.push({from:C,to:P,value:A.replace({})})}let U;for(g.lastIndex=0;(U=g.exec(w))!==null;){let C=x.from+U.index,P=C+U[0].length;B.push(U[1]),o.push({from:C,to:P,value:A.replace({})})}let z;for(k.lastIndex=0;(z=k.exec(w))!==null;){let C=x.from+z.index,P=C+z[0].length;O.push(z[1]),o.push({from:C,to:P,value:A.replace({})})}let j;for(T.lastIndex=0;(j=T.exec(w))!==null;){let C=x.from+j.index,P=C+j[0].length;B.push(j[1]),o.push({from:C,to:P,value:A.replace({})})}let $=p.isCalendarEvent(w),q=$?W.extractUid(w):null,ht=$?W.extractCalendar(w):null,V=$?Z.extractEventTitle(w):I.extractTaskTextFromLine(w),pt=$?Z.extractTimeRange(w):null,gt=a.settings.enableTaskNotes&&D&&!d&&V&&V.trim()!=="",ft=a.settings.enableEventNotes&&$&&q&&V&&V.trim()!=="",rt=gt||ft,lt=a.settings.showInfoButton&&(y||E||q),mt=O.length>0||B.length>0;(rt||lt||mt)&&o.push({from:x.to,to:x.to,value:A.widget({widget:new nt({taskText:V,taskId:y,parentId:E,uid:q,calendarSource:ht,isCalendarEvent:$,eventTimeRange:pt,scheduleToDates:O.length>0?O:null,scheduleFromDates:B.length>0?B:null,showInfoButton:lt,showNotesButton:rt},a),side:1})})}N=x.to+1}o.sort((b,S)=>b.from-S.from||b.to-S.to);let m=new wt;for(let b of o)m.add(b.from,b.to,b.value);return m.finish()}},{decorations:s=>s.decorations});this.registerEditorExtension([e]),this.registerEditorSuggest(new et(this.app,this)),this.registerEditorSuggest(new st(this.app,this)),this.registerEditorSuggest(new tt(this.app,this)),this.taskNoteSyncing=!1,this.taskNoteSyncTimers=new Map,this.lastCursorLine=-1;let i=ct.fromClass(class{constructor(s){this.plugin=t,this.lastLine=-1}update(s){if(!s.selectionSet)return;let a=s.state.doc.lineAt(s.state.selection.main.head).number-1;if(this.lastLine!==-1&&this.lastLine!==a){let o=this.lastLine;setTimeout(()=>this.plugin.processLineOnLeave(o),0)}this.lastLine=a}});this.registerEditorExtension([i]),this.registerDomEvent(document,"click",s=>{let a=s.target;if(a.matches('input[data-task="c"], .task-list-item-checkbox[data-task="c"]')||a.closest('li[data-task="c"]')&&a.matches('input[type="checkbox"]'))return s.preventDefault(),s.stopPropagation(),!1},!0),this.registerDomEvent(document,"click",s=>{let o=s.target.closest(".timeblock-pill");if(!o)return;s.preventDefault(),s.stopPropagation();let l=parseInt(o.dataset.line,10);if(isNaN(l))return;let r=this.app.workspace.getActiveViewOfType(f.MarkdownView);if(!r||!r.editor)return;let c=r.editor;new R(this,c,l,"start").open()}),this.registerEvent(this.app.vault.on("modify",s=>{if(!this.isProcessing&&this.settings.enableTaskNotes&&s.path.startsWith(this.settings.taskNotesFolder+"/")){this.taskNoteSyncing||(this.taskNoteSyncTimers.has(s.path)&&clearTimeout(this.taskNoteSyncTimers.get(s.path)),this.taskNoteSyncTimers.set(s.path,setTimeout(async()=>{this.taskNoteSyncTimers.delete(s.path),this.taskNoteSyncing=!0;try{await I.syncSubtasksBackToSource(this.app,s,!1),await I.syncStatusToSource(this.app,s,this.settings)}finally{setTimeout(()=>{this.taskNoteSyncing=!1},100)}},500)));return}})),this.registerEvent(this.app.workspace.on("file-open",async s=>{if(!(!s||!this.settings.enableIcsSync||this.isProcessing||!W.getDailyNoteDate(s,this.settings))){this.isProcessing=!0;try{await W.syncEventsToNote(this.app,s,this.settings)&&console.log("Task Manager: Synced ICS events to",s.path)}catch(o){console.error("Task Manager: Error syncing ICS events",o)}finally{setTimeout(()=>{this.isProcessing=!1},100)}}})),this.addCommand({id:"assign-task-ids",name:"Assign IDs to all tasks in current file",editorCallback:(s,a)=>{let o=s.getValue(),l=G.processContent(o,this.settings);o!==l&&s.setValue(l)}}),this.addCommand({id:"link-parent-child",name:"Link subtasks to parent tasks in current file",editorCallback:(s,a)=>{let o=s.getValue();o=G.processContent(o,this.settings);let l=dt.linkContent(o,this.settings);s.getValue()!==l&&s.setValue(l)}}),this.addCommand({id:"unlink-from-parent",name:"Unlink task from parent",editorCallback:(s,a)=>{let o=s.getCursor(),l=s.getLine(o.line);if(p.extractParentId(l)){let r=p.removeParentId(l);s.setLine(o.line,r),new f.Notice("Task unlinked from parent")}else new f.Notice("This task has no parent link")}}),this.addCommand({id:"sort-tasks",name:"Sort tasks chronologically in current file",editorCallback:(s,a)=>{let o=s.getValue(),l=J.sortContent(o,this.settings);o!==l&&s.setValue(l)}}),this.addCommand({id:"sort-by-time-block",name:"Sort all items by time block",editorCallback:(s,a)=>{let o=s.getValue(),l=J.sortByTimeBlock(o,this.settings);o!==l&&s.setValue(l)}}),this.addCommand({id:"show-task-info",name:"Show task info for current line",editorCallback:(s,a)=>{let o=s.getCursor(),l=s.getLine(o.line),r=p.extractId(l),c=p.extractParentId(l),h=I.extractTaskTextFromLine(l);r||c?this.showTaskInfo(r,c,h,s,o.line):new f.Notice("No task metadata on this line")}}),this.addCommand({id:"mark-task-complete",name:"Mark task complete",editorCheckCallback:(s,a,o)=>{let l=a.getCursor(),r=a.getLine(l.line);if(!p.isTask(r))return!1;if(s)return!0;let c=r.replace(/^([\t]*- \[)[^\]](\])/,"$1x$2");a.setLine(l.line,c)}}),this.addCommand({id:"mark-task-in-progress",name:"Mark task in progress",editorCheckCallback:(s,a,o)=>{let l=a.getCursor(),r=a.getLine(l.line);if(!p.isTask(r))return!1;if(s)return!0;let c=r.replace(/^([\t]*- \[)[^\]](\])/,"$1/$2");a.setLine(l.line,c)}}),this.addCommand({id:"mark-task-cancelled",name:"Mark task cancelled",editorCheckCallback:(s,a,o)=>{let l=a.getCursor(),r=a.getLine(l.line);if(!p.isTask(r))return!1;if(s)return!0;let c=r.replace(/^([\t]*- \[)[^\]](\])/,"$1-$2");a.setLine(l.line,c)}}),this.addCommand({id:"set-status-complete",name:"Set task status: Complete",callback:async()=>{let s=this.app.workspace.getActiveFile();if(!(s!=null&&s.path.startsWith(this.settings.taskNotesFolder+"/"))){new f.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(s,"complete")}}),this.addCommand({id:"set-status-incomplete",name:"Set task status: Incomplete",callback:async()=>{let s=this.app.workspace.getActiveFile();if(!(s!=null&&s.path.startsWith(this.settings.taskNotesFolder+"/"))){new f.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(s,"incomplete")}}),this.addCommand({id:"set-status-in-progress",name:"Set task status: In Progress",callback:async()=>{let s=this.app.workspace.getActiveFile();if(!(s!=null&&s.path.startsWith(this.settings.taskNotesFolder+"/"))){new f.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(s,"in-progress")}}),this.addCommand({id:"set-status-cancelled",name:"Set task status: Cancelled",callback:async()=>{let s=this.app.workspace.getActiveFile();if(!(s!=null&&s.path.startsWith(this.settings.taskNotesFolder+"/"))){new f.Notice("This command only works in task notes");return}await this.updateTaskNoteStatus(s,"cancelled")}}),this.addCommand({id:"schedule-task",name:"Schedule task",editorCheckCallback:(s,a,o)=>{let l=a.getCursor(),r=a.getLine(l.line);if(!p.isTask(r))return!1;if(s)return!0;new K(this,a,l.line).open()}}),this.addCommand({id:"set-time-block",name:"Set time block",editorCheckCallback:(s,a,o)=>{let l=a.getCursor(),r=a.getLine(l.line);if(!p.isTask(r))return!1;if(s)return!0;new R(this,a,l.line,"start").open()}}),this.addCommand({id:"schedule-overdue-to-today",name:"Schedule all overdue tasks to today",callback:async()=>{let s=new Date;s.setHours(0,0,0,0),await X.scheduleAllOverdueTo(this.app,this.settings,s)}}),this.addCommand({id:"schedule-overdue-to-this-note",name:"Schedule all overdue tasks to this note's date",checkCallback:s=>{let a=this.app.workspace.getActiveFile();if(!a||!p.shouldProcessFile(a,this.settings))return!1;let o=X.parseDateFromFilename(a.basename);if(!o)return!1;if(s)return!0;X.scheduleAllOverdueTo(this.app,this.settings,o)}}),this.addCommand({id:"archive-completed-tasks",name:"Archive completed/scheduled tasks now",editorCallback:async(s,a)=>{let o=a.file;if(!o||!p.shouldProcessFile(o,this.settings)){new f.Notice("This command only works in target folders");return}let l=s.getValue(),r=ut.archiveContent(l,this.settings);r!==l?(s.setValue(r),new f.Notice("Tasks archived")):new f.Notice("No tasks to archive")}}),this.addSettingTab(new at(this.app,this))}onunload(){if(console.log("Task Manager: unloaded"),this.taskNoteSyncTimers){for(let t of this.taskNoteSyncTimers.values())clearTimeout(t);this.taskNoteSyncTimers.clear()}}async loadSettings(){this.settings=Object.assign({},vt,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async processFile(t){this.isProcessing=!0;try{let e=this.app.workspace.getActiveViewOfType(f.MarkdownView),i=this.app.workspace.getActiveFile(),s=e&&i&&i.path===t.path,a,o;s?(o=e.editor,a=o.getValue()):a=await this.app.vault.read(t);let l=!1;if(this.settings.enableTaskIds){let r=G.processContent(a,this.settings);r!==a&&(a=r,l=!0)}if(this.settings.enableParentChildLinking){let r=dt.linkContent(a,this.settings);r!==a&&(a=r,l=!0)}if(this.settings.enableAutoSort){let r=J.sortContent(a,this.settings);r!==a&&(a=r,l=!0)}if(this.settings.enableAutoArchive&&!s){let r=ut.archiveContent(a,this.settings);r!==a&&(a=r,l=!0)}if(l)if(s&&o){let r=o.getCursor(),c=o.getValue().split(`
`),h=a.split(`
`);for(let u=0;u<h.length;u++)if(u<c.length&&c[u]!==h[u])if(u===r.line){let g=c[u],k=h[u];if(k.length>g.length&&k.startsWith(g.trimEnd())){let T=k.slice(g.trimEnd().length);o.replaceRange(T,{line:u,ch:g.length})}}else o.setLine(u,h[u])}else await this.app.vault.modify(t,a);this.settings.enableTaskStatusSync&&!this.taskNoteSyncing&&await I.syncAllStatusesToTaskNotes(this.app,t,this.settings)}finally{setTimeout(()=>{this.isProcessing=!1},100)}}async updateTaskNoteStatus(t,e){let i=await this.app.vault.read(t);if(I.extractFrontmatterField(i,"status")===e){new f.Notice(`Status already set to ${e}`);return}let a=I.updateFrontmatterField(i,"status",e);a=this.updateButtonHighlighting(a,e),a!==i&&(await this.app.vault.modify(t,a),new f.Notice(`Status changed to ${e}`))}updateButtonHighlighting(t,e){let s={incomplete:"btn-incomplete","in-progress":"btn-progress",cancelled:"btn-cancelled",complete:"btn-complete"}[e];if(!s)return t;let a=/(```meta-bind-button\n(?:> )?label: "[^"]+"\n(?:> )?style: )(primary|default)(\n(?:> )?id: (btn-[a-z-]+))/g;return t.replace(a,(o,l,r,c,h)=>l+(h===s?"primary":"default")+c)}processLineOnLeave(t){let e=this.app.workspace.getActiveViewOfType(f.MarkdownView);if(!e)return;let i=this.app.workspace.getActiveFile();if(!i||!p.shouldProcessFile(i,this.settings))return;let s=e.editor,a=s.getLine(t);if(!a||!p.isTask(a)||p.isCalendarEvent(a))return;let o=a,l=!1;if(this.settings.enableTaskIds&&!p.extractId(a)&&(o=p.addId(o,p.generateId(this.settings)),l=!0),this.settings.enableParentChildLinking&&p.isSubtask(a)){let c=null;for(let h=t-1;h>=0;h--){let u=s.getLine(h);if(p.isParentTask(u)){c=p.extractId(u);break}}c&&!p.extractParentId(o)&&(o=p.addParentId(o,c),l=!0)}let r=p.normalizeMetadataOrder(o);r!==o&&(o=r,l=!0),l&&(this.isProcessing=!0,s.setLine(t,o),setTimeout(()=>{this.isProcessing=!1},50))}showTaskInfo(t,e,i,s,a,o,l,r){let c=null;if(e&&this.app.workspace.getActiveFile()){let g=this.app.workspace.getActiveViewOfType(f.MarkdownView);if(g&&g.editor){let T=g.editor.getValue().split(`
`);for(let v of T)if(p.extractId(v)===e){c=I.extractTaskTextFromLine(v);break}}}new it(this.app,t,e,i,c,()=>{if(s&&a!==void 0){let u=s.getLine(a),g=p.removeParentId(u);s.setLine(a,g),new f.Notice("Task unlinked from parent")}},o,l,r).open()}};module.exports=ot;
